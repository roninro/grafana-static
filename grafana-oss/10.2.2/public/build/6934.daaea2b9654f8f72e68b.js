"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6934],{54522:(ie,K,s)=>{s.d(K,{a:()=>ge});var x=s(39953),j=s(41407),G=s(69171),w=s(97250),e=s(38637),N=s(99242),A=Object.defineProperty,F=Object.defineProperties,U=Object.getOwnPropertyDescriptors,D=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,M=(P,Q,$)=>Q in P?A(P,Q,{enumerable:!0,configurable:!0,writable:!0,value:$}):P[Q]=$,O=(P,Q)=>{for(var $ in Q||(Q={}))V.call(Q,$)&&M(P,$,Q[$]);if(D)for(var $ of D(Q))v.call(Q,$)&&M(P,$,Q[$]);return P},z=(P,Q)=>F(P,U(Q));const ge=({config:P,onChange:Q,className:$})=>{const ce=k=>{Q(z(O({},P),{jsonData:z(O({},P.jsonData),{keepCookies:k})}))},H=k=>{Q(z(O({},P),{jsonData:z(O({},P.jsonData),{timeout:parseInt(k.currentTarget.value,10)})}))},he={container:(0,j.css)({maxWidth:578})};return x.createElement(N._,{title:"Advanced HTTP settings",className:(0,j.cx)(he.container,$)},x.createElement(G._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:P.readOnly,grow:!0},x.createElement(w.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:P.jsonData.keepCookies,onChange:ce})),x.createElement(G._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:P.readOnly,grow:!0},x.createElement(e.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:P.jsonData.timeout,onChange:H})))}},25243:(ie,K,s)=>{s.d(K,{i:()=>w});var x=s(41407),j=s(39953),G=s(82803);const w=({hideLine:N=!1})=>{const A=(0,G.wW)(e);return N?j.createElement("hr",{className:A.dividerHideLine}):j.createElement("hr",{className:A.divider})},e=N=>({divider:(0,x.css)`
    margin: ${N.spacing(4,0)};
  `,dividerHideLine:(0,x.css)`
    border: none;
    margin: ${N.spacing(3,0)};
  `})},88132:(ie,K,s)=>{s.d(K,{n:()=>N});var x=s(39953),j=s(38793);const G=x.lazy(()=>Promise.all([s.e(1569),s.e(7142)]).then(s.bind(s,29681))),w=A=>x.createElement(x.Suspense,{fallback:null},x.createElement(G,{...A})),e=A=>{const F=(0,x.useRef)(null),{onRunQuery:U,onChange:D,...V}=A,v=O=>{F.current=O,D(O),U()},M=O=>{D(O)};return x.createElement(w,{onRunQuery:v,onBlur:M,onChange:D,...V})};class N extends x.PureComponent{constructor(F){super(F),this._isMounted=!1,this.onChangeQuery=(U,D)=>{const{query:V,onChange:v,onRunQuery:M}=this.props;if(v){const O={...V,expr:U};v(O),D&&M&&M()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(F){const{range:U,datasource:{languageProvider:D}}=this.props;(0,j.rf)(U,F.range)&&D.fetchLabels()}render(){const{ExtraFieldElement:F,query:U,datasource:D,history:V,onRunQuery:v}=this.props,M=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return x.createElement(x.Fragment,null,x.createElement("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"]},x.createElement("div",{className:"gf-form--grow flex-shrink-1 min-width-15"},x.createElement(e,{datasource:D,history:V??[],onChange:this.onChangeQuery,onRunQuery:v,initialValue:U.expr??"",placeholder:M}))),F)}}},38793:(ie,K,s)=>{s.d(K,{Hk:()=>U,U9:()=>N,_z:()=>D,aC:()=>V,iS:()=>A,rf:()=>G,tU:()=>F});function x(v){return j(v/1e3)}function j(v){return Math.floor(v/60)}function G(v,M){if(v&&M){const O=x(v.from.valueOf())===x(M.from.valueOf()),z=x(v.to.valueOf())===x(M.to.valueOf());return!(O&&z)}return!1}const w=/[*+?()|\\.\[\]{}^$]/g;function e(v){return v.replace(w,"\\$&")}function N(v){return v.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')}function A(v){return v.replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}function F(v){return N(e(v))}function U(v,M){return D(M)?F(v):N(v)}function D(v){return!!(v&&(v.includes("=~")||v.includes("!~")))}function V(v){const M=["b","kib","Kib","kb","KB","mib","Mib","mb","MB","gib","Gib","gb","GB","tib","Tib","tb","TB","pib","Pib","pb","PB","eib","Eib","eb","EB"],O=new RegExp(`^(?:-?\\d+(?:\\.\\d+)?)(?:${M.join("|")})$`);return!!v.match(O)}},46934:(ie,K,s)=>{s.r(K),s.d(K,{plugin:()=>Ia});var x=s(54721),j=s(36316),G=s(77014),w=s(86832),e=s(39953),N=s(72639);const A=['{job="default/prometheus"}'],F=["job","app","k8s_app"],U=5,D=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, keeps logs that contain the substring "metrics", and then parses and filters the logs further.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class V extends e.PureComponent{constructor(){super(...arguments),this.state={userExamples:[]},this.checkUserLabels=async()=>{const t=this.props.datasource?.languageProvider;if(t.started){const n=t.getLabelKeys()||[],r=F.find(l=>n.includes(l));if(r){const l=await t.getLabelValues(r),i=(0,w.shuffle)(l).slice(0,U).map(u=>`{${r}="${u}"}`);this.setState({userExamples:i})}}else this.scheduleUserLabelChecking()}}componentDidMount(){this.scheduleUserLabelChecking(),(0,N.ff)("grafana_loki_cheatsheet_opened",{})}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(t){const{onClickExample:n}=this.props,r=l=>{n(l),(0,N.ff)("grafana_loki_cheatsheet_example_clicked",{})};return e.createElement("button",{type:"button",className:"cheat-sheet-item__example",key:t,onClick:l=>r({refId:"A",expr:t})},e.createElement("code",null,t))}render(){const{userExamples:t}=this.state,n=t.length>0;return e.createElement("div",null,e.createElement("h2",null,"Loki Cheat Sheet"),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"See your logs"),e.createElement("div",{className:"cheat-sheet-item__label"},"Start by selecting a log stream from the Label browser, or alternatively you can write a stream selector into the query field."),n?e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here are some example streams from your logs:"),t.map(r=>this.renderExpression(r))):e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here is an example of a log stream:"),this.renderExpression(A[0]))),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Combine stream selectors"),this.renderExpression('{app="cassandra",namespace="prod"}'),e.createElement("div",{className:"cheat-sheet-item__label"},"Returns all log lines from streams that have both labels.")),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Filtering for search terms."),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),e.createElement("div",{className:"cheat-sheet-item__label"},e.createElement("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql"},"LogQL")," ","supports exact and regular expression filters.")),D.map(r=>e.createElement("div",{className:"cheat-sheet-item",key:r.expression},e.createElement("div",{className:"cheat-sheet-item__title"},r.title),this.renderExpression(r.expression),e.createElement("div",{className:"cheat-sheet-item__label"},r.label))))}}var v=s(96083),M=s(7763),O=s(10694),z=s(28888),ge=s(34397),P=s(27366),Q=s(13579),$=s(30623),ce=s(91386),H=s(32688),he=s(32840),k=s(4919),st=s(77938),lt=s(54081),X=s(83065),De=s(17912),g=s(41407),Z=s(82803),we=s(73075),Fe=s(84766),rt=s(1188),ot=s(68084),it=s(52184),ue=s(36495),fe=s(52499),ee=s(38637),$e=s(12223),ve=s(38793);const Ee=1e3,ye=1e4,ct=4,be="{}";function Y(a){const t=[];for(const n of a)if(n.selected&&n.values&&n.values.length>0){const r=n.values.filter(l=>l.selected).map(l=>l.name);r.length>1?t.push(`${n.name}=~"${r.map(ve.tU).join("|")}"`):r.length===1&&t.push(`${n.name}="${(0,ve.U9)(r[0])}"`)}return["{",t.join(","),"}"].join("")}function ut(a,t,n){return a.map(r=>{const l=t[r.name];if(l){let i;if(r.name===n&&r.values)i=r.values;else{const u=new Set(r.values?.filter(o=>o.selected).map(o=>o.name)||[]);i=l.map(o=>({name:o,selected:u.has(o)}))}return{...r,loading:!1,values:i,facets:i.length}}return{...r,loading:!1,hidden:!l,values:void 0,facets:0}})}const dt=a=>({wrapper:(0,g.css)`
    background-color: ${a.colors.background.secondary};
    width: 100%;
  `,wrapperPadding:(0,g.css)`
    padding: ${a.spacing(2)};
  `,list:(0,g.css)`
    margin-top: ${a.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:(0,g.css)`
    & + & {
      margin: ${a.spacing(2,0)};
    }

    position: relative;
  `,footerSectionStyles:(0,g.css)`
    padding: ${a.spacing(1)};
    background-color: ${a.colors.background.primary};
    position: sticky;
    bottom: -${a.spacing(3)}; /* offset the padding on modal */
    left: 0;
  `,selector:(0,g.css)`
    font-family: ${a.typography.fontFamilyMonospace};
    margin-bottom: ${a.spacing(1)};
    width: 100%;
  `,status:(0,g.css)`
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: opacity 100ms linear;
    opacity: 0;
    font-size: ${a.typography.bodySmall.fontSize};
    height: calc(${a.typography.bodySmall.fontSize} + 10px);
  `,statusShowing:(0,g.css)`
    opacity: 1;
  `,error:(0,g.css)`
    color: ${a.colors.error.main};
  `,valueList:(0,g.css)`
    margin-right: ${a.spacing(1)};
    resize: horizontal;
  `,valueListWrapper:(0,g.css)`
    border-left: 1px solid ${a.colors.border.medium};
    margin: ${a.spacing(1,0)};
    padding: ${a.spacing(1,0,1,1)};
  `,valueListArea:(0,g.css)`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${a.spacing(1)};
  `,valueTitle:(0,g.css)`
    margin-left: -${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
  `,validationStatus:(0,g.css)`
    padding: ${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `});class mt extends e.Component{constructor(){super(...arguments),this.state={labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""},this.onChangeSearch=t=>{this.setState({searchTerm:t.target.value})},this.onClickRunLogsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsButton"});const t=Y(this.state.labels);this.props.onChange(t)},this.onClickRunMetricsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsRateButton"});const n=`rate(${Y(this.state.labels)}[$__auto])`;this.props.onChange(n)},this.onClickClear=()=>{this.setState(t=>({labels:t.labels.map(r=>({...r,values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0})),searchTerm:"",status:"",error:"",validationStatus:""})),this.props.deleteLastUsedLabels()},this.onClickLabel=(t,n,r)=>{const l=this.state.labels.find(o=>o.name===t);if(!l)return;const i=!l.selected;let u={selected:i};if(l.values&&!i){const o=l.values.map(c=>({...c,selected:!1}));u={...u,facets:0,values:o}}this.setState({searchTerm:""}),this.updateLabelState(t,u,"",()=>this.doFacettingForLabel(t))},this.onClickValue=(t,n,r)=>{const l=this.state.labels.find(u=>u.name===t);if(!l||!l.values)return;this.setState({searchTerm:""});const i=l.values.map(u=>({...u,selected:u.name===n?!u.selected:u.selected}));this.updateLabelState(t,{values:i},"",()=>this.doFacetting(t))},this.onClickValidate=()=>{const t=Y(this.state.labels);this.validateSelector(t)},this.doFacetting=t=>{const n=Y(this.state.labels);if(n===be){const r=this.state.labels.map(l=>({...l,facets:0,values:void 0,hidden:!1}));this.setState({labels:r},()=>{this.state.labels.forEach(l=>l.selected&&this.fetchValues(l.name,n))})}else this.fetchSeries(n,t)}}updateLabelState(t,n,r="",l){this.setState(i=>{const u=i.labels.map(c=>c.name===t?{...c,...n}:c),o=r?"":i.error;return{labels:u,status:r,error:o,validationStatus:""}},l)}componentDidMount(){const{languageProvider:t,autoSelect:n=ct,lastUsedLabels:r}=this.props;if(t){const l=r;t.start().then(()=>{let i=t.getLabelKeys();if(i.length>Ee){const o=`Too many labels found (showing only ${Ee} of ${i.length})`;i=i.slice(0,Ee),this.setState({error:o})}const u=i.map((o,c,m)=>({name:o,selected:m.length<=n&&l.length===0||l.includes(o),loading:!1}));this.setState({labels:u},()=>{this.state.labels.forEach(o=>{o.selected&&this.fetchValues(o.name,be)})})})}}doFacettingForLabel(t){const n=this.state.labels.find(l=>l.name===t);if(!n)return;const r=this.state.labels.filter(l=>l.selected).map(l=>l.name);this.props.storeLastUsedLabels(r),n.selected?n.values||this.fetchValues(t,Y(this.state.labels)):this.doFacetting()}async fetchValues(t,n){const{languageProvider:r}=this.props;this.updateLabelState(t,{loading:!0},`Fetching values for ${t}`);try{let l=await r.getLabelValues(t);if(n!==Y(this.state.labels)){this.updateLabelState(t,{loading:!1},"");return}if(l.length>ye){const u=`Too many values for ${t} (showing only ${ye} of ${l.length})`;l=l.slice(0,ye),this.setState({error:u})}const i=l.map(u=>({name:u}));this.updateLabelState(t,{values:i,loading:!1})}catch(l){console.error(l)}}async fetchSeries(t,n){const{languageProvider:r}=this.props;n&&this.updateLabelState(n,{loading:!0},`Loading labels for ${t}`);try{const l=await r.fetchSeriesLabels(t,!0);if(t!==Y(this.state.labels)){n&&this.updateLabelState(n,{loading:!1});return}if(Object.keys(l).length===0){this.setState({error:`Empty results, no matching label for ${t}`});return}const i=ut(this.state.labels,l,n);this.setState({labels:i,error:""}),n&&this.updateLabelState(n,{loading:!1})}catch(l){console.error(l)}}async validateSelector(t){const{languageProvider:n}=this.props;this.setState({validationStatus:`Validating selector ${t}`,error:""});const r=await n.fetchSeries(t);this.setState({validationStatus:`Selector is valid (${r.length} streams found)`})}render(){const{theme:t}=this.props,{labels:n,searchTerm:r,status:l,error:i,validationStatus:u}=this.state;if(n.length===0)return e.createElement(Fe.u,{text:"Loading labels..."});const o=dt(t),c=Y(this.state.labels),m=c===be;let p=n.filter(d=>d.selected&&d.values);return r?p=p.map(d=>{const L=d.values.filter(y=>{if(y.selected)return y.highlightParts=void 0,!0;const E=(0,it.C)(y.name.toLowerCase(),r.toLowerCase());return E.found?(y.highlightParts=E.ranges,y.order=E.distance,!0):!1});return{...d,values:(0,w.sortBy)(L,y=>y.selected?-1/0:y.order)}}):p=this.state.labels.filter(d=>d.selected&&d.values).map(d=>({...d,values:d?.values?d.values.map(L=>({...L,highlightParts:void 0})):[]})),e.createElement(e.Fragment,null,e.createElement("div",{className:o.wrapper},e.createElement("div",{className:(0,g.cx)(o.section,o.wrapperPadding)},e.createElement(ue._,{description:"Which labels would you like to consider for your search?"},"1. Select labels to search in"),e.createElement("div",{className:o.list},n.map(d=>e.createElement(fe._,{key:d.name,name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets,onClick:this.onClickLabel})))),e.createElement("div",{className:(0,g.cx)(o.section,o.wrapperPadding)},e.createElement(ue._,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels."},"2. Find values for the selected labels"),e.createElement("div",null,e.createElement(ee.I,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:r,placeholder:"Enter a label value"})),e.createElement("div",{className:o.valueListArea},p.map(d=>e.createElement("div",{role:"list",key:d.name,className:o.valueListWrapper},e.createElement("div",{className:o.valueTitle,"aria-label":`Values for ${d.name}`},e.createElement(fe._,{name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets||d.values?.length,onClick:this.onClickLabel})),e.createElement(ot.t7,{height:200,itemCount:d.values?.length||0,itemSize:28,itemKey:L=>d.values[L].name,width:200,className:o.valueList},({index:L,style:y})=>{const E=d.values?.[L];return E?e.createElement("div",{style:y},e.createElement(fe._,{name:d.name,value:E?.name,active:E?.selected,highlightParts:E?.highlightParts,onClick:this.onClickValue,searchTerm:r})):null})))))),e.createElement("div",{className:o.footerSectionStyles},e.createElement(ue._,null,"3. Resulting selector"),e.createElement("pre",{"aria-label":"selector",className:o.selector},c),u&&e.createElement("div",{className:o.validationStatus},u),e.createElement("div",{className:(0,g.cx)(o.status,(l||i)&&o.statusShowing)},e.createElement("span",{className:i?o.error:""},i||l)),e.createElement($e.Lh,null,e.createElement(k.zx,{"aria-label":"Use selector as logs button",disabled:m,onClick:this.onClickRunLogsQuery},"Show logs"),e.createElement(k.zx,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:m,onClick:this.onClickRunMetricsQuery},"Show logs rate"),e.createElement(k.zx,{"aria-label":"Validate submit button",variant:"secondary",disabled:m,onClick:this.onClickValidate},"Validate selector"),e.createElement(k.zx,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear},"Clear"))))}}const pt=(0,Z.HE)(mt),gt=a=>{const{isOpen:t,onClose:n,datasource:r,app:l}=a,[i,u]=(0,e.useState)(!1),[o,c]=(0,e.useState)(!1),m="grafana.datasources.loki.browser.labels",p=(0,Z.wW)(ht);(0,e.useEffect)(()=>{t&&r.languageProvider.fetchLabels().then(E=>{u(!0),c(E.length>0)})},[r,t]);const d=E=>{const{query:b,onChange:f,onRunQuery:h}=a,S={...b,expr:E};f(S),h()},L=E=>{d(E),n()},y=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:l,closeType:"modalClose"}),n()};return e.createElement(we.u,{isOpen:t,title:"Label browser",onDismiss:y,className:p.modal},!i&&e.createElement(Fe.u,{text:"Loading labels..."}),i&&!o&&e.createElement("p",null,"No labels found."),i&&o&&e.createElement(rt.G,{storageKey:m,defaultValue:[]},(E,b,f)=>e.createElement(pt,{languageProvider:r.languageProvider,onChange:L,lastUsedLabels:E,storeLastUsedLabels:b,deleteLastUsedLabels:f,app:l})))},ht=a=>({modal:(0,g.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var ft=s(77960),R=s(53859),J=s(32773),vt=s(54554),Le=s(87355),Re=s(60481),q=s(46101),Et=s(46298),te=s(99456),yt=s(34964),bt=s(81803),ae=s(69171),ne=s(9558),se=s(83566),Lt=s(82473);function St({item:a,items:t,defaultOp:n,onChange:r,onDelete:l,onGetLabelNames:i,onGetLabelValues:u,invalidLabel:o,invalidValue:c}){const[m,p]=(0,e.useState)({}),[d,L]=(0,e.useState)(!1),[y,E]=(0,e.useState)(!1),b="You have conflicting label filters",f=(C=a.op)=>Ie.find(I=>I.label===C)?.isMultiValue,h=C=>C?C.indexOf("|")>0?C.split("|"):[C]:[],S=()=>{const C=m.labelValues?[...m.labelValues]:[],I=h(a?.value).map(te.E);return(0,w.uniqBy)([...I,...C],"value")},W=(0,Lt.Zc)(a,t);return e.createElement("div",{"data-testid":"prometheus-dimensions-filter-item"},e.createElement(ae._,{error:b,invalid:W?!0:void 0},e.createElement(yt.B,null,e.createElement(ne.Ph,{placeholder:"Select label","aria-label":z.wl.components.QueryBuilder.labelSelect,inputId:"prometheus-dimensions-filter-item-key",width:"auto",value:a.label?(0,te.E)(a.label):null,allowCustomValue:!0,onOpenMenu:async()=>{p({isLoadingLabelNames:!0});const C=await i(a);L(!0),p({labelNames:C,isLoadingLabelNames:void 0})},onCloseMenu:()=>{L(!1)},isOpen:d,isLoading:m.isLoadingLabelNames,options:m.labelNames,onChange:C=>{C.label&&r({...a,op:a.op??n,label:C.label})},invalid:W||o}),e.createElement(ne.Ph,{"aria-label":z.wl.components.QueryBuilder.matchOperatorSelect,value:(0,te.E)(a.op??n),options:Ie,width:"auto",onChange:C=>{C.value!=null&&r({...a,op:C.value,value:f(C.value)?a.value:h(a?.value)[0]})},invalid:W}),e.createElement(ne.Ph,{placeholder:"Select value","aria-label":z.wl.components.QueryBuilder.valueSelect,inputId:"prometheus-dimensions-filter-item-value",width:"auto",value:f()?h(a?.value).map(te.E):h(a?.value).map(te.E)[0],allowCustomValue:!0,onOpenMenu:async()=>{p({isLoadingLabelValues:!0});const C=await u(a);p({...m,labelValues:C,isLoadingLabelValues:void 0}),E(!0)},onCloseMenu:()=>{E(!1)},isOpen:y,isMulti:f(),isLoading:m.isLoadingLabelValues,options:S(),onChange:C=>{if(C.value)r({...a,value:C.value,op:a.op??n});else{const I=C.map(pe=>pe.label).join("|");r({...a,value:I,op:a.op??n})}},invalid:W||c}),e.createElement(bt._,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:l}))))}const Ie=[se.AI.equals,se.AI.doesNotEqual,se.AI.matchesRegex,se.AI.doesNotMatchRegex],xt="Select at least 1 label filter (label and value)";function Ct({labelsFilters:a,onChange:t,onGetLabelNames:n,onGetLabelValues:r,labelFilterRequired:l}){const i="=",[u,o]=(0,e.useState)([{op:i}]);(0,e.useEffect)(()=>{a.length>0?o(a):o([{op:i}])},[a]);const c=p=>{o(p);const d=p.filter(L=>L.label!=null&&L.value!=null);(0,w.isEqual)(d,a)||t(d)},m=u.some(p=>p.label&&p.value);return e.createElement(Re.s,null,e.createElement(q.S,{label:"Label filters",error:xt,invalid:l&&!m},e.createElement(Et.k,{items:u,onChange:c,renderItem:(p,d,L)=>e.createElement(St,{item:p,items:u,defaultOp:i,onChange:d,onDelete:L,onGetLabelNames:n,onGetLabelValues:r,invalidLabel:l&&!p.label,invalidValue:l&&!p.value})})))}var Be=s(47433),Nt=s(1842),Ae=s(23070),Mt=s(22162),Pt=s(83188),de=s(6155),me=s(88553);const Ue="Fetch all log lines matching label filters.",Ve=e.memo(({query:a})=>{const t=(0,J._z)(a||"").query,n={grammar:me.xY,name:"lokiql"};return e.createElement(P.K,{gap:0,direction:"column"},e.createElement(Be.B,{stepNumber:1,title:e.createElement(de.U,{query:`${R.y.renderLabels(t.labels)}`,lang:n})},Ue),e.createElement(Ae.V,{stepNumber:2,queryModeller:R.y,query:t,lang:n}))});Ve.displayName="LokiQueryBuilderExplained";var re=s(28448),ze=s(68497),Tt=s(36860);const je=e.memo(({nestedQuery:a,index:t,datasource:n,onChange:r,onRemove:l,onRunQuery:i,showExplain:u})=>{const o=(0,Z.wW)(Qt);return e.createElement("div",{className:o.card},e.createElement("div",{className:o.header},e.createElement("div",{className:o.name},"Operator"),e.createElement(ne.Ph,{"aria-label":"Select operator",width:"auto",options:Ot,value:(0,te.E)(a.operator),onChange:c=>{r(t,{...a,operator:c.value})}}),e.createElement("div",{className:o.name},"Vector matches"),e.createElement("div",{className:o.vectorMatchWrapper},e.createElement(ne.Ph,{width:"auto",value:a.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:c=>{r(t,{...a,vectorMatchesType:c.value})}}),e.createElement(re.H,{className:o.vectorMatchInput,minWidth:20,defaultValue:a.vectorMatches,onCommitChange:c=>{r(t,{...a,vectorMatches:c.currentTarget.value,vectorMatchesType:a.vectorMatchesType||"on"})}})),e.createElement(Q.B,{grow:1}),e.createElement(ze.h,{name:"times",size:"sm",onClick:()=>l(t),tooltip:"Remove nested query"})),e.createElement("div",{className:o.body},e.createElement(ce._,null,e.createElement(Se,{showExplain:u,query:a.query,datasource:n,onRunQuery:i,onChange:c=>{r(t,{...a,query:c})}}))))}),Ot=Tt.i.map(a=>({label:a.sign,value:a.sign}));je.displayName="NestedQuery";const Qt=a=>({card:(0,g.css)({label:"card",display:"flex",flexDirection:"column",gap:a.spacing(.5)}),header:(0,g.css)({label:"header",padding:a.spacing(.5,.5,.5,1),gap:a.spacing(1),display:"flex",alignItems:"center"}),name:(0,g.css)({label:"name",whiteSpace:"nowrap"}),body:(0,g.css)({label:"body",paddingLeft:a.spacing(2)}),vectorMatchInput:(0,g.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,g.css)({label:"vectorMatchWrapper",display:"flex"})});function kt({query:a,datasource:t,onChange:n,onRunQuery:r,showExplain:l}){const i=a.binaryQueries??[],u=(c,m)=>{const p=[...i];p.splice(c,1,m),n({...a,binaryQueries:p})},o=c=>{const m=[...i.slice(0,c),...i.slice(c+1)];n({...a,binaryQueries:m})};return e.createElement(P.K,{direction:"column",gap:1},i.map((c,m)=>e.createElement(je,{key:m.toString(),nestedQuery:c,index:m,onChange:u,datasource:t,onRemove:o,onRunQuery:r,showExplain:l})))}const Se=e.memo(({datasource:a,query:t,onChange:n,onRunQuery:r,showExplain:l})=>{const[i,u]=(0,e.useState)(),[o,c]=(0,e.useState)(void 0),m=b=>{n({...t,labels:b})},p=async b=>{const f=await b;return[...a.getVariables(),...f].map(h=>({label:h,value:h}))},d=async b=>{const f=t.labels.filter(I=>I!==b);if(f.length===0)return await a.languageProvider.fetchLabels();const h=R.y.renderLabels(f),S=await a.languageProvider.fetchSeriesLabels(h),W=f.map(I=>I.label);return Object.keys(S).filter(I=>!W.includes(I)).sort()},L=async b=>{if(!b.label)return[];let f;const h=t.labels.filter(S=>S!==b);if(h.length===0)f=await a.languageProvider.fetchLabelValues(b.label);else{const S=R.y.renderLabels(h);f=(await a.languageProvider.fetchSeriesLabels(S))[a.interpolateString(b.label)]}return f?f.map(S=>(0,ve.Hk)(S,b.op)):[]},y=(0,e.useMemo)(()=>{const{labels:b,operations:f}=t;return!b.length&&f.length?!(f.length===1&&f[0].id===se.B5.LineContains&&f[0].params[0]===""):!1},[t]);(0,e.useEffect)(()=>{(async()=>{const f={expr:R.y.renderQuery(t),refId:"data-samples"},S={series:await a.getDataSamples(f),state:O.Gu.Done,timeRange:(0,vt.JK)()};u(S)})().catch(console.error)},[a,t]);const E={grammar:me.ZP,name:"logql"};return e.createElement("div",{"data-testid":Ne.editor},e.createElement(Le.p,null,e.createElement(Ct,{onGetLabelNames:b=>p(d(b)),onGetLabelValues:b=>p(L(b)),labelsFilters:t.labels,onChange:m,labelFilterRequired:y})),l&&e.createElement(Be.B,{stepNumber:1,title:e.createElement(de.U,{query:`${R.y.renderLabels(t.labels)}`,lang:E})},Ue),e.createElement(Mt.B,null,e.createElement(Nt.P,{queryModeller:R.y,query:t,onChange:n,onRunQuery:r,datasource:a,highlightedOp:o}),e.createElement(Pt.L,{datasource:a,query:t,onChange:n,data:i,queryModeller:R.y,buildVisualQueryFromString:J._z})),l&&e.createElement(Ae.V,{stepNumber:2,queryModeller:R.y,query:t,lang:E,onMouseEnter:b=>{c(b)},onMouseLeave:()=>{c(void 0)}}),t.binaryQueries&&t.binaryQueries.length>0&&e.createElement(kt,{query:t,datasource:a,onChange:n,onRunQuery:r,showExplain:l}))});Se.displayName="LokiQueryBuilder";function Dt({query:a}){return e.createElement(Le.p,null,e.createElement(Re.s,null,e.createElement(de.U,{query:a,lang:{grammar:me.xY,name:"lokiql"}})))}function wt(a){const{query:t,onChange:n,onRunQuery:r,datasource:l,showExplain:i}=a,[u,o]=(0,e.useReducer)(We.reducer,{expr:t.expr,visQuery:t.expr===""?{labels:[],operations:[{id:"__line_contains",params:[""]}]}:void 0});(0,e.useEffect)(()=>{o(Rt(t.expr))},[t.expr]);const c=m=>{const p=R.y.renderQuery(m);o($t({visQuery:m,expr:p})),n({...a.query,expr:p})};return u.visQuery?e.createElement(e.Fragment,null,e.createElement(Se,{query:u.visQuery,datasource:l,onChange:c,onRunQuery:r,showExplain:i,"data-testid":Ne.editor}),t.expr!==""&&e.createElement(Dt,{query:t.expr})):null}const Ft={expr:""},We=(0,ft.oM)({name:"loki-builder-container",initialState:Ft,reducers:{visualQueryChange:(a,t)=>{a.expr=t.payload.expr,a.visQuery=t.payload.visQuery},exprChanged:(a,t)=>{if(!a.visQuery||a.expr!==t.payload){a.expr=t.payload;const n=(0,J._z)(t.payload);a.visQuery=n.query}}}}),{visualQueryChange:$t,exprChanged:Rt}=We.actions;var Ke=s(5195),It=s(20454),Bt=s(33155),At=s(30736),oe=s(9865),xe=s(11569);const Ge=e.memo(({app:a,query:t,onChange:n,onRunQuery:r,maxLines:l,queryStats:i})=>{const[u,o]=(0,e.useState)(!0),c=h=>{n({...t,queryType:h}),r()},m=h=>{(0,N.ff)("grafana_loki_resolution_clicked",{app:a,resolution:h.value}),n({...t,resolution:h.value}),r()},p=h=>{const S=h.currentTarget.value;if(!(0,Ke.jO)(S)){o(!1);return}o(!0),n({...t,splitDuration:S}),r()},d=h=>{n({...t,legendFormat:h.currentTarget.value}),r()};function L(h){const S=(0,oe.Wz)(h.currentTarget.value);t.maxLines!==S&&(n({...t,maxLines:S}),r())}function y(h){n({...t,step:(0,w.trim)(h.currentTarget.value)}),r()}const E=(0,xe.Lw)(t),b=(0,xe.rE)(t.expr),f=(0,e.useMemo)(()=>!!(!t.step||(0,Ke.fI)(t.step)||!isNaN(Number(t.step))),[t.step]);return e.createElement(Le.p,null,e.createElement(At.d,{title:"Options",collapsedInfo:Ut(t,E,l,b,f),queryStats:i},e.createElement(q.S,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname."},e.createElement(re.H,{placeholder:"{{label}}",type:"string",minWidth:14,defaultValue:t.legendFormat,onCommitChange:d})),e.createElement(q.S,{label:"Type"},e.createElement(It.S,{options:oe.uG,value:E,onChange:c})),b&&e.createElement(q.S,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query."},e.createElement(re.H,{className:"width-4",placeholder:l.toString(),type:"number",min:0,defaultValue:t.maxLines?.toString()??"",onCommitChange:L})),!b&&e.createElement(e.Fragment,null,e.createElement(q.S,{label:"Step",tooltip:"Use the step parameter when making metric queries to Loki. If not filled, Grafana's calculated interval will be used. Example valid values: 1s, 5m, 10h, 1d.",invalid:!f,error:"Invalid step. Example valid values: 1s, 5m, 10h, 1d."},e.createElement(re.H,{className:"width-6",placeholder:"auto",type:"string",defaultValue:t.step??"",onCommitChange:y})),t.resolution!==void 0&&t.resolution>1&&e.createElement(e.Fragment,null,e.createElement(q.S,{label:"Resolution",tooltip:"Changes the step parameter of Loki metrics range queries. With a resolution of 1/1, each pixel corresponds to one data point. 1/10 retrieves one data point per 10 pixels. Lower resolutions perform better."},e.createElement(ne.Ph,{isSearchable:!1,onChange:m,options:oe.oZ,value:t.resolution||1,"aria-label":"Select resolution"})),e.createElement(Bt.b,{severity:"warning",title:"The 'Resolution' is deprecated. Use 'Step' editor instead to change step parameter."}))),H.config.featureToggles.lokiQuerySplittingConfig&&H.config.featureToggles.lokiQuerySplitting&&e.createElement(q.S,{label:"Split Duration",tooltip:"Defines the duration of a single query when query splitting is enabled."},e.createElement(re.H,{minWidth:14,type:"string",min:0,defaultValue:t.splitDuration??"1d",onCommitChange:p,invalid:!u}))))});function Ut(a,t,n,r,l){const i=oe.uG.find(c=>c.value===t),u=oe.oZ.find(c=>c.value===(a.resolution??1)),o=[];return a.legendFormat&&o.push(`Legend: ${a.legendFormat}`),o.push(`Type: ${i?.label}`),r&&o.push(`Line limit: ${a.maxLines??n}`),r||(a.step&&o.push(`Step: ${l?a.step:"Invalid value"}`),a.resolution&&o.push(`Resolution: ${u?.label}`)),o}Ge.displayName="LokiQueryBuilderOptions";var He=s(69865),Ze=s(12190),Vt=s(10178),Ye=s(88132);function zt({query:a,datasource:t,range:n,onRunQuery:r,onChange:l,data:i,app:u,showExplain:o,history:c}){const m=(0,Z.wW)(jt),p=H.config.featureToggles.lokiFormatQuery,d=async()=>l({...a,expr:(0,xe.Ix)(a.expr,t)});return e.createElement("div",{className:m.wrapper},e.createElement(Ye.n,{datasource:t,query:a,range:n,onRunQuery:r,onChange:l,history:c,data:i,app:u,"data-testid":Ne.editor,ExtraFieldElement:e.createElement(e.Fragment,null,p&&e.createElement("div",{className:m.buttonGroup},e.createElement("div",null,e.createElement($e.Lh,{spacing:"sm"},e.createElement(ze.h,{onClick:d,name:"brackets-curly",size:"xs",tooltip:"Format query"}),e.createElement(He.u,{content:`Use ${(0,Vt.vl)()}+z to undo`},e.createElement(Ze.J,{className:m.hint,name:"keyboard"}))))))}),o&&e.createElement(Ve,{query:a.expr}))}const jt=a=>({wrapper:(0,g.css)`
      max-width: 100%;
      .gf-form {
        margin-bottom: 0.5;
      }
    `,buttonGroup:(0,g.css)`
      border: 1px solid ${a.colors.border.medium};
      border-top: none;
      padding: ${a.spacing(.5,.5,.5,.5)};
      margin-bottom: ${a.spacing(.5)};
      display: flex;
      flex-grow: 1;
      justify-content: end;
      font-size: ${a.typography.bodySmall.fontSize};
    `,hint:(0,g.css)`
      color: ${a.colors.text.disabled};
      white-space: nowrap;
      cursor: help;
    `});var Wt=s(62818),Kt=s(78354),Ce=s(4236);const Gt=a=>{const{pattern:t,onPatternSelect:n,hasNewQueryOption:r,hasPreviousQuery:l,selectedPatternName:i,setSelectedPatternName:u}=a,o=(0,Z.wW)(Ht),c={grammar:me.ZP,name:"logql"};return e.createElement(Ce.Z,{className:o.card},e.createElement(Ce.Z.Heading,null,t.name),e.createElement("div",{className:o.rawQueryContainer},e.createElement(de.U,{query:R.y.renderQuery({labels:[],operations:t.operations}),lang:c,className:o.rawQuery})),e.createElement(Ce.Z.Actions,null,i!==t.name?e.createElement(k.zx,{size:"sm",onClick:()=>{l?u(t.name):n(t)}},"Use this query"):e.createElement(e.Fragment,null,e.createElement("div",{className:o.spacing},`If you would like to use this query, ${r?"you can either replace your current query or create a new query":"your current query will be replaced"}.`),e.createElement(k.zx,{size:"sm",fill:"outline",onClick:()=>u(null)},"Back"),e.createElement(k.zx,{size:"sm",onClick:()=>{n(t)}},"Replace query"),r&&e.createElement(k.zx,{size:"sm",onClick:()=>{n(t,!0)}},"Create new query"))))},Ht=a=>({card:(0,g.css)`
      width: 49.5%;
      display: flex;
      flex-direction: column;
    `,rawQueryContainer:(0,g.css)`
      flex-grow: 1;
    `,rawQuery:(0,g.css)`
      background-color: ${a.colors.background.primary};
      padding: ${a.spacing(1)};
      margin-top: ${a.spacing(1)};
    `,spacing:(0,g.css)`
      margin-bottom: ${a.spacing(1)};
    `}),Zt=a=>{const{isOpen:t,onClose:n,onChange:r,onAddQuery:l,query:i,queries:u,app:o}=a,[c,m]=(0,e.useState)([]),[p,d]=(0,e.useState)(null),L=(0,Z.wW)(Yt),y=!!l,E=(0,e.useMemo)(()=>(0,J._z)(i.expr).query.operations.length>0,[i.expr]),b=(f,h=!1)=>{const S=(0,J._z)(h?"":i.expr);(0,N.ff)("grafana_loki_query_patterns_selected",{version:"v2",app:o??"",editorMode:i.editorMode,selectedPattern:f.name,preSelectedOperationsCount:S.query.operations.length,preSelectedLabelsCount:S.query.labels.length,createNewQuery:y&&h}),S.query.operations=f.operations,y&&h?l({...i,refId:(0,Kt.Hs)(u??[i]),expr:R.y.renderQuery(S.query)}):r({...i,expr:R.y.renderQuery(S.query)}),d(null),n()};return e.createElement(we.u,{isOpen:t,title:"Kick start your query",onDismiss:n,className:L.modal},e.createElement("div",{className:L.spacing},"Kick start your query by selecting one of these queries. You can then continue to complete your query."),Object.values(se.Hv).map(f=>e.createElement(Wt.U,{key:f,label:`${(0,w.capitalize)(f)} query starters`,isOpen:c.includes(f),collapsible:!0,onToggle:()=>m(h=>h.includes(f)?h.filter(S=>S!==f):[...h,f])},e.createElement("div",{className:L.cardsContainer},R.y.getQueryPatterns().filter(h=>h.type===f).map(h=>e.createElement(Gt,{key:h.name,pattern:h,hasNewQueryOption:y,hasPreviousQuery:E,onPatternSelect:b,selectedPatternName:p,setSelectedPatternName:d}))))),e.createElement(k.zx,{variant:"secondary",onClick:n},"Close"))},Yt=a=>({cardsContainer:(0,g.css)`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
    `,spacing:(0,g.css)`
      margin-bottom: ${a.spacing(1)};
    `,modal:(0,g.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var Xe=s(23062),Xt=s(73363);const Je="LokiQueryEditorModeDefault";function Jt(a,t,n){a.expr===""&&Xe.Z.set(Je,t),n({...a,editorMode:t})}function qt(a){if(a!=null&&a!=="")return X.c.Code;switch(Xe.Z.get(Je)){case"code":return X.c.Code;case"builder":default:return X.c.Builder}}function _t(a){let t=a;return a.editorMode||(t={...a,editorMode:qt(a.expr)}),a.expr==null&&(t={...t,expr:""}),a.queryType==null&&(t={...t,queryType:Xt.EM.Range}),t}var ea=s(92403);function qe(a,t){return!a||!t?!1:(0,ea.v9)(a)?a.isSame(t):a===t}function ta(a,t,n,r,l,i){return t===void 0||a.trim()!==t.trim()||l!==i?!0:!(qe(n?.raw.from,r?.raw.from)&&qe(n?.raw.to,r?.raw.to))}const Ne={editor:"loki-editor"},_e=e.memo(a=>{const{onChange:t,onRunQuery:n,onAddQuery:r,data:l,app:i,queries:u,datasource:o,range:c}=a,[m,p]=(0,e.useState)(!1),[d,L]=(0,e.useState)(!1),[y,E]=(0,e.useState)(!1),[b,f]=(0,e.useState)(!1),[h,S]=(0,e.useState)(null),{flag:W,setFlag:C}=(0,De.P5)(De.iS),I=o.predefinedOperations,pe=(0,M.Z)(c),T=_t(a.query);H.config.featureToggles.lokiPredefinedOperations&&!T.expr&&I&&(T.expr=`{} ${I}`);const at=(0,M.Z)(T.expr),nt=(0,M.Z)(T.queryType),Oe=T.editorMode,Ba=B=>{C(B.currentTarget.checked)},Aa=(0,e.useCallback)(B=>{if((0,N.ff)("grafana_loki_editor_mode_clicked",{newEditor:B,previousEditor:T.editorMode??"",newQuery:!T.expr,app:i??""}),B===X.c.Builder&&(0,J._z)(T.expr||"").errors.length){p(!0);return}Jt(T,B,t)},[t,T,i]);(0,e.useEffect)(()=>{E(!1)},[l]);const Qe=B=>{(0,w.isEqual)(B,a.query)||E(!0),t(B)},Ua=()=>{(0,N.ff)("grafana_loki_label_browser_opened",{app:i}),f(B=>!B)};return(0,e.useEffect)(()=>{ta(T.expr,at,c,pe,T.queryType,nt)&&(async()=>{const Va=await o.getStats(T);S(Va)})()},[o,c,pe,T,at,nt,S]),e.createElement(e.Fragment,null,e.createElement(he.s,{isOpen:m,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{t({...T,editorMode:X.c.Builder}),p(!1)},onDismiss:()=>p(!1)}),e.createElement(Zt,{isOpen:d,onClose:()=>L(!1),query:T,queries:u,app:i,onChange:t,onAddQuery:r}),e.createElement(gt,{isOpen:b,datasource:o,query:T,app:i,onClose:()=>f(!1),onChange:Qe,onRunQuery:n}),e.createElement(ge.K,null,e.createElement(P.K,{gap:1},e.createElement(k.zx,{"aria-label":z.wl.components.QueryBuilder.queryPatterns,variant:"secondary",size:"sm",onClick:()=>{L(ke=>!ke);const B=(0,J._z)(T.expr||"");(0,N.ff)("grafana_loki_query_patterns_opened",{version:"v2",app:i??"",editorMode:T.editorMode,preSelectedOperationsCount:B.query.operations.length,preSelectedLabelsCount:B.query.labels.length})}},"Kick start your query"),e.createElement(k.zx,{variant:"secondary",size:"sm",onClick:Ua,"data-testid":"label-browser-button"},"Label browser")),e.createElement(lt.n,{label:"Explain query",value:W,onChange:Ba}),e.createElement(Q.B,{grow:1}),i!==v.zj.Explore&&i!==v.zj.Correlations&&e.createElement(k.zx,{variant:y?"primary":"secondary",size:"sm",onClick:n,icon:l?.state===O.Gu.Loading?"fa fa-spinner":void 0,disabled:l?.state===O.Gu.Loading},u&&u.length>1?"Run queries":"Run query"),e.createElement(st.k,{mode:Oe,onChange:Aa})),e.createElement($.T,{v:.5}),e.createElement(ce._,null,Oe===X.c.Code&&e.createElement(zt,{...a,query:T,onChange:Qe,showExplain:W}),Oe===X.c.Builder&&e.createElement(wt,{datasource:a.datasource,query:T,onChange:Qe,onRunQuery:a.onRunQuery,showExplain:W}),e.createElement(Ge,{query:T,onChange:t,onRunQuery:n,app:i,maxLines:o.maxLines,queryStats:h})))});_e.displayName="LokiQueryEditor";function aa(a){const{query:t,data:n,datasource:r,onChange:l,onRunQuery:i,history:u}=a;return e.createElement(Ye.n,{datasource:r,query:t,onChange:l,onRunQuery:i,history:u,data:n,placeholder:"Enter a Loki query","data-testid":na.editor})}const na={editor:"loki-editor-cloud-alerting"};function sa(a){const{app:t}=a;switch(t){case v.zj.CloudAlerting:return e.createElement(aa,{...a});default:return e.createElement(_e,{...a})}}const la=(0,e.memo)(sa),za={editor:"loki-editor"};var ra=s(17613),oa=s(66211),ia=s(84461),ca=s(28789),ua=s(27770),da=s(54522),ma=s(47169),le=s(25243),Me=s(99242),et=s(26286),Pe=s(43997);function pa({options:a,onOptionsChange:t}){return e.createElement(Me._,{title:"Alerting",description:e.createElement(Pe.W,{description:"Manage alert rules for the Loki data source.",suffix:"loki/configure-loki-data-source/#alerting",feature:"alerting"})},e.createElement(ae._,{labelWidth:29,label:"Manage alert rules in Alerting UI",disabled:a.readOnly,tooltip:"Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data source."},e.createElement(et.x,{value:a.jsonData.manageAlerts!==!1,onChange:n=>t({...a,jsonData:{...a.jsonData,manageAlerts:n.currentTarget.checked}})})))}var ga=s(24824),ha=s(69733),fa=s(89591),va=s(68421),Ea=s(42512);const ya=a=>{const{derivedFields:t,className:n}=a,[r,l]=(0,e.useState)("");let i=[];return r&&t&&(i=La(t,r)),e.createElement("div",{className:n},e.createElement(ae._,{label:"Debug log message",labelWidth:24,grow:!0},e.createElement(va.K,{type:"text","aria-label":"Prometheus Query",placeholder:"Paste an example log line here to test the regular expressions of your derived fields",value:r,onChange:u=>l(u.currentTarget.value)})),!!i.length&&e.createElement(ba,{fields:i}))},ba=({fields:a})=>e.createElement("table",{className:"filter-table"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Value"),e.createElement("th",null,"Url"))),e.createElement("tbody",null,a.map(t=>{let n=t.value;return t.error&&t.error instanceof Error?n=t.error.message:t.href&&(n=e.createElement("a",{href:t.href},n)),e.createElement("tr",{key:`${t.name}=${t.value}`},e.createElement("td",null,t.name),e.createElement("td",null,n),e.createElement("td",null,t.href?e.createElement("a",{href:t.href},t.href):""))})));function La(a,t){return a.filter(n=>n.name&&n.matcherRegex).map(n=>{try{const r=t.match(n.matcherRegex),l=r&&r[1];let i=null;return n.url&&l&&(i=(0,Ea.a_)({field:{name:"",type:fa.fS.string,values:[l],config:{links:[{title:"",url:n.url}]}},rowIndex:0,range:{}})[0]),{name:n.name,value:l||"<no match>",href:i?i.href:void 0}}catch(r){return{name:n.name,error:r}}})}var _=s(96227),Sa=s(95540),xa=s(92811);const Ca=a=>({row:(0,g.css)`
    display: flex;
    align-items: baseline;
  `,nameField:(0,g.css)`
    flex: 2;
    margin-right: ${a.spacing(.5)};
  `,regexField:(0,g.css)`
    flex: 3;
    margin-right: ${a.spacing(.5)};
  `,urlField:(0,g.css)`
    flex: 1;
    margin-right: ${a.spacing(.5)};
  `,urlDisplayLabelField:(0,g.css)`
    flex: 1;
  `,internalLink:(0,g.css)`
    margin-right: ${a.spacing(1)};
  `,dataSource:(0,g.css)``}),Na=a=>{const{value:t,onChange:n,onDelete:r,suggestions:l,className:i,validateName:u}=a,o=(0,Z.wW)(Ca),[c,m]=(0,e.useState)(!!t.datasourceUid),p=(0,M.Z)(t.datasourceUid);(0,e.useEffect)(()=>{!p&&t.datasourceUid&&!c&&m(!0),p&&!t.datasourceUid&&c&&m(!1)},[p,t.datasourceUid,c]);const d=y=>E=>{n({...t,[y]:E.currentTarget.value})},L=!u(t.name);return e.createElement("div",{className:i,"data-testid":"derived-field"},e.createElement("div",{className:"gf-form"},e.createElement(_.g,{className:o.nameField,label:"Name",invalid:L,error:"The name is already in use"},e.createElement(ee.I,{value:t.name,onChange:d("name"),placeholder:"Field name",invalid:L})),e.createElement(_.g,{className:o.regexField,label:e.createElement(tt,{label:"Regex",content:"Use to parse and capture some part of the log message. You can use the captured groups in the template."})},e.createElement(ee.I,{value:t.matcherRegex,onChange:d("matcherRegex")})),e.createElement(_.g,{label:""},e.createElement(k.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:y=>{y.preventDefault(),r()}}))),e.createElement("div",{className:"gf-form"},e.createElement(_.g,{label:c?"Query":"URL",className:o.urlField},e.createElement(Sa.v,{placeholder:c?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:y=>n({...t,url:y}),suggestions:l})),e.createElement(_.g,{className:o.urlDisplayLabelField,label:e.createElement(tt,{label:"URL Label",content:"Use to override the button label when this derived field is found in a log."})},e.createElement(ee.I,{value:t.urlDisplayLabel,onChange:d("urlDisplayLabel")}))),e.createElement("div",{className:"gf-form"},e.createElement(_.g,{label:"Internal link",className:o.internalLink},e.createElement(et.r,{value:c,onChange:y=>{const{checked:E}=y.currentTarget;E||n({...t,datasourceUid:void 0}),m(E)}})),c&&e.createElement(_.g,{label:"",className:o.dataSource},e.createElement(xa.q,{tracing:!0,onChange:y=>n({...t,datasourceUid:y.uid}),current:t.datasourceUid,noDefault:!0}))))},tt=({content:a,label:t})=>e.createElement(ue._,null,t,e.createElement(He.u,{placement:"top",content:a,theme:"info"},e.createElement(Ze.J,{tabIndex:0,name:"info-circle",size:"sm",style:{marginLeft:"10px"}}))),Ma=a=>({addButton:(0,g.css)`
    margin-right: 10px;
  `,derivedField:(0,g.css)`
    margin-bottom: ${a.spacing(1)};
  `,container:(0,g.css)`
    margin-bottom: ${a.spacing(4)};
  `,debugSection:(0,g.css)`
    margin-top: ${a.spacing(4)};
  `}),Pa=({fields:a=[],onChange:t})=>{const n=(0,Z.l4)(),r=Ma(n),[l,i]=(0,e.useState)(!1),u=(0,e.useCallback)(o=>a.filter(c=>c.name&&c.name===o).length<=1,[a]);return e.createElement(Me._,{title:"Derived fields",description:e.createElement(Pe.W,{description:"Derived fields can be used to extract new fields from a log message and create a link from its value.",suffix:"loki/configure-loki-data-source/#derived-fields",feature:"derived fields"})},e.createElement("div",{className:r.container},a.map((o,c)=>e.createElement(Na,{className:r.derivedField,key:c,value:o,onChange:m=>{const p=[...a];p.splice(c,1,m),t(p)},onDelete:()=>{const m=[...a];m.splice(c,1),t(m)},validateName:u,suggestions:[{value:ga.W.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:ha.L8.Value}]})),e.createElement("div",null,e.createElement(k.zx,{variant:"secondary",className:r.addButton,icon:"plus",onClick:o=>{o.preventDefault();const c=[...a,{name:"",matcherRegex:"",urlDisplayLabel:"",url:""}];t(c)}},"Add"),a.length>0&&e.createElement(k.zx,{variant:"secondary",type:"button",onClick:()=>i(!l)},l?"Hide example log message":"Show example log message")),l&&e.createElement("div",{className:r.debugSection},e.createElement(ya,{className:(0,g.css)`
                margin-bottom: 10px;
              `,derivedFields:a}))))};var Ta=s(74661),Oa=s(12608);const Qa=a=>{const{maxLines:t,onMaxLinedChange:n,predefinedOperations:r,onPredefinedOperationsChange:l}=a;return e.createElement(Me._,{title:"Queries",description:e.createElement(Pe.W,{description:"Additional options to customize your querying experience.",suffix:"loki/configure-loki-data-source/#queries",feature:"query settings"})},e.createElement(ae._,{label:"Maximum lines",htmlFor:"loki_config_maxLines",labelWidth:22,tooltip:e.createElement(e.Fragment,null,"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results.")},e.createElement(ee.I,{type:"number",id:"loki_config_maxLines",value:t,onChange:i=>n(i.currentTarget.value),width:16,placeholder:"1000",spellCheck:!1})),H.config.featureToggles.lokiPredefinedOperations&&e.createElement(Ta.Z,null,e.createElement(ae._,{label:"Predefined operations",htmlFor:"loki_config_predefinedOperations",labelWidth:22,tooltip:e.createElement(e.Fragment,null,'Predefined operations are used as an initial state for your queries. They are useful, if you want to unpack, parse or format all log lines. Currently we support only log operations starting with |. For example: | unpack | line_format "{{.message}}".')},e.createElement(ee.I,{type:"string",id:"loki_config_predefinedOperations",value:r,onChange:i=>l(i.currentTarget.value),width:40,placeholder:"| unpack | line_format",spellCheck:!1})),e.createElement(ae._,null,e.createElement(Oa.C,{text:"Experimental",color:"orange",icon:"exclamation-triangle",tooltip:"Predefined operations is an experimental feature that may change in the future."}))))},Te=a=>(t,n)=>({...t,jsonData:{...t.jsonData,[a]:n}}),ka=Te("maxLines"),Da=Te("predefinedOperations"),wa=Te("derivedFields"),Fa=a=>{const{options:t,onOptionsChange:n}=a,r=(0,e.useCallback)(l=>{(0,N.ff)("grafana_loki_predefined_operations_changed",{value:l}),n(Da(t,l))},[t,n]);return e.createElement(e.Fragment,null,e.createElement(ra.j,{dataSourceName:"Loki",docsLink:"https://grafana.com/docs/grafana/latest/datasources/loki/configure-loki-data-source/",hasRequiredFields:!1}),e.createElement(le.i,null),e.createElement(oa.f,{config:t,onChange:n,urlPlaceholder:"http://localhost:3100"}),e.createElement(le.i,null),e.createElement(ia.g,{...(0,ca.T2)({config:t,onChange:n})}),e.createElement(le.i,null),e.createElement(ua.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},e.createElement(da.a,{config:t,onChange:n}),e.createElement(le.i,{hideLine:!0}),H.config.secureSocksDSProxyEnabled&&e.createElement(ma.i,{options:t,onOptionsChange:n}),e.createElement(pa,{options:t,onOptionsChange:n}),e.createElement(le.i,{hideLine:!0}),e.createElement(Qa,{maxLines:t.jsonData.maxLines||"",onMaxLinedChange:l=>n(ka(t,l)),predefinedOperations:t.jsonData.predefinedOperations||"",onPredefinedOperationsChange:r}),e.createElement(le.i,{hideLine:!0}),e.createElement(Pa,{fields:t.jsonData.derivedFields,onChange:l=>n(wa(t,l))})))};var $a=s(98709),Ra=s(17583);const Ia=new x.hf($a.KV).setQueryEditor(la).setConfigEditor(Fa).setQueryEditorHelp(V);(0,G.N$)().subscribe(j.Pl,Ra.uJ)}}]);

//# sourceMappingURL=6934.daaea2b9654f8f72e68b.js.map