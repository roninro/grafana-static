{"version":3,"file":"AlertingRuleForm.ef0ea4140d4d82a6b9dd.js","mappings":"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","sources":["webpack://grafana/./public/app/features/alerting/unified/AlertWarning.tsx","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaRuleExporter.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/GroupAndNamespaceFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudEvaluationBehavior.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRulesNameSpaceAndGroupStep.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/AlertRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/CloneRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/ExistingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/RuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/ModifyExportRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaModifyExport.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/AlertRuleNameInput.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/notificaton-preview/useGetAlertManagersSourceNamesAndImage.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/notificaton-preview/NotificationPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/NotificationsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/types/preview.ts","webpack://grafana/./public/app/features/alerting/unified/api/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRuleResult.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRule.tsx","webpack://grafana/./public/app/features/alerting/unified/hooks/useRuleSourcesWithRuler.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudAlertPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionsEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryOptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryWrapper.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryRows.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudRulesSourcePicker.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/CloudDataSourceSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/SmartAlertTypeDetector.tsx","webpack://grafana/./public/app/features/alerting/utils/dataSourceFromExpression.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/reducer.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/useAlertQueryRunner.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/QueryAndExpressionsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/utils/duplicate.ts","webpack://grafana/./public/app/plugins/datasource/parca/QueryEditor/Stack.tsx"],"sourcesContent":["import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Alert, LinkButton, useStyles2 } from '@grafana/ui';\n\ninterface AlertWarningProps {\n  title: string;\n  children: React.ReactNode;\n}\nexport function AlertWarning({ title, children }: AlertWarningProps) {\n  return (\n    <Alert className={useStyles2(warningStyles).warning} severity=\"warning\" title={title}>\n      <p>{children}</p>\n      <LinkButton href=\"alerting/list\">To rule list</LinkButton>\n    </Alert>\n  );\n}\n\nconst warningStyles = (theme: GrafanaTheme2) => ({\n  warning: css`\n    margin: ${theme.spacing(4)};\n  `,\n});\n","import React, { useState } from 'react';\n\nimport { LoadingPlaceholder } from '@grafana/ui';\n\nimport { alertRuleApi } from '../../api/alertRuleApi';\n\nimport { FileExportPreview } from './FileExportPreview';\nimport { GrafanaExportDrawer } from './GrafanaExportDrawer';\nimport { allGrafanaExportProviders, ExportFormats } from './providers';\n\ninterface GrafanaRuleExportPreviewProps {\n  alertUid: string;\n  exportFormat: ExportFormats;\n  onClose: () => void;\n}\n\nconst GrafanaRuleExportPreview = ({ alertUid, exportFormat, onClose }: GrafanaRuleExportPreviewProps) => {\n  const { currentData: ruleTextDefinition = '', isFetching } = alertRuleApi.endpoints.exportRules.useQuery({\n    ruleUid: alertUid,\n    format: exportFormat,\n  });\n\n  const downloadFileName = `${alertUid}-${new Date().getTime()}`;\n\n  if (isFetching) {\n    return <LoadingPlaceholder text=\"Loading....\" />;\n  }\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={ruleTextDefinition}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRulerExporterProps {\n  onClose: () => void;\n  alertUid: string;\n}\n\nexport const GrafanaRuleExporter = ({ onClose, alertUid }: GrafanaRulerExporterProps) => {\n  const [activeTab, setActiveTab] = useState<ExportFormats>('yaml');\n\n  return (\n    <GrafanaExportDrawer\n      activeTab={activeTab}\n      onTabChange={setActiveTab}\n      onClose={onClose}\n      formatProviders={Object.values(allGrafanaExportProviders)}\n    >\n      <GrafanaRuleExportPreview alertUid={alertUid} exportFormat={activeTab} onClose={onClose} />\n    </GrafanaExportDrawer>\n  );\n};\n","import { css } from '@emotion/css';\nimport React, { useEffect, useMemo } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Field, InputControl, useStyles2, VirtualizedSelect } from '@grafana/ui';\nimport { useDispatch } from 'app/types';\n\nimport { useUnifiedAlertingSelector } from '../../hooks/useUnifiedAlertingSelector';\nimport { fetchRulerRulesAction } from '../../state/actions';\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { checkForPathSeparator } from './util';\n\ninterface Props {\n  rulesSourceName: string;\n}\n\nexport const GroupAndNamespaceFields = ({ rulesSourceName }: Props) => {\n  const {\n    control,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues>();\n\n  const style = useStyles2(getStyle);\n\n  const rulerRequests = useUnifiedAlertingSelector((state) => state.rulerRules);\n  const dispatch = useDispatch();\n  useEffect(() => {\n    dispatch(fetchRulerRulesAction({ rulesSourceName }));\n  }, [rulesSourceName, dispatch]);\n\n  const rulesConfig = rulerRequests[rulesSourceName]?.result;\n\n  const namespace = watch('namespace');\n\n  const namespaceOptions = useMemo(\n    (): Array<SelectableValue<string>> =>\n      rulesConfig ? Object.keys(rulesConfig).map((namespace) => ({ label: namespace, value: namespace })) : [],\n    [rulesConfig]\n  );\n\n  const groupOptions = useMemo(\n    (): Array<SelectableValue<string>> =>\n      (namespace && rulesConfig?.[namespace]?.map((group) => ({ label: group.name, value: group.name }))) || [],\n    [namespace, rulesConfig]\n  );\n\n  return (\n    <div className={style.flexRow}>\n      <Field\n        data-testid=\"namespace-picker\"\n        label=\"Namespace\"\n        error={errors.namespace?.message}\n        invalid={!!errors.namespace?.message}\n      >\n        <InputControl\n          render={({ field: { onChange, ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              className={style.input}\n              onChange={(value) => {\n                setValue('group', ''); //reset if namespace changes\n                onChange(value.value);\n              }}\n              options={namespaceOptions}\n              width={42}\n            />\n          )}\n          name=\"namespace\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n            validate: {\n              pathSeparator: checkForPathSeparator,\n            },\n          }}\n        />\n      </Field>\n      <Field data-testid=\"group-picker\" label=\"Group\" error={errors.group?.message} invalid={!!errors.group?.message}>\n        <InputControl\n          render={({ field: { ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              options={groupOptions}\n              width={42}\n              onChange={(value) => {\n                setValue('group', value.value ?? '');\n              }}\n              className={style.input}\n            />\n          )}\n          name=\"group\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n            validate: {\n              pathSeparator: checkForPathSeparator,\n            },\n          }}\n        />\n      </Field>\n    </div>\n  );\n};\n\nconst getStyle = (theme: GrafanaTheme2) => ({\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n\n    & > * + * {\n      margin-left: ${theme.spacing(3)};\n    }\n  `,\n  input: css`\n    width: 330px !important;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Field, Input, InputControl, Select, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { timeOptions } from '../../utils/time';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { PreviewRule } from './PreviewRule';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport const CloudEvaluationBehavior = () => {\n  const styles = useStyles2(getStyles);\n  const {\n    register,\n    control,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  return (\n    <RuleEditorSection stepNo={3} title=\"Set evaluation behavior\">\n      <Field\n        label=\"Pending period\"\n        description=\"Period in which an alert rule can be in breach of the condition until the alert rule fires.\"\n      >\n        <div className={styles.flexRow}>\n          <Field invalid={!!errors.forTime?.message} error={errors.forTime?.message} className={styles.inlineField}>\n            <Input\n              {...register('forTime', { pattern: { value: /^\\d+$/, message: 'Must be a positive integer.' } })}\n              width={8}\n            />\n          </Field>\n          <InputControl\n            name=\"forTimeUnit\"\n            render={({ field: { onChange, ref, ...field } }) => (\n              <Select\n                {...field}\n                options={timeOptions}\n                onChange={(value) => onChange(value?.value)}\n                width={15}\n                className={styles.timeUnit}\n              />\n            )}\n            control={control}\n          />\n        </div>\n      </Field>\n      {type === RuleFormType.cloudAlerting && dataSourceName && (\n        <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n      )}\n\n      <PreviewRule />\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  inlineField: css`\n    margin-bottom: 0;\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: flex-start;\n  `,\n  timeUnit: css`\n    margin-left: ${theme.spacing(0.5)};\n  `,\n});\n","import React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport function RecordingRulesNameSpaceAndGroupStep() {\n  const { watch } = useFormContext<RuleFormValues & { location?: string }>();\n\n  const dataSourceName = watch('dataSourceName');\n\n  if (!dataSourceName) {\n    return null;\n  }\n\n  return (\n    <RuleEditorSection\n      stepNo={3}\n      title={'Add namespace and group'}\n      description=\"Select the Namespace and Group for your recording rule.\"\n    >\n      <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n    </RuleEditorSection>\n  );\n}\n","import { css } from '@emotion/css';\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { DeepMap, FieldError, FormProvider, useForm, UseFormWatch } from 'react-hook-form';\nimport { Link, useParams } from 'react-router-dom';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Stack } from '@grafana/experimental';\nimport { config, logInfo } from '@grafana/runtime';\nimport { Button, ConfirmModal, CustomScrollbar, HorizontalGroup, Spinner, useStyles2 } from '@grafana/ui';\nimport { AppChromeUpdate } from 'app/core/components/AppChrome/AppChromeUpdate';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { contextSrv } from 'app/core/core';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { useQueryParams } from 'app/core/hooks/useQueryParams';\nimport { useDispatch } from 'app/types';\nimport { RuleWithLocation } from 'app/types/unified-alerting';\n\nimport { LogMessages, trackNewAlerRuleFormError } from '../../../Analytics';\nimport { useUnifiedAlertingSelector } from '../../../hooks/useUnifiedAlertingSelector';\nimport { deleteRuleAction, saveRuleFormAction } from '../../../state/actions';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { initialAsyncRequestState } from '../../../utils/redux';\nimport {\n  formValuesFromExistingRule,\n  getDefaultFormValues,\n  getDefaultQueries,\n  ignoreHiddenQueries,\n  MINUTE,\n  normalizeDefaultAnnotations,\n} from '../../../utils/rule-form';\nimport * as ruleId from '../../../utils/rule-id';\nimport { GrafanaRuleExporter } from '../../export/GrafanaRuleExporter';\nimport { AlertRuleNameInput } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { CloudEvaluationBehavior } from '../CloudEvaluationBehavior';\nimport { GrafanaEvaluationBehavior } from '../GrafanaEvaluationBehavior';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { RecordingRulesNameSpaceAndGroupStep } from '../RecordingRulesNameSpaceAndGroupStep';\nimport { RuleInspector } from '../RuleInspector';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\nimport { translateRouteParamToRuleType } from '../util';\n\ntype Props = {\n  existing?: RuleWithLocation;\n  prefill?: Partial<RuleFormValues>; // Existing implies we modify existing rule. Prefill only provides default form values\n};\n\nexport const AlertRuleForm = ({ existing, prefill }: Props) => {\n  const styles = useStyles2(getStyles);\n  const dispatch = useDispatch();\n  const notifyApp = useAppNotification();\n  const [queryParams] = useQueryParams();\n  const [showEditYaml, setShowEditYaml] = useState(false);\n  const [evaluateEvery, setEvaluateEvery] = useState(existing?.group.interval ?? MINUTE);\n\n  const routeParams = useParams<{ type: string; id: string }>();\n  const ruleType = translateRouteParamToRuleType(routeParams.type);\n  const uidFromParams = routeParams.id;\n\n  const returnTo = !queryParams['returnTo'] ? '/alerting/list' : String(queryParams['returnTo']);\n  const [showDeleteModal, setShowDeleteModal] = useState<boolean>(false);\n\n  const defaultValues: RuleFormValues = useMemo(() => {\n    if (existing) {\n      return formValuesFromExistingRule(existing);\n    }\n\n    if (prefill) {\n      return formValuesFromPrefill(prefill);\n    }\n\n    if (typeof queryParams['defaults'] === 'string') {\n      return formValuesFromQueryParams(queryParams['defaults'], ruleType);\n    }\n\n    return {\n      ...getDefaultFormValues(),\n      condition: 'C',\n      queries: getDefaultQueries(),\n      type: ruleType || RuleFormType.grafana,\n      evaluateEvery: evaluateEvery,\n    };\n  }, [existing, prefill, queryParams, evaluateEvery, ruleType]);\n\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues,\n    shouldFocusError: true,\n  });\n\n  const { handleSubmit, watch } = formAPI;\n\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  const showDataSourceDependantStep = Boolean(type && (type === RuleFormType.grafana || !!dataSourceName));\n\n  const submitState = useUnifiedAlertingSelector((state) => state.ruleForm.saveRule) || initialAsyncRequestState;\n  useCleanup((state) => (state.unifiedAlerting.ruleForm.saveRule = initialAsyncRequestState));\n\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  const submit = (values: RuleFormValues, exitOnSave: boolean) => {\n    if (conditionErrorMsg !== '') {\n      notifyApp.error(conditionErrorMsg);\n      return;\n    }\n\n    dispatch(\n      saveRuleFormAction({\n        values: {\n          ...defaultValues,\n          ...values,\n          annotations:\n            values.annotations\n              ?.map(({ key, value }) => ({ key: key.trim(), value: value.trim() }))\n              .filter(({ key, value }) => !!key && !!value) ?? [],\n          labels:\n            values.labels\n              ?.map(({ key, value }) => ({ key: key.trim(), value: value.trim() }))\n              .filter(({ key }) => !!key) ?? [],\n        },\n        existing,\n        redirectOnSave: exitOnSave ? returnTo : undefined,\n        initialAlertRuleName: defaultValues.name,\n        evaluateEvery: evaluateEvery,\n      })\n    );\n  };\n\n  const deleteRule = () => {\n    if (existing) {\n      const identifier = ruleId.fromRulerRule(\n        existing.ruleSourceName,\n        existing.namespace,\n        existing.group.name,\n        existing.rule\n      );\n\n      dispatch(deleteRuleAction(identifier, { navigateTo: '/alerting/list' }));\n    }\n  };\n\n  const onInvalid = (errors: DeepMap<RuleFormValues, FieldError>): void => {\n    if (!existing) {\n      trackNewAlerRuleFormError({\n        grafana_version: config.buildInfo.version,\n        org_id: contextSrv.user.orgId,\n        user_id: contextSrv.user.id,\n        error: Object.keys(errors).toString(),\n      });\n    }\n    notifyApp.error('There are errors in the form. Please correct them and try again!');\n  };\n\n  const cancelRuleCreation = () => {\n    logInfo(LogMessages.cancelSavingAlertRule);\n  };\n  const evaluateEveryInForm = watch('evaluateEvery');\n  useEffect(() => setEvaluateEvery(evaluateEveryInForm), [evaluateEveryInForm]);\n\n  const actionButtons = (\n    <HorizontalGroup height=\"auto\" justify=\"flex-end\">\n      {existing && (\n        <Button\n          variant=\"primary\"\n          type=\"button\"\n          size=\"sm\"\n          onClick={handleSubmit((values) => submit(values, false), onInvalid)}\n          disabled={submitState.loading}\n        >\n          {submitState.loading && <Spinner className={styles.buttonSpinner} inline={true} />}\n          Save rule\n        </Button>\n      )}\n      <Button\n        variant=\"primary\"\n        type=\"button\"\n        size=\"sm\"\n        onClick={handleSubmit((values) => submit(values, true), onInvalid)}\n        disabled={submitState.loading}\n      >\n        {submitState.loading && <Spinner className={styles.buttonSpinner} inline={true} />}\n        Save rule and exit\n      </Button>\n      <Link to={returnTo}>\n        <Button variant=\"secondary\" disabled={submitState.loading} type=\"button\" onClick={cancelRuleCreation} size=\"sm\">\n          Cancel\n        </Button>\n      </Link>\n      {existing ? (\n        <Button fill=\"outline\" variant=\"destructive\" type=\"button\" onClick={() => setShowDeleteModal(true)} size=\"sm\">\n          Delete\n        </Button>\n      ) : null}\n\n      {existing && isCortexLokiOrRecordingRule(watch) && (\n        <Button\n          variant=\"secondary\"\n          type=\"button\"\n          onClick={() => setShowEditYaml(true)}\n          disabled={submitState.loading}\n          size=\"sm\"\n        >\n          Edit YAML\n        </Button>\n      )}\n    </HorizontalGroup>\n  );\n\n  return (\n    <FormProvider {...formAPI}>\n      <AppChromeUpdate actions={actionButtons} />\n      <form onSubmit={(e) => e.preventDefault()} className={styles.form}>\n        <div className={styles.contentOuter}>\n          <CustomScrollbar autoHeightMin=\"100%\" hideHorizontalTrack={true}>\n            <Stack direction=\"column\" gap={3}>\n              {/* Step 1 */}\n              <AlertRuleNameInput />\n              {/* Step 2 */}\n              <QueryAndExpressionsStep editingExistingRule={!!existing} onDataChange={checkAlertCondition} />\n              {/* Step 3-4-5 */}\n              {showDataSourceDependantStep && (\n                <>\n                  {/* Step 3 */}\n                  {type === RuleFormType.grafana && (\n                    <GrafanaEvaluationBehavior\n                      evaluateEvery={evaluateEvery}\n                      setEvaluateEvery={setEvaluateEvery}\n                      existing={Boolean(existing)}\n                      enableProvisionedGroups={false}\n                    />\n                  )}\n\n                  {type === RuleFormType.cloudAlerting && <CloudEvaluationBehavior />}\n\n                  {type === RuleFormType.cloudRecording && <RecordingRulesNameSpaceAndGroupStep />}\n\n                  {/* Step 4 & 5 */}\n                  {/* Annotations only for cloud and Grafana */}\n                  {type !== RuleFormType.cloudRecording && <AnnotationsStep />}\n                  {/* Notifications step*/}\n                  <NotificationsStep alertUid={uidFromParams} />\n                </>\n              )}\n            </Stack>\n          </CustomScrollbar>\n        </div>\n      </form>\n      {showDeleteModal ? (\n        <ConfirmModal\n          isOpen={true}\n          title=\"Delete rule\"\n          body=\"Deleting this rule will permanently remove it. Are you sure you want to delete this rule?\"\n          confirmText=\"Yes, delete\"\n          icon=\"exclamation-triangle\"\n          onConfirm={deleteRule}\n          onDismiss={() => setShowDeleteModal(false)}\n        />\n      ) : null}\n      {showEditYaml ? (\n        type === RuleFormType.grafana ? (\n          <GrafanaRuleExporter alertUid={uidFromParams} onClose={() => setShowEditYaml(false)} />\n        ) : (\n          <RuleInspector onClose={() => setShowEditYaml(false)} />\n        )\n      ) : null}\n    </FormProvider>\n  );\n};\n\nconst isCortexLokiOrRecordingRule = (watch: UseFormWatch<RuleFormValues>) => {\n  const [ruleType, dataSourceName] = watch(['type', 'dataSourceName']);\n\n  return (ruleType === RuleFormType.cloudAlerting || ruleType === RuleFormType.cloudRecording) && dataSourceName !== '';\n};\n\nfunction formValuesFromQueryParams(ruleDefinition: string, type: RuleFormType): RuleFormValues {\n  let ruleFromQueryParams: Partial<RuleFormValues>;\n\n  try {\n    ruleFromQueryParams = JSON.parse(ruleDefinition);\n  } catch (err) {\n    return {\n      ...getDefaultFormValues(),\n      queries: getDefaultQueries(),\n    };\n  }\n\n  return ignoreHiddenQueries({\n    ...getDefaultFormValues(),\n    ...ruleFromQueryParams,\n    annotations: normalizeDefaultAnnotations(ruleFromQueryParams.annotations ?? []),\n    queries: ruleFromQueryParams.queries ?? getDefaultQueries(),\n    type: type || RuleFormType.grafana,\n    evaluateEvery: MINUTE,\n  });\n}\n\nfunction formValuesFromPrefill(rule: Partial<RuleFormValues>): RuleFormValues {\n  return ignoreHiddenQueries({\n    ...getDefaultFormValues(),\n    ...rule,\n  });\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  buttonSpinner: css({\n    marginRight: theme.spacing(1),\n  }),\n  form: css({\n    width: '100%',\n    height: '100%',\n    display: 'flex',\n    flexDirection: 'column',\n  }),\n  contentOuter: css({\n    background: theme.colors.background.primary,\n    overflow: 'hidden',\n    flex: 1,\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n  }),\n});\n","import { cloneDeep } from 'lodash';\nimport React from 'react';\nimport { useAsync } from 'react-use';\n\nimport { locationService } from '@grafana/runtime/src';\nimport { Alert, LoadingPlaceholder } from '@grafana/ui/src';\n\nimport { useDispatch } from '../../../types';\nimport { RuleIdentifier, RuleWithLocation } from '../../../types/unified-alerting';\nimport { RulerRuleDTO } from '../../../types/unified-alerting-dto';\n\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { fetchEditableRuleAction } from './state/actions';\nimport { generateCopiedName } from './utils/duplicate';\nimport { rulerRuleToFormValues } from './utils/rule-form';\nimport { getRuleName, isAlertingRulerRule, isGrafanaRulerRule, isRecordingRulerRule } from './utils/rules';\nimport { createUrl } from './utils/url';\n\nexport function CloneRuleEditor({ sourceRuleId }: { sourceRuleId: RuleIdentifier }) {\n  const dispatch = useDispatch();\n\n  const {\n    loading,\n    value: rule,\n    error,\n  } = useAsync(() => dispatch(fetchEditableRuleAction(sourceRuleId)).unwrap(), [sourceRuleId]);\n\n  if (loading) {\n    return <LoadingPlaceholder text=\"Loading the rule\" />;\n  }\n\n  if (rule) {\n    const ruleClone = cloneRuleDefinition(rule);\n    const formPrefill = rulerRuleToFormValues(ruleClone);\n\n    return <AlertRuleForm prefill={formPrefill} />;\n  }\n\n  if (error) {\n    return (\n      <Alert title=\"Error\" severity=\"error\">\n        {error.message}\n      </Alert>\n    );\n  }\n\n  return (\n    <Alert\n      title=\"Cannot copy the rule. The rule does not exist\"\n      buttonContent=\"Go back to alert list\"\n      onRemove={() => locationService.replace(createUrl('/alerting/list'))}\n    />\n  );\n}\n\nfunction changeRuleName(rule: RulerRuleDTO, newName: string) {\n  if (isGrafanaRulerRule(rule)) {\n    rule.grafana_alert.title = newName;\n  }\n  if (isAlertingRulerRule(rule)) {\n    rule.alert = newName;\n  }\n\n  if (isRecordingRulerRule(rule)) {\n    rule.record = newName;\n  }\n}\n\nexport function cloneRuleDefinition(rule: RuleWithLocation<RulerRuleDTO>) {\n  const ruleClone = cloneDeep(rule);\n  changeRuleName(\n    ruleClone.rule,\n    generateCopiedName(getRuleName(ruleClone.rule), ruleClone.group.rules.map(getRuleName))\n  );\n\n  if (isGrafanaRulerRule(ruleClone.rule)) {\n    ruleClone.rule.grafana_alert.uid = '';\n\n    // Provisioned alert rules have provisioned alert group which cannot be used in UI\n    if (Boolean(ruleClone.rule.grafana_alert.provenance)) {\n      ruleClone.group = { name: '', rules: ruleClone.group.rules };\n    }\n  }\n\n  return ruleClone;\n}\n","import React, { useEffect } from 'react';\n\nimport { Alert, LoadingPlaceholder } from '@grafana/ui';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { useDispatch } from 'app/types';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\n\nimport { AlertWarning } from './AlertWarning';\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useIsRuleEditable } from './hooks/useIsRuleEditable';\nimport { useUnifiedAlertingSelector } from './hooks/useUnifiedAlertingSelector';\nimport { fetchEditableRuleAction } from './state/actions';\nimport { initialAsyncRequestState } from './utils/redux';\nimport * as ruleId from './utils/rule-id';\n\ninterface ExistingRuleEditorProps {\n  identifier: RuleIdentifier;\n  id?: string;\n}\n\nexport function ExistingRuleEditor({ identifier, id }: ExistingRuleEditorProps) {\n  useCleanup((state) => (state.unifiedAlerting.ruleForm.existingRule = initialAsyncRequestState));\n\n  const {\n    loading: loadingAlertRule,\n    result,\n    error,\n    dispatched,\n  } = useUnifiedAlertingSelector((state) => state.ruleForm.existingRule);\n\n  const dispatch = useDispatch();\n  const { isEditable, loading: loadingEditable } = useIsRuleEditable(\n    ruleId.ruleIdentifierToRuleSourceName(identifier),\n    result?.rule\n  );\n\n  const loading = loadingAlertRule || loadingEditable;\n\n  useEffect(() => {\n    if (!dispatched) {\n      dispatch(fetchEditableRuleAction(identifier));\n    }\n  }, [dispatched, dispatch, identifier]);\n\n  if (loading || isEditable === undefined) {\n    return <LoadingPlaceholder text=\"Loading rule...\" />;\n  }\n\n  if (error) {\n    return (\n      <Alert severity=\"error\" title=\"Failed to load rule\">\n        {error.message}\n      </Alert>\n    );\n  }\n\n  if (!result) {\n    return <AlertWarning title=\"Rule not found\">Sorry! This rule does not exist.</AlertWarning>;\n  }\n\n  if (isEditable === false) {\n    return <AlertWarning title=\"Cannot edit rule\">Sorry! You do not have permission to edit this rule.</AlertWarning>;\n  }\n\n  return <AlertRuleForm existing={result} />;\n}\n","import React, { useCallback } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { NavModelItem } from '@grafana/data';\nimport { withErrorBoundary } from '@grafana/ui';\nimport { GrafanaRouteComponentProps } from 'app/core/navigation/types';\nimport { useDispatch } from 'app/types';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\n\nimport { AlertWarning } from './AlertWarning';\nimport { CloneRuleEditor } from './CloneRuleEditor';\nimport { ExistingRuleEditor } from './ExistingRuleEditor';\nimport { AlertingPageWrapper } from './components/AlertingPageWrapper';\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useURLSearchParams } from './hooks/useURLSearchParams';\nimport { fetchRulesSourceBuildInfoAction } from './state/actions';\nimport { useRulesAccess } from './utils/accessControlHooks';\nimport * as ruleId from './utils/rule-id';\n\ntype RuleEditorProps = GrafanaRouteComponentProps<{ id?: string; type?: 'recording' | 'alerting' }>;\n\nconst defaultPageNav: Partial<NavModelItem> = {\n  icon: 'bell',\n  id: 'alert-rule-view',\n};\n\n// sadly we only get the \"type\" when a new rule is being created, when editing an existing recording rule we can't actually know it from the URL\nconst getPageNav = (identifier?: RuleIdentifier, type?: 'recording' | 'alerting') => {\n  if (type === 'recording') {\n    if (identifier) {\n      // this branch should never trigger actually, the type param isn't used when editing rules\n      return { ...defaultPageNav, id: 'alert-rule-edit', text: 'Edit recording rule' };\n    } else {\n      return { ...defaultPageNav, id: 'alert-rule-add', text: 'New recording rule' };\n    }\n  }\n\n  if (identifier) {\n    // keep this one ambiguous, don't mentiond a specific alert type here\n    return { ...defaultPageNav, id: 'alert-rule-edit', text: 'Edit rule' };\n  } else {\n    return { ...defaultPageNav, id: 'alert-rule-add', text: 'New alert rule' };\n  }\n};\n\nconst RuleEditor = ({ match }: RuleEditorProps) => {\n  const dispatch = useDispatch();\n  const [searchParams] = useURLSearchParams();\n\n  const { id, type } = match.params;\n  const identifier = ruleId.tryParse(id, true);\n\n  const copyFromId = searchParams.get('copyFrom') ?? undefined;\n  const copyFromIdentifier = ruleId.tryParse(copyFromId);\n\n  const { loading = true } = useAsync(async () => {\n    if (identifier) {\n      await dispatch(fetchRulesSourceBuildInfoAction({ rulesSourceName: identifier.ruleSourceName }));\n    }\n    if (copyFromIdentifier) {\n      await dispatch(fetchRulesSourceBuildInfoAction({ rulesSourceName: copyFromIdentifier.ruleSourceName }));\n    }\n  }, [dispatch]);\n\n  const { canCreateGrafanaRules, canCreateCloudRules, canEditRules } = useRulesAccess();\n\n  const getContent = useCallback(() => {\n    if (loading) {\n      return;\n    }\n\n    if (!identifier && !canCreateGrafanaRules && !canCreateCloudRules) {\n      return <AlertWarning title=\"Cannot create rules\">Sorry! You are not allowed to create rules.</AlertWarning>;\n    }\n\n    if (identifier && !canEditRules(identifier.ruleSourceName)) {\n      return <AlertWarning title=\"Cannot edit rules\">Sorry! You are not allowed to edit rules.</AlertWarning>;\n    }\n\n    if (identifier) {\n      return <ExistingRuleEditor key={id} identifier={identifier} id={id} />;\n    }\n\n    if (copyFromIdentifier) {\n      return <CloneRuleEditor sourceRuleId={copyFromIdentifier} />;\n    }\n    // new alert rule\n    return <AlertRuleForm />;\n  }, [canCreateCloudRules, canCreateGrafanaRules, canEditRules, copyFromIdentifier, id, identifier, loading]);\n\n  return (\n    <AlertingPageWrapper isLoading={loading} pageId=\"alert-list\" pageNav={getPageNav(identifier, type)}>\n      {getContent()}\n    </AlertingPageWrapper>\n  );\n};\n\nexport default withErrorBoundary(RuleEditor, { style: 'page' });\n","import React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport { FormProvider, useForm } from 'react-hook-form';\nimport { useAsync } from 'react-use';\n\nimport { Stack } from '@grafana/experimental';\nimport { Button, CustomScrollbar, LinkButton, LoadingPlaceholder } from '@grafana/ui';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { useQueryParams } from 'app/core/hooks/useQueryParams';\n\nimport { AppChromeUpdate } from '../../../../../../core/components/AppChrome/AppChromeUpdate';\nimport { RulerRuleDTO, RulerRuleGroupDTO } from '../../../../../../types/unified-alerting-dto';\nimport { alertRuleApi, ModifyExportPayload } from '../../../api/alertRuleApi';\nimport { fetchRulerRulesGroup } from '../../../api/ruler';\nimport { useDataSourceFeatures } from '../../../hooks/useCombinedRule';\nimport { RuleFormValues } from '../../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../../utils/datasource';\nimport { formValuesToRulerGrafanaRuleDTO, MINUTE } from '../../../utils/rule-form';\nimport { isGrafanaRulerRule } from '../../../utils/rules';\nimport { FileExportPreview } from '../../export/FileExportPreview';\nimport { GrafanaExportDrawer } from '../../export/GrafanaExportDrawer';\nimport { allGrafanaExportProviders, ExportFormats } from '../../export/providers';\nimport { AlertRuleNameInput } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { GrafanaEvaluationBehavior } from '../GrafanaEvaluationBehavior';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\n\ninterface ModifyExportRuleFormProps {\n  alertUid: string;\n  ruleForm?: RuleFormValues;\n}\n\nexport function ModifyExportRuleForm({ ruleForm, alertUid }: ModifyExportRuleFormProps) {\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues: ruleForm,\n    shouldFocusError: true,\n  });\n  const [queryParams] = useQueryParams();\n\n  const existing = Boolean(ruleForm); // always should be true\n  const notifyApp = useAppNotification();\n  const returnTo = !queryParams['returnTo'] ? '/alerting/list' : String(queryParams['returnTo']);\n\n  const [exportData, setExportData] = useState<RuleFormValues | undefined>(undefined);\n\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n  const [evaluateEvery, setEvaluateEvery] = useState(ruleForm?.evaluateEvery ?? MINUTE);\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  const submit = (exportData: RuleFormValues | undefined) => {\n    if (conditionErrorMsg !== '') {\n      notifyApp.error(conditionErrorMsg);\n      return;\n    }\n    setExportData(exportData);\n  };\n\n  const onClose = useCallback(() => {\n    setExportData(undefined);\n  }, [setExportData]);\n\n  const actionButtons = [\n    <LinkButton href={returnTo} key=\"cancel\" size=\"sm\" variant=\"secondary\" onClick={() => submit(undefined)}>\n      Cancel\n    </LinkButton>,\n    <Button key=\"export-rule\" size=\"sm\" onClick={formAPI.handleSubmit((formValues) => submit(formValues))}>\n      Export\n    </Button>,\n  ];\n\n  return (\n    <>\n      <FormProvider {...formAPI}>\n        <AppChromeUpdate actions={actionButtons} />\n        <form onSubmit={(e) => e.preventDefault()}>\n          <div>\n            <CustomScrollbar autoHeightMin=\"100%\" hideHorizontalTrack={true}>\n              <Stack direction=\"column\" gap={3}>\n                {/* Step 1 */}\n                <AlertRuleNameInput />\n                {/* Step 2 */}\n                <QueryAndExpressionsStep editingExistingRule={existing} onDataChange={checkAlertCondition} />\n                {/* Step 3-4-5 */}\n\n                <GrafanaEvaluationBehavior\n                  evaluateEvery={evaluateEvery}\n                  setEvaluateEvery={setEvaluateEvery}\n                  existing={Boolean(existing)}\n                  enableProvisionedGroups={true}\n                />\n\n                {/* Step 4 & 5 */}\n                {/* Annotations only for cloud and Grafana */}\n                <AnnotationsStep />\n                {/* Notifications step*/}\n                <NotificationsStep alertUid={alertUid} />\n              </Stack>\n            </CustomScrollbar>\n          </div>\n        </form>\n        {exportData && <GrafanaRuleDesignExporter exportValues={exportData} onClose={onClose} uid={alertUid} />}\n      </FormProvider>\n    </>\n  );\n}\n\nconst useGetGroup = (nameSpace: string, group: string) => {\n  const { dsFeatures } = useDataSourceFeatures(GRAFANA_RULES_SOURCE_NAME);\n\n  const rulerConfig = dsFeatures?.rulerConfig;\n\n  const targetGroup = useAsync(async () => {\n    return rulerConfig ? await fetchRulerRulesGroup(rulerConfig, nameSpace, group) : undefined;\n  }, [rulerConfig, nameSpace, group]);\n\n  return targetGroup;\n};\n\ninterface GrafanaRuleDesignExportPreviewProps {\n  exportFormat: ExportFormats;\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid: string;\n}\nexport const getPayloadToExport = (\n  uid: string,\n  formValues: RuleFormValues,\n  existingGroup: RulerRuleGroupDTO<RulerRuleDTO> | null | undefined\n): ModifyExportPayload => {\n  const grafanaRuleDto = formValuesToRulerGrafanaRuleDTO(formValues);\n\n  const updatedRule = { ...grafanaRuleDto, grafana_alert: { ...grafanaRuleDto.grafana_alert, uid: uid } };\n  if (existingGroup?.rules) {\n    // we have to update the rule in the group in the same position if it exists, otherwise we have to add it at the end\n    let alreadyExistsInGroup = false;\n    const updatedRules = existingGroup.rules.map((rule: RulerRuleDTO) => {\n      if (isGrafanaRulerRule(rule) && rule.grafana_alert.uid === uid) {\n        alreadyExistsInGroup = true;\n        return updatedRule;\n      } else {\n        return rule;\n      }\n    });\n    if (!alreadyExistsInGroup) {\n      // we have to add the updated rule at the end of the group\n      updatedRules.push(updatedRule);\n    }\n    return {\n      ...existingGroup,\n      rules: updatedRules,\n    };\n  } else {\n    // we have to create a new group with the updated rule\n    return {\n      name: existingGroup?.name ?? '',\n      rules: [updatedRule],\n    };\n  }\n};\n\nconst useGetPayloadToExport = (values: RuleFormValues, uid: string) => {\n  const rulerGroupDto = useGetGroup(values.folder?.title ?? '', values.group);\n  const payload: ModifyExportPayload = useMemo(() => {\n    return getPayloadToExport(uid, values, rulerGroupDto?.value);\n  }, [uid, rulerGroupDto, values]);\n  return { payload, loadingGroup: rulerGroupDto.loading };\n};\n\nconst GrafanaRuleDesignExportPreview = ({\n  exportFormat,\n  exportValues,\n  onClose,\n  uid,\n}: GrafanaRuleDesignExportPreviewProps) => {\n  const [getExport, exportData] = alertRuleApi.endpoints.exportModifiedRuleGroup.useMutation();\n  const { loadingGroup, payload } = useGetPayloadToExport(exportValues, uid);\n\n  const nameSpace = exportValues.folder?.title ?? '';\n\n  useEffect(() => {\n    !loadingGroup && getExport({ payload, format: exportFormat, nameSpace: nameSpace });\n  }, [nameSpace, exportFormat, payload, getExport, loadingGroup]);\n\n  if (exportData.isLoading) {\n    return <LoadingPlaceholder text=\"Loading....\" />;\n  }\n\n  const downloadFileName = `modify-export-${payload.name}-${uid}-${new Date().getTime()}`;\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={exportData.data ?? ''}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRuleDesignExporterProps {\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid: string;\n}\n\nexport const GrafanaRuleDesignExporter = React.memo(\n  ({ onClose, exportValues, uid }: GrafanaRuleDesignExporterProps) => {\n    const [activeTab, setActiveTab] = useState<ExportFormats>('yaml');\n\n    return (\n      <GrafanaExportDrawer\n        title={'Export Group'}\n        activeTab={activeTab}\n        onTabChange={setActiveTab}\n        onClose={onClose}\n        formatProviders={Object.values(allGrafanaExportProviders)}\n      >\n        <GrafanaRuleDesignExportPreview\n          exportFormat={activeTab}\n          onClose={onClose}\n          exportValues={exportValues}\n          uid={uid}\n        />\n      </GrafanaExportDrawer>\n    );\n  }\n);\n\nGrafanaRuleDesignExporter.displayName = 'GrafanaRuleDesignExporter';\n","import * as React from 'react';\nimport { useEffect, useState } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { locationService } from '@grafana/runtime';\nimport { Alert, LoadingPlaceholder } from '@grafana/ui';\n\nimport { GrafanaRouteComponentProps } from '../../../../../core/navigation/types';\nimport { useDispatch } from '../../../../../types';\nimport { RuleIdentifier } from '../../../../../types/unified-alerting';\nimport { fetchEditableRuleAction, fetchRulesSourceBuildInfoAction } from '../../state/actions';\nimport { formValuesFromExistingRule } from '../../utils/rule-form';\nimport * as ruleId from '../../utils/rule-id';\nimport { isGrafanaRulerRule } from '../../utils/rules';\nimport { createUrl } from '../../utils/url';\nimport { AlertingPageWrapper } from '../AlertingPageWrapper';\nimport { ModifyExportRuleForm } from '../rule-editor/alert-rule-form/ModifyExportRuleForm';\n\ninterface GrafanaModifyExportProps extends GrafanaRouteComponentProps<{ id?: string }> {}\n\nexport default function GrafanaModifyExport({ match }: GrafanaModifyExportProps) {\n  const dispatch = useDispatch();\n\n  // Get rule source build info\n  const [ruleIdentifier, setRuleIdentifier] = useState<RuleIdentifier | undefined>(undefined);\n\n  useEffect(() => {\n    const identifier = ruleId.tryParse(match.params.id, true);\n    setRuleIdentifier(identifier);\n  }, [match.params.id]);\n\n  const { loading: loadingBuildInfo = true } = useAsync(async () => {\n    if (ruleIdentifier) {\n      await dispatch(fetchRulesSourceBuildInfoAction({ rulesSourceName: ruleIdentifier.ruleSourceName }));\n    }\n  }, [dispatch, ruleIdentifier]);\n\n  // Get rule\n  const {\n    loading,\n    value: alertRule,\n    error,\n  } = useAsync(async () => {\n    if (!ruleIdentifier) {\n      return;\n    }\n    return await dispatch(fetchEditableRuleAction(ruleIdentifier)).unwrap();\n  }, [ruleIdentifier, loadingBuildInfo]);\n\n  if (!ruleIdentifier) {\n    return <div>Rule not found</div>;\n  }\n\n  if (loading) {\n    return <LoadingPlaceholder text=\"Loading the rule\" />;\n  }\n\n  if (error) {\n    return (\n      <Alert title=\"Cannot load modify export\" severity=\"error\">\n        {error.message}\n      </Alert>\n    );\n  }\n\n  if (!alertRule && !loading && !loadingBuildInfo) {\n    // alert rule does not exist\n    return (\n      <AlertingPageWrapper isLoading={loading} pageId=\"alert-list\" pageNav={{ text: 'Modify export' }}>\n        <Alert\n          title=\"Cannot load the rule. The rule does not exist\"\n          buttonContent=\"Go back to alert list\"\n          onRemove={() => locationService.replace(createUrl('/alerting/list'))}\n        />\n      </AlertingPageWrapper>\n    );\n  }\n\n  if (alertRule && !isGrafanaRulerRule(alertRule.rule)) {\n    // alert rule exists but is not a grafana-managed rule\n    return (\n      <AlertingPageWrapper isLoading={loading} pageId=\"alert-list\" pageNav={{ text: 'Modify export' }}>\n        <Alert\n          title=\"This rule is not a Grafana-managed alert rule\"\n          buttonContent=\"Go back to alert list\"\n          onRemove={() => locationService.replace(createUrl('/alerting/list'))}\n        />\n      </AlertingPageWrapper>\n    );\n  }\n\n  return (\n    <AlertingPageWrapper\n      isLoading={loading}\n      pageId=\"alert-list\"\n      pageNav={{\n        text: 'Modify export',\n        subTitle:\n          'Modify the current alert rule and export the rule definition in the format of your choice. Any changes you make will not be saved.',\n      }}\n    >\n      {alertRule && (\n        <ModifyExportRuleForm ruleForm={formValuesFromExistingRule(alertRule)} alertUid={match.params.id ?? ''} />\n      )}\n    </AlertingPageWrapper>\n  );\n}\n","import React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { Field, Input, Text } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\n\nimport { RuleEditorSection } from './RuleEditorSection';\n\nconst recordingRuleNameValidationPattern = {\n  message:\n    'Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.',\n  value: /^[a-zA-Z_:][a-zA-Z0-9_:]*$/,\n};\n\nexport const AlertRuleNameInput = () => {\n  const {\n    register,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues & { location?: string }>();\n\n  const ruleFormType = watch('type');\n  const entityName = ruleFormType === RuleFormType.cloudRecording ? 'recording rule' : 'alert rule';\n\n  return (\n    <RuleEditorSection\n      stepNo={1}\n      title={`Enter ${entityName} name`}\n      description={\n        <Text variant=\"bodySmall\" color=\"secondary\">\n          Enter a name to identify your {entityName}.\n        </Text>\n      }\n    >\n      <Field label=\"Name\" error={errors?.name?.message} invalid={!!errors.name?.message}>\n        <Input\n          id=\"name\"\n          width={35}\n          {...register('name', {\n            required: { value: true, message: 'Must enter a name' },\n            pattern: ruleFormType === RuleFormType.cloudRecording ? recordingRuleNameValidationPattern : undefined,\n          })}\n          aria-label=\"name\"\n          placeholder={`Give your ${entityName} a name`}\n        />\n      </Field>\n    </RuleEditorSection>\n  );\n};\n","import { AlertmanagerChoice } from '../../../../../../plugins/datasource/alertmanager/types';\nimport { alertmanagerApi } from '../../../api/alertmanagerApi';\nimport { getExternalDsAlertManagers, GRAFANA_RULES_SOURCE_NAME } from '../../../utils/datasource';\n\nexport interface AlertManagerNameWithImage {\n  name: string;\n  img: string;\n}\n\nexport const useGetAlertManagersSourceNamesAndImage = () => {\n  //get current alerting config\n  const { currentData: amConfigStatus } = alertmanagerApi.useGetAlertmanagerChoiceStatusQuery(undefined);\n\n  const externalDsAlertManagers = getExternalDsAlertManagers().map((ds) => ({\n    name: ds.name,\n    img: ds.meta.info.logos.small,\n  }));\n\n  const alertmanagerChoice = amConfigStatus?.alertmanagersChoice;\n  const alertManagerSourceNamesWithImage: AlertManagerNameWithImage[] =\n    alertmanagerChoice === AlertmanagerChoice.Internal\n      ? [{ name: GRAFANA_RULES_SOURCE_NAME, img: 'public/img/grafana_icon.svg' }]\n      : alertmanagerChoice === AlertmanagerChoice.External\n      ? externalDsAlertManagers\n      : [{ name: GRAFANA_RULES_SOURCE_NAME, img: 'public/img/grafana_icon.svg' }, ...externalDsAlertManagers];\n\n  return alertManagerSourceNamesWithImage;\n};\n","import { css } from '@emotion/css';\nimport { compact } from 'lodash';\nimport React, { lazy, Suspense } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, LoadingPlaceholder, useStyles2, Text } from '@grafana/ui';\nimport { alertRuleApi } from 'app/features/alerting/unified/api/alertRuleApi';\nimport { Stack } from 'app/plugins/datasource/parca/QueryEditor/Stack';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { Folder } from '../RuleFolderPicker';\n\nimport { useGetAlertManagersSourceNamesAndImage } from './useGetAlertManagersSourceNamesAndImage';\n\nconst NotificationPreviewByAlertManager = lazy(() => import('./NotificationPreviewByAlertManager'));\n\ninterface NotificationPreviewProps {\n  customLabels: Array<{\n    key: string;\n    value: string;\n  }>;\n  alertQueries: AlertQuery[];\n  condition: string | null;\n  folder: Folder | null;\n  alertName?: string;\n  alertUid?: string;\n}\n\n// TODO the scroll position keeps resetting when we preview\n// this is to be expected because the list of routes dissapears as we start the request but is very annoying\nexport const NotificationPreview = ({\n  alertQueries,\n  customLabels,\n  condition,\n  folder,\n  alertName,\n  alertUid,\n}: NotificationPreviewProps) => {\n  const styles = useStyles2(getStyles);\n  const disabled = !condition || !folder;\n\n  const previewEndpoint = alertRuleApi.endpoints.preview;\n\n  const [trigger, { data = [], isLoading, isUninitialized: previewUninitialized }] = previewEndpoint.useMutation();\n\n  // potential instances are the instances that are going to be routed to the notification policies\n  // convert data to list of labels: are the representation of the potential instances\n  const potentialInstances = compact(data.flatMap((label) => label?.labels));\n\n  const onPreview = () => {\n    if (!folder || !condition) {\n      return;\n    }\n\n    // Get the potential labels given the alert queries, the condition and the custom labels (autogenerated labels are calculated on the BE side)\n    trigger({\n      alertQueries: alertQueries,\n      condition: condition,\n      customLabels: customLabels,\n      folder: folder,\n      alertName: alertName,\n      alertUid: alertUid,\n    });\n  };\n\n  // Get list of alert managers source name + image\n  const alertManagerSourceNamesAndImage = useGetAlertManagersSourceNamesAndImage();\n\n  const onlyOneAM = alertManagerSourceNamesAndImage.length === 1;\n\n  return (\n    <Stack direction=\"column\">\n      <div className={styles.routePreviewHeaderRow}>\n        <div className={styles.previewHeader}>\n          <Text element=\"h4\">Alert instance routing preview</Text>\n          {isLoading && previewUninitialized && (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              Loading...\n            </Text>\n          )}\n          {previewUninitialized ? (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              When you have your folder selected and your query and labels are configured, click &quot;Preview\n              routing&quot; to see the results here.\n            </Text>\n          ) : (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              Based on the labels added, alert instances are routed to the following notification policies. Expand each\n              notification policy below to view more details.\n            </Text>\n          )}\n        </div>\n        <div className={styles.button}>\n          <Button icon=\"sync\" variant=\"secondary\" type=\"button\" onClick={onPreview} disabled={disabled}>\n            Preview routing\n          </Button>\n        </div>\n      </div>\n      {!isLoading && !previewUninitialized && potentialInstances.length > 0 && (\n        <Suspense fallback={<LoadingPlaceholder text=\"Loading preview...\" />}>\n          {alertManagerSourceNamesAndImage.map((alertManagerSource) => (\n            <NotificationPreviewByAlertManager\n              alertManagerSource={alertManagerSource}\n              potentialInstances={potentialInstances}\n              onlyOneAM={onlyOneAM}\n              key={alertManagerSource.name}\n            />\n          ))}\n        </Suspense>\n      )}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  collapsableSection: css`\n    width: auto;\n    border: 0;\n  `,\n  previewHeader: css`\n    margin: 0;\n  `,\n  routePreviewHeaderRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: space-between;\n    align-items: flex-start;\n  `,\n  collapseLabel: css`\n    flex: 1;\n  `,\n  button: css`\n    justify-content: flex-end;\n  `,\n  tagsInDetails: css`\n    display: flex;\n    justify-content: flex-start;\n    flex-wrap: wrap;\n  `,\n  policyPathItemMatchers: css`\n    display: flex;\n    flex-direction: row;\n    gap: ${theme.spacing(1)};\n  `,\n});\n","import React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { Stack } from '@grafana/experimental';\nimport { Icon, Text } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../utils/datasource';\n\nimport LabelsField from './LabelsField';\nimport { NeedHelpInfo } from './NeedHelpInfo';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { NotificationPreview } from './notificaton-preview/NotificationPreview';\n\ntype NotificationsStepProps = {\n  alertUid?: string;\n};\nexport const NotificationsStep = ({ alertUid }: NotificationsStepProps) => {\n  const { watch } = useFormContext<RuleFormValues & { location?: string }>();\n\n  const [type, labels, queries, condition, folder, alertName] = watch([\n    'type',\n    'labels',\n    'queries',\n    'condition',\n    'folder',\n    'name',\n  ]);\n\n  const dataSourceName = watch('dataSourceName') ?? GRAFANA_RULES_SOURCE_NAME;\n\n  const shouldRenderPreview = type === RuleFormType.grafana;\n\n  const NotificationsStepDescription = () => {\n    return (\n      <Stack direction=\"row\" gap={0.5} alignItems=\"baseline\">\n        <Text variant=\"bodySmall\" color=\"secondary\">\n          Add custom labels to change the way your notifications are routed.\n        </Text>\n        <NeedHelpInfo\n          contentText={\n            <Stack gap={1}>\n              <Stack direction=\"row\" gap={0}>\n                <>\n                  Firing alert rule instances are routed to notification policies based on matching labels. All alert\n                  rules and instances, irrespective of their labels, match the default notification policy. If there are\n                  no nested policies, or no nested policies match the labels in the alert rule or alert instance, then\n                  the default notification policy is the matching policy.\n                </>\n                <a\n                  href={`https://grafana.com/docs/grafana/latest/alerting/fundamentals/notification-policies/notifications/`}\n                  target=\"_blank\"\n                  rel=\"noreferrer\"\n                >\n                  <Text color=\"link\">\n                    Read about notification routing. <Icon name=\"external-link-alt\" />\n                  </Text>\n                </a>\n              </Stack>\n              <Stack direction=\"row\" gap={0}>\n                <>\n                  Custom labels change the way your notifications are routed. First, add labels to your alert rule and\n                  then connect them to your notification policy by adding label matchers.\n                </>\n                <a\n                  href={`https://grafana.com/docs/grafana/latest/alerting/fundamentals/annotation-label/`}\n                  target=\"_blank\"\n                  rel=\"noreferrer\"\n                >\n                  <Text color=\"link\">\n                    Read about Labels and annotations. <Icon name=\"external-link-alt\" />\n                  </Text>\n                </a>\n              </Stack>\n            </Stack>\n          }\n          title=\"Notification routing\"\n        />\n      </Stack>\n    );\n  };\n\n  return (\n    <RuleEditorSection\n      stepNo={type === RuleFormType.cloudRecording ? 4 : 5}\n      title={type === RuleFormType.cloudRecording ? 'Add labels' : 'Configure notifications'}\n      description={\n        <Stack direction=\"row\" gap={0.5} alignItems=\"baseline\">\n          {type === RuleFormType.cloudRecording ? (\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              Add labels to help you better manage your recording rules\n            </Text>\n          ) : (\n            <NotificationsStepDescription />\n          )}\n        </Stack>\n      }\n      fullWidth\n    >\n      <LabelsField dataSourceName={dataSourceName} />\n      {shouldRenderPreview && (\n        <NotificationPreview\n          alertQueries={queries}\n          customLabels={labels}\n          condition={condition}\n          folder={folder}\n          alertName={alertName}\n          alertUid={alertUid}\n        />\n      )}\n    </RuleEditorSection>\n  );\n};\n","import { PanelData } from '@grafana/data';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType } from './rule-form';\n\nexport type PreviewRuleRequest = GrafanaPreviewRuleRequest | CloudPreviewRuleRequest;\n\nexport type GrafanaPreviewRuleRequest = {\n  grafana_condition: {\n    condition: string;\n    data: AlertQuery[];\n    now: string;\n  };\n};\n\nexport type CloudPreviewRuleRequest = {\n  dataSourceUid: string;\n  dataSourceName: string;\n  expr: string;\n};\n\nexport type PreviewRuleResponse = {\n  ruleType: RuleFormType;\n  data: PanelData;\n};\n\nexport function isCloudPreviewRequest(request: PreviewRuleRequest): request is CloudPreviewRuleRequest {\n  return 'expr' in request;\n}\n\nexport function isGrafanaPreviewRequest(request: PreviewRuleRequest): request is GrafanaPreviewRuleRequest {\n  return 'grafana_condition' in request;\n}\n","import { Observable, of } from 'rxjs';\nimport { catchError, map, share } from 'rxjs/operators';\n\nimport {\n  dataFrameFromJSON,\n  DataFrameJSON,\n  getDefaultTimeRange,\n  LoadingState,\n  PanelData,\n  withLoadingIndicator,\n} from '@grafana/data';\nimport { getBackendSrv, toDataQueryError } from '@grafana/runtime';\n\nimport {\n  isCloudPreviewRequest,\n  isGrafanaPreviewRequest,\n  PreviewRuleRequest,\n  PreviewRuleResponse,\n} from '../types/preview';\nimport { RuleFormType } from '../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../utils/datasource';\n\nexport function previewAlertRule(request: PreviewRuleRequest): Observable<PreviewRuleResponse> {\n  if (isCloudPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, request.dataSourceUid, RuleFormType.cloudAlerting);\n  }\n\n  if (isGrafanaPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, GRAFANA_RULES_SOURCE_NAME, RuleFormType.grafana);\n  }\n\n  throw new Error('unsupported preview rule request');\n}\n\ntype AlertRulePreviewResponse = {\n  instances: DataFrameJSON[];\n};\n\nfunction fetchAlertRulePreview(\n  request: PreviewRuleRequest,\n  dataSourceUid: string,\n  ruleType: RuleFormType\n): Observable<PreviewRuleResponse> {\n  return withLoadingIndicator({\n    whileLoading: createResponse(ruleType),\n    source: getBackendSrv()\n      .fetch<AlertRulePreviewResponse>({\n        method: 'POST',\n        url: `/api/v1/rule/test/${dataSourceUid}`,\n        data: request,\n      })\n      .pipe(\n        map(({ data }) => {\n          return createResponse(ruleType, {\n            state: LoadingState.Done,\n            series: data.instances.map(dataFrameFromJSON),\n          });\n        }),\n        catchError((error: Error) => {\n          return of(\n            createResponse(ruleType, {\n              state: LoadingState.Error,\n              error: toDataQueryError(error),\n            })\n          );\n        }),\n        share()\n      ),\n  });\n}\n\nfunction createResponse(ruleType: RuleFormType, data: Partial<PanelData> = {}): PreviewRuleResponse {\n  return {\n    ruleType,\n    data: {\n      state: LoadingState.Loading,\n      series: [],\n      timeRange: getDefaultTimeRange(),\n      ...data,\n    },\n  };\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport AutoSizer from 'react-virtualized-auto-sizer';\n\nimport { FieldConfigSource, FieldMatcherID, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { PanelRenderer } from '@grafana/runtime';\nimport { TableCellDisplayMode, useStyles2 } from '@grafana/ui';\n\nimport { PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType } from '../../types/rule-form';\nimport { messageFromError } from '../../utils/redux';\n\ntype Props = {\n  preview: PreviewRuleResponse | undefined;\n};\n\nexport function PreviewRuleResult(props: Props): React.ReactElement | null {\n  const { preview } = props;\n  const styles = useStyles2(getStyles);\n  const fieldConfig: FieldConfigSource = {\n    defaults: {},\n    overrides: [\n      {\n        matcher: { id: FieldMatcherID.byName, options: 'Info' },\n        properties: [{ id: 'custom.displayMode', value: TableCellDisplayMode.JSONView }],\n      },\n    ],\n  };\n\n  if (!preview) {\n    return null;\n  }\n\n  const { data, ruleType } = preview;\n\n  if (data.state === LoadingState.Loading) {\n    return (\n      <div className={styles.container}>\n        <span>Loading preview...</span>\n      </div>\n    );\n  }\n\n  if (data.state === LoadingState.Error) {\n    return (\n      <div className={styles.container}>\n        {data.error ? messageFromError(data.error) : 'Failed to preview alert rule'}\n      </div>\n    );\n  }\n  return (\n    <div className={styles.container}>\n      <span>\n        Preview based on the result of running the query, for this moment.{' '}\n        {ruleType === RuleFormType.grafana ? 'Configuration for `no data` and `error handling` is not applied.' : null}\n      </span>\n      <div className={styles.table}>\n        <AutoSizer>\n          {({ width, height }) => (\n            <div style={{ width: `${width}px`, height: `${height}px` }}>\n              <PanelRenderer\n                title=\"\"\n                width={width}\n                height={height}\n                pluginId=\"table\"\n                data={data}\n                fieldConfig={fieldConfig}\n              />\n            </div>\n          )}\n        </AutoSizer>\n      </div>\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      margin: ${theme.spacing(2)} 0;\n    `,\n    table: css`\n      flex: 1 1 auto;\n      height: 135px;\n      margin-top: ${theme.spacing(2)};\n      border: 1px solid ${theme.colors.border.medium};\n      border-radius: ${theme.shape.radius.default};\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport React, { useCallback, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { useMountedState } from 'react-use';\nimport { takeWhile } from 'rxjs/operators';\n\nimport { dateTimeFormatISO, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, HorizontalGroup, useStyles2 } from '@grafana/ui';\n\nimport { previewAlertRule } from '../../api/preview';\nimport { useAlertQueriesStatus } from '../../hooks/useAlertQueriesStatus';\nimport { PreviewRuleRequest, PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\n\nimport { PreviewRuleResult } from './PreviewRuleResult';\n\nconst fields: Array<keyof RuleFormValues> = ['type', 'dataSourceName', 'condition', 'queries', 'expression'];\n\nexport function PreviewRule(): React.ReactElement | null {\n  const styles = useStyles2(getStyles);\n  const [preview, onPreview] = usePreview();\n  const { watch } = useFormContext<RuleFormValues>();\n  const [type, condition, queries] = watch(['type', 'condition', 'queries']);\n  const { allDataSourcesAvailable } = useAlertQueriesStatus(queries);\n\n  if (type === RuleFormType.cloudRecording || type === RuleFormType.cloudAlerting) {\n    return null;\n  }\n\n  const isPreviewAvailable = Boolean(condition) && allDataSourcesAvailable;\n\n  return (\n    <div className={styles.container}>\n      <HorizontalGroup>\n        {allDataSourcesAvailable && (\n          <Button disabled={!isPreviewAvailable} type=\"button\" variant=\"primary\" onClick={onPreview}>\n            Preview alerts\n          </Button>\n        )}\n        {!allDataSourcesAvailable && (\n          <Alert title=\"Preview is not available\" severity=\"warning\">\n            Cannot display the query preview. Some of the data sources used in the queries are not available.\n          </Alert>\n        )}\n      </HorizontalGroup>\n      <PreviewRuleResult preview={preview} />\n    </div>\n  );\n}\n\nexport function usePreview(): [PreviewRuleResponse | undefined, () => void] {\n  const [preview, setPreview] = useState<PreviewRuleResponse | undefined>();\n  const { getValues } = useFormContext<RuleFormValues>();\n  const isMounted = useMountedState();\n\n  const onPreview = useCallback(() => {\n    const values = getValues(fields);\n    const request = createPreviewRequest(values);\n\n    previewAlertRule(request)\n      .pipe(takeWhile((response) => !isCompleted(response), true))\n      .subscribe((response) => {\n        if (!isMounted()) {\n          return;\n        }\n        setPreview(response);\n      });\n  }, [getValues, isMounted]);\n\n  return [preview, onPreview];\n}\n\nfunction createPreviewRequest(values: any[]): PreviewRuleRequest {\n  const [type, dataSourceName, condition, queries, expression] = values;\n  const dsSettings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n  if (!dsSettings) {\n    throw new Error(`Cannot find data source settings for ${dataSourceName}`);\n  }\n\n  switch (type) {\n    case RuleFormType.cloudAlerting:\n      return {\n        dataSourceUid: dsSettings.uid,\n        dataSourceName,\n        expr: expression,\n      };\n\n    case RuleFormType.grafana:\n      return {\n        grafana_condition: {\n          condition,\n          data: queries,\n          now: dateTimeFormatISO(Date.now()),\n        },\n      };\n\n    default:\n      throw new Error(`Alert type ${type} not supported by preview.`);\n  }\n}\n\nfunction isCompleted(response: PreviewRuleResponse): boolean {\n  switch (response.data.state) {\n    case LoadingState.Done:\n    case LoadingState.Error:\n      return true;\n    default:\n      return false;\n  }\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      margin-top: ${theme.spacing(2)};\n      max-width: ${theme.breakpoints.values.xxl}px;\n    `,\n  };\n}\n","import { DataSourceInstanceSettings } from '@grafana/data';\nimport { PromBasedDataSource } from 'app/types/unified-alerting';\n\nimport { getDataSourceByName } from '../utils/datasource';\n\nimport { useUnifiedAlertingSelector } from './useUnifiedAlertingSelector';\n\nexport function useRulesSourcesWithRuler(): DataSourceInstanceSettings[] {\n  const dataSources = useUnifiedAlertingSelector((state) => state.dataSources);\n\n  const dataSourcesWithRuler = Object.values(dataSources)\n    .map((ds) => ds.result)\n    .filter((ds): ds is PromBasedDataSource => Boolean(ds?.rulerConfig));\n  // try fetching rules for each prometheus to see if it has ruler\n\n  return dataSourcesWithRuler\n    .map((ds) => getDataSourceByName(ds.name))\n    .filter((dsConfig): dsConfig is DataSourceInstanceSettings => Boolean(dsConfig));\n}\n","import { DataFrame } from '@grafana/data';\n\nimport { GrafanaAlertState, isGrafanaAlertState, Labels } from '../../../../../types/unified-alerting-dto';\n\ninterface AlertPreviewInstance {\n  state: GrafanaAlertState;\n  info?: string;\n  labels: Labels;\n}\n\ninterface AlertPreview {\n  instances: AlertPreviewInstance[];\n}\n\n// Alerts previews come in a DataFrame format which is more suited for displaying time series data\n// In order to display a list of tags we need to transform DataFrame into set of labels\nexport function mapDataFrameToAlertPreview({ fields }: DataFrame): AlertPreview {\n  const labelFields = fields.filter((field) => !['State', 'Info'].includes(field.name));\n  const stateFieldIndex = fields.findIndex((field) => field.name === 'State');\n  const infoFieldIndex = fields.findIndex((field) => field.name === 'Info');\n\n  const labelIndexes = labelFields.map((labelField) => fields.indexOf(labelField));\n\n  const instanceStatusCount = fields[stateFieldIndex]?.values.length ?? 0;\n\n  const instances: AlertPreviewInstance[] = [];\n\n  for (let index = 0; index < instanceStatusCount; index++) {\n    const labelValues = labelIndexes.map((labelIndex) => [fields[labelIndex].name, fields[labelIndex].values[index]]);\n    const state = fields[stateFieldIndex]?.values?.[index];\n    const info = fields[infoFieldIndex]?.values?.[index];\n\n    if (isGrafanaAlertState(state)) {\n      instances.push({\n        state: state,\n        info: info,\n        labels: Object.fromEntries(labelValues),\n      });\n    }\n  }\n\n  return { instances };\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataFrame, GrafanaTheme2 } from '@grafana/data/src';\nimport { Icon, TagList, Tooltip, useStyles2 } from '@grafana/ui/src';\n\nimport { labelsToTags } from '../../utils/labels';\nimport { AlertStateTag } from '../rules/AlertStateTag';\n\nimport { mapDataFrameToAlertPreview } from './preview';\n\ninterface CloudAlertPreviewProps {\n  preview: DataFrame;\n}\n\nexport function CloudAlertPreview({ preview }: CloudAlertPreviewProps) {\n  const styles = useStyles2(getStyles);\n  const alertPreview = mapDataFrameToAlertPreview(preview);\n\n  return (\n    <table className={styles.table}>\n      <caption>\n        <div>Alerts preview</div>\n        <span>Preview based on the result of running the query for this moment.</span>\n      </caption>\n      <thead>\n        <tr>\n          <th>State</th>\n          <th>Labels</th>\n          <th>Info</th>\n        </tr>\n      </thead>\n      <tbody>\n        {alertPreview.instances.map(({ state, info, labels }, index) => {\n          const instanceTags = labelsToTags(labels);\n\n          return (\n            <tr key={index}>\n              <td>{<AlertStateTag state={state} />}</td>\n              <td>\n                <TagList tags={instanceTags} className={styles.tagList} />\n              </td>\n              <td>\n                {info && (\n                  <Tooltip content={info}>\n                    <Icon name=\"info-circle\" />\n                  </Tooltip>\n                )}\n              </td>\n            </tr>\n          );\n        })}\n      </tbody>\n    </table>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  table: css`\n    width: 100%;\n    margin: ${theme.spacing(2, 0)};\n\n    caption {\n      caption-side: top;\n      color: ${theme.colors.text.primary};\n\n      & > span {\n        font-size: ${theme.typography.bodySmall.fontSize};\n        color: ${theme.colors.text.secondary};\n      }\n    }\n\n    td,\n    th {\n      padding: ${theme.spacing(1, 1)};\n    }\n\n    td + td,\n    th + th {\n      padding-left: ${theme.spacing(3)};\n    }\n\n    thead th {\n      &:nth-child(1) {\n        width: 80px;\n      }\n\n      &:nth-child(2) {\n        width: auto;\n      }\n\n      &:nth-child(3) {\n        width: 40px;\n      }\n    }\n\n    td:nth-child(3) {\n      text-align: center;\n    }\n\n    tbody tr:nth-child(2n + 1) {\n      background-color: ${theme.colors.background.secondary};\n    }\n  `,\n  tagList: css`\n    justify-content: flex-start;\n  `,\n});\n","import { css } from '@emotion/css';\nimport { noop } from 'lodash';\nimport React, { useCallback, useMemo } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { CoreApp, DataQuery, DataSourcePluginContextProvider, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, useStyles2 } from '@grafana/ui';\nimport { LokiQuery } from 'app/plugins/datasource/loki/types';\nimport { PromQuery } from 'app/plugins/datasource/prometheus/types';\n\nimport { CloudAlertPreview } from './CloudAlertPreview';\nimport { usePreview } from './PreviewRule';\n\nexport interface ExpressionEditorProps {\n  value?: string;\n  onChange: (value: string) => void;\n  dataSourceName: string; // will be a prometheus or loki datasource\n  showPreviewAlertsButton: boolean;\n}\n\nexport const ExpressionEditor = ({\n  value,\n  onChange,\n  dataSourceName,\n  showPreviewAlertsButton = true,\n}: ExpressionEditorProps) => {\n  const styles = useStyles2(getStyles);\n\n  const { mapToValue, mapToQuery } = useQueryMappers(dataSourceName);\n  const dataQuery = mapToQuery({ refId: 'A', hide: false }, value);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const onChangeQuery = useCallback(\n    (query: DataQuery) => {\n      onChange(mapToValue(query));\n    },\n    [onChange, mapToValue]\n  );\n\n  const [alertPreview, onPreview] = usePreview();\n\n  const onRunQueriesClick = async () => {\n    onPreview();\n  };\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return <div>Could not load query editor due to: {errorMessage}</div>;\n  }\n\n  const previewLoaded = alertPreview?.data.state === LoadingState.Done;\n\n  const QueryEditor = dataSource?.components?.QueryEditor;\n\n  // The Preview endpoint returns the preview as a single-element array of data frames\n  const previewDataFrame = alertPreview?.data?.series?.find((s) => s.name === 'evaluation results');\n  // The preview API returns arrays with empty elements when there are no firing alerts\n  const previewHasAlerts = previewDataFrame && previewDataFrame.fields.some((field) => field.values.length > 0);\n\n  return (\n    <>\n      <DataSourcePluginContextProvider instanceSettings={dsi}>\n        <QueryEditor\n          query={dataQuery}\n          queries={[dataQuery]}\n          app={CoreApp.CloudAlerting}\n          onChange={onChangeQuery}\n          onRunQuery={noop}\n          datasource={dataSource}\n        />\n      </DataSourcePluginContextProvider>\n      {showPreviewAlertsButton && (\n        <div className={styles.preview}>\n          <Button\n            type=\"button\"\n            onClick={onRunQueriesClick}\n            disabled={alertPreview?.data.state === LoadingState.Loading}\n          >\n            Preview alerts\n          </Button>\n          {previewLoaded && !previewHasAlerts && (\n            <Alert title=\"Alerts preview\" severity=\"info\" className={styles.previewAlert}>\n              There are no firing alerts for your query.\n            </Alert>\n          )}\n          {previewHasAlerts && <CloudAlertPreview preview={previewDataFrame} />}\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  preview: css`\n    padding: ${theme.spacing(2, 0)};\n    max-width: ${theme.breakpoints.values.xl}px;\n  `,\n  previewAlert: css`\n    margin: ${theme.spacing(1, 0)};\n  `,\n});\n\ntype QueryMappers<T extends DataQuery = DataQuery> = {\n  mapToValue: (query: T) => string;\n  mapToQuery: (existing: T, value: string | undefined) => T;\n};\n\nexport function useQueryMappers(dataSourceName: string): QueryMappers {\n  return useMemo(() => {\n    const settings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n    switch (settings?.type) {\n      case 'loki':\n      case 'prometheus':\n        return {\n          mapToValue: (query: DataQuery) => (query as PromQuery | LokiQuery).expr,\n          mapToQuery: (existing: DataQuery, value: string | undefined) => ({ ...existing, expr: value }),\n        };\n      default:\n        throw new Error(`${dataSourceName} is not supported as an expression editor`);\n    }\n  }, [dataSourceName]);\n}\n","import { css } from '@emotion/css';\nimport React, { useMemo } from 'react';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { Expression } from '../expressions/Expression';\n\nimport { errorFromPreviewData, warningFromSeries } from './util';\n\ninterface Props {\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  panelData: Record<string, PanelData | undefined>;\n  queries: AlertQuery[];\n  onRemoveExpression: (refId: string) => void;\n  onUpdateRefId: (oldRefId: string, newRefId: string) => void;\n  onUpdateExpressionType: (refId: string, type: ExpressionQueryType) => void;\n  onUpdateQueryExpression: (query: ExpressionQuery) => void;\n}\n\nexport const ExpressionsEditor = ({\n  condition,\n  onSetCondition,\n  queries,\n  panelData,\n  onUpdateRefId,\n  onRemoveExpression,\n  onUpdateExpressionType,\n  onUpdateQueryExpression,\n}: Props) => {\n  const expressionQueries = useMemo(() => {\n    return queries.reduce((acc: ExpressionQuery[], query) => {\n      return isExpressionQuery(query.model) ? acc.concat(query.model) : acc;\n    }, []);\n  }, [queries]);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      {expressionQueries.map((query) => {\n        const data = panelData[query.refId];\n\n        const isAlertCondition = condition === query.refId;\n        const error = data ? errorFromPreviewData(data) : undefined;\n        const warning = data ? warningFromSeries(data.series) : undefined;\n\n        return (\n          <Expression\n            key={query.refId}\n            isAlertCondition={isAlertCondition}\n            data={data}\n            error={error}\n            warning={warning}\n            queries={queries}\n            query={query}\n            onSetCondition={onSetCondition}\n            onRemoveExpression={onRemoveExpression}\n            onUpdateRefId={onUpdateRefId}\n            onUpdateExpressionType={onUpdateExpressionType}\n            onChangeQuery={onUpdateQueryExpression}\n          />\n        );\n      })}\n    </div>\n  );\n};\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css`\n    display: flex;\n    gap: ${theme.spacing(2)};\n    align-content: stretch;\n    flex-wrap: wrap;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { dateTime, getDefaultRelativeTimeRange, GrafanaTheme2, RelativeTimeRange } from '@grafana/data';\nimport { relativeToTimeRange } from '@grafana/data/src/datetime/rangeutil';\nimport { clearButtonStyles, Icon, InlineField, RelativeTimeRangePicker, Toggletip, useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { AlertQueryOptions, MaxDataPointsOption, MinIntervalOption } from './QueryWrapper';\n\nexport interface QueryOptionsProps {\n  query: AlertQuery;\n  queryOptions: AlertQueryOptions;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n  index: number;\n}\n\nexport const QueryOptions = ({\n  query,\n  queryOptions,\n  onChangeTimeRange,\n  onChangeQueryOptions,\n  index,\n}: QueryOptionsProps) => {\n  const styles = useStyles2(getStyles);\n\n  const [showOptions, setShowOptions] = useState(false);\n\n  const timeRange = query.relativeTimeRange ? relativeToTimeRange(query.relativeTimeRange) : undefined;\n\n  return (\n    <>\n      <Toggletip\n        content={\n          <div className={styles.queryOptions}>\n            {onChangeTimeRange && (\n              <InlineField label=\"Time Range\">\n                <RelativeTimeRangePicker\n                  timeRange={query.relativeTimeRange ?? getDefaultRelativeTimeRange()}\n                  onChange={(range) => onChangeTimeRange(range, index)}\n                />\n              </InlineField>\n            )}\n            <MaxDataPointsOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n            <MinIntervalOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n          </div>\n        }\n        closeButton={true}\n        placement=\"bottom-start\"\n      >\n        <button type=\"button\" className={styles.actionLink} onClick={() => setShowOptions(!showOptions)}>\n          Options {showOptions ? <Icon name=\"angle-right\" /> : <Icon name=\"angle-down\" />}\n        </button>\n      </Toggletip>\n\n      <div className={styles.staticValues}>\n        <span>\n          {dateTime(timeRange?.from)\n            .locale('en')\n            .fromNow(true)}\n        </span>\n        {queryOptions.maxDataPoints && <span>, MD = {queryOptions.maxDataPoints}</span>}\n        {queryOptions.minInterval && <span>, Min. Interval = {queryOptions.minInterval}</span>}\n      </div>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  const clearButton = clearButtonStyles(theme);\n\n  return {\n    queryOptions: css`\n      > div {\n        justify-content: space-between;\n      }\n    `,\n\n    staticValues: css`\n      color: ${theme.colors.text.secondary};\n      margin-right: ${theme.spacing(1)};\n    `,\n\n    actionLink: css`\n      ${clearButton};\n      color: ${theme.colors.text.link};\n      cursor: pointer;\n\n      &:hover {\n        text-decoration: underline;\n      }\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport React, { ChangeEvent, useState } from 'react';\n\nimport {\n  CoreApp,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  GrafanaTheme2,\n  LoadingState,\n  PanelData,\n  RelativeTimeRange,\n  ThresholdsConfig,\n} from '@grafana/data';\nimport { Stack } from '@grafana/experimental';\nimport { DataQuery } from '@grafana/schema';\nimport { GraphTresholdsStyleMode, Icon, InlineField, Input, Tooltip, useStyles2 } from '@grafana/ui';\nimport { QueryEditorRow } from 'app/features/query/components/QueryEditorRow';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { msToSingleUnitDuration } from '../../utils/time';\nimport { ExpressionStatusIndicator } from '../expressions/ExpressionStatusIndicator';\n\nimport { QueryOptions } from './QueryOptions';\nimport { VizWrapper } from './VizWrapper';\n\nexport const DEFAULT_MAX_DATA_POINTS = 43200;\nexport const DEFAULT_MIN_INTERVAL = '1s';\n\nexport interface AlertQueryOptions {\n  maxDataPoints?: number | undefined;\n  minInterval?: string | undefined;\n}\n\ninterface Props {\n  data: PanelData;\n  error?: Error;\n  query: AlertQuery;\n  queries: AlertQuery[];\n  dsSettings: DataSourceInstanceSettings;\n  onChangeDataSource: (settings: DataSourceInstanceSettings, index: number) => void;\n  onChangeQuery: (query: DataQuery, index: number) => void;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onRemoveQuery: (query: DataQuery) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  onRunQueries: () => void;\n  index: number;\n  thresholds: ThresholdsConfig;\n  thresholdsType?: GraphTresholdsStyleMode;\n  onChangeThreshold?: (thresholds: ThresholdsConfig, index: number) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n}\n\nexport const QueryWrapper = ({\n  data,\n  error,\n  dsSettings,\n  index,\n  onChangeDataSource,\n  onChangeQuery,\n  onChangeTimeRange,\n  onRunQueries,\n  onRemoveQuery,\n  onDuplicateQuery,\n  query,\n  queries,\n  thresholds,\n  thresholdsType,\n  onChangeThreshold,\n  condition,\n  onSetCondition,\n  onChangeQueryOptions,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n  const [dsInstance, setDsInstance] = useState<DataSourceApi>();\n  const defaults = dsInstance?.getDefaultQuery ? dsInstance.getDefaultQuery(CoreApp.UnifiedAlerting) : {};\n\n  const queryWithDefaults = {\n    ...defaults,\n    ...cloneDeep(query.model),\n  };\n\n  function SelectingDataSourceTooltip() {\n    const styles = useStyles2(getStyles);\n    return (\n      <div className={styles.dsTooltip}>\n        <Tooltip\n          content={\n            <>\n              Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon\n              for more information.\n            </>\n          }\n        >\n          <Icon\n            name=\"info-circle\"\n            onClick={() =>\n              window.open(\n                ' https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/',\n                '_blank'\n              )\n            }\n          />\n        </Tooltip>\n      </div>\n    );\n  }\n\n  // TODO add a warning label here too when the data looks like time series data and is used as an alert condition\n  function HeaderExtras({ query, error, index }: { query: AlertQuery; error?: Error; index: number }) {\n    const queryOptions: AlertQueryOptions = {\n      maxDataPoints: query.model.maxDataPoints,\n      minInterval: query.model.intervalMs ? msToSingleUnitDuration(query.model.intervalMs) : undefined,\n    };\n    const alertQueryOptions: AlertQueryOptions = {\n      maxDataPoints: queryOptions.maxDataPoints,\n      minInterval: queryOptions.minInterval,\n    };\n\n    const isAlertCondition = condition === query.refId;\n\n    return (\n      <Stack direction=\"row\" alignItems=\"center\" gap={1}>\n        <SelectingDataSourceTooltip />\n        <QueryOptions\n          onChangeTimeRange={onChangeTimeRange}\n          query={query}\n          queryOptions={alertQueryOptions}\n          onChangeQueryOptions={onChangeQueryOptions}\n          index={index}\n        />\n        <ExpressionStatusIndicator\n          error={error}\n          onSetCondition={() => onSetCondition(query.refId)}\n          isCondition={isAlertCondition}\n        />\n      </Stack>\n    );\n  }\n\n  const showVizualisation = data.state !== LoadingState.NotStarted;\n\n  return (\n    <Stack direction=\"column\" gap={0.5}>\n      <div className={styles.wrapper}>\n        <QueryEditorRow<DataQuery>\n          alerting\n          collapsable={false}\n          dataSource={dsSettings}\n          onDataSourceLoaded={setDsInstance}\n          onChangeDataSource={(settings) => onChangeDataSource(settings, index)}\n          id={query.refId}\n          index={index}\n          key={query.refId}\n          data={data}\n          query={queryWithDefaults}\n          onChange={(query) => onChangeQuery(query, index)}\n          onRemoveQuery={onRemoveQuery}\n          onAddQuery={() => onDuplicateQuery(cloneDeep(query))}\n          onRunQuery={onRunQueries}\n          queries={queries}\n          renderHeaderExtras={() => <HeaderExtras query={query} index={index} error={error} />}\n          app={CoreApp.UnifiedAlerting}\n          hideDisableQuery={true}\n        />\n      </div>\n      {showVizualisation && (\n        <VizWrapper\n          data={data}\n          thresholds={thresholds}\n          thresholdsType={thresholdsType}\n          onThresholdsChange={onChangeThreshold ? (thresholds) => onChangeThreshold(thresholds, index) : undefined}\n        />\n      )}\n    </Stack>\n  );\n};\n\nexport const EmptyQueryWrapper = ({ children }: React.PropsWithChildren<{}>) => {\n  const styles = useStyles2(getStyles);\n  return <div className={styles.wrapper}>{children}</div>;\n};\n\nexport function MaxDataPointsOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.maxDataPoints ?? '';\n\n  const onMaxDataPointsBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const maxDataPointsNumber = parseInt(event.target.value, 10);\n\n    const maxDataPoints = isNaN(maxDataPointsNumber) || maxDataPointsNumber === 0 ? undefined : maxDataPointsNumber;\n\n    if (maxDataPoints !== options.maxDataPoints) {\n      onChange({\n        ...options,\n        maxDataPoints,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      labelWidth={24}\n      label=\"Max data points\"\n      tooltip=\"The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer.\"\n    >\n      <Input\n        type=\"number\"\n        width={10}\n        placeholder={DEFAULT_MAX_DATA_POINTS.toLocaleString()}\n        spellCheck={false}\n        onBlur={onMaxDataPointsBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nexport function MinIntervalOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.minInterval ?? '';\n\n  const onMinIntervalBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const minInterval = event.target.value;\n    if (minInterval !== value) {\n      onChange({\n        ...options,\n        minInterval,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      label=\"Min interval\"\n      labelWidth={24}\n      tooltip={\n        <>\n          A lower limit for the interval. Recommended to be set to write frequency, for example <code>1m</code> if your\n          data is written every minute.\n        </>\n      }\n    >\n      <Input\n        type=\"text\"\n        width={10}\n        placeholder={DEFAULT_MIN_INTERVAL}\n        spellCheck={false}\n        onBlur={onMinIntervalBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css`\n    label: AlertingQueryWrapper;\n    margin-bottom: ${theme.spacing(1)};\n    border: 1px solid ${theme.colors.border.weak};\n    border-radius: ${theme.shape.radius.default};\n\n    button {\n      overflow: visible;\n    }\n  `,\n  dsTooltip: css`\n    display: flex;\n    align-items: center;\n    &:hover {\n      opacity: 0.85;\n      cursor: pointer;\n    }\n  `,\n});\n","import { omit } from 'lodash';\nimport React, { PureComponent, useState } from 'react';\nimport { DragDropContext, Droppable, DropResult } from 'react-beautiful-dnd';\n\nimport {\n  DataQuery,\n  DataSourceInstanceSettings,\n  LoadingState,\n  PanelData,\n  rangeUtil,\n  RelativeTimeRange,\n} from '@grafana/data';\nimport { Stack } from '@grafana/experimental';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Button, Card, Icon } from '@grafana/ui';\nimport { QueryOperationRow } from 'app/core/components/QueryOperationRow/QueryOperationRow';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { AlertQueryOptions, EmptyQueryWrapper, QueryWrapper } from './QueryWrapper';\nimport { errorFromCurrentCondition, errorFromPreviewData, getThresholdsForQueries } from './util';\n\ninterface Props {\n  // The query configuration\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  data: Record<string, PanelData>;\n  onRunQueries: () => void;\n\n  // Query editing\n  onQueriesChange: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport class QueryRows extends PureComponent<Props> {\n  constructor(props: Props) {\n    super(props);\n  }\n\n  onRemoveQuery = (query: DataQuery) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(queries.filter((q) => q.refId !== query.refId));\n  };\n\n  onChangeTimeRange = (timeRange: RelativeTimeRange, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          relativeTimeRange: timeRange,\n        };\n      })\n    );\n  };\n\n  onChangeQueryOptions = (options: AlertQueryOptions, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          model: {\n            ...item.model,\n            maxDataPoints: options.maxDataPoints,\n            intervalMs: options.minInterval ? rangeUtil.intervalToMs(options.minInterval) : undefined,\n          },\n        };\n      })\n    );\n  };\n\n  onChangeDataSource = (settings: DataSourceInstanceSettings, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    const updatedQueries = queries.map((item, itemIndex) => {\n      if (itemIndex !== index) {\n        return item;\n      }\n\n      const previousSettings = this.getDataSourceSettings(item);\n\n      // Copy model if changing to a datasource of same type.\n      if (settings.type === previousSettings?.type) {\n        return copyModel(item, settings);\n      }\n      return newModel(item, settings);\n    });\n\n    onQueriesChange(updatedQueries);\n  };\n\n  onChangeQuery = (query: DataQuery, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n\n        return {\n          ...item,\n          refId: query.refId,\n          queryType: item.model.queryType ?? '',\n          model: {\n            ...item.model,\n            ...query,\n            datasource: query.datasource!,\n          },\n        };\n      })\n    );\n  };\n\n  onDragEnd = (result: DropResult) => {\n    const { queries, onQueriesChange } = this.props;\n\n    if (!result || !result.destination) {\n      return;\n    }\n\n    const startIndex = result.source.index;\n    const endIndex = result.destination.index;\n    if (startIndex === endIndex) {\n      return;\n    }\n\n    const update = Array.from(queries);\n    const [removed] = update.splice(startIndex, 1);\n    update.splice(endIndex, 0, removed);\n    onQueriesChange(update);\n  };\n\n  getDataSourceSettings = (query: AlertQuery): DataSourceInstanceSettings | undefined => {\n    return getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n  };\n\n  render() {\n    const { queries, expressions } = this.props;\n    const thresholdByRefId = getThresholdsForQueries([...queries, ...expressions]);\n\n    return (\n      <DragDropContext onDragEnd={this.onDragEnd}>\n        <Droppable droppableId=\"alerting-queries\" direction=\"vertical\">\n          {(provided) => {\n            return (\n              <div ref={provided.innerRef} {...provided.droppableProps}>\n                <Stack direction=\"column\">\n                  {queries.map((query, index) => {\n                    const isCondition = this.props.condition === query.refId;\n                    const data: PanelData = this.props.data?.[query.refId] ?? {\n                      series: [],\n                      state: LoadingState.NotStarted,\n                    };\n                    const dsSettings = this.getDataSourceSettings(query);\n                    let error: Error | undefined = undefined;\n                    if (data && isCondition) {\n                      error = errorFromCurrentCondition(data);\n                    } else if (data) {\n                      error = errorFromPreviewData(data);\n                    }\n\n                    if (!dsSettings) {\n                      return (\n                        <DatasourceNotFound\n                          key={`${query.refId}-${index}`}\n                          index={index}\n                          model={query.model}\n                          onUpdateDatasource={() => {\n                            const defaultDataSource = getDatasourceSrv().getInstanceSettings(null);\n                            if (defaultDataSource) {\n                              this.onChangeDataSource(defaultDataSource, index);\n                            }\n                          }}\n                          onRemoveQuery={() => {\n                            this.onRemoveQuery(query);\n                          }}\n                        />\n                      );\n                    }\n\n                    return (\n                      <QueryWrapper\n                        index={index}\n                        key={query.refId}\n                        dsSettings={dsSettings}\n                        data={data}\n                        error={error}\n                        query={query}\n                        onChangeQuery={this.onChangeQuery}\n                        onRemoveQuery={this.onRemoveQuery}\n                        queries={[...queries, ...expressions]}\n                        onChangeDataSource={this.onChangeDataSource}\n                        onDuplicateQuery={this.props.onDuplicateQuery}\n                        onChangeTimeRange={this.onChangeTimeRange}\n                        onChangeQueryOptions={this.onChangeQueryOptions}\n                        thresholds={thresholdByRefId[query.refId]?.config}\n                        thresholdsType={thresholdByRefId[query.refId]?.mode}\n                        onRunQueries={this.props.onRunQueries}\n                        condition={this.props.condition}\n                        onSetCondition={this.props.onSetCondition}\n                      />\n                    );\n                  })}\n                  {provided.placeholder}\n                </Stack>\n              </div>\n            );\n          }}\n        </Droppable>\n      </DragDropContext>\n    );\n  }\n}\n\nfunction copyModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  return {\n    ...item,\n    model: {\n      ...omit(item.model, 'datasource'),\n      datasource: {\n        type: settings.type,\n        uid: settings.uid,\n      },\n    },\n    datasourceUid: settings.uid,\n  };\n}\n\nfunction newModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  return {\n    refId: item.refId,\n    relativeTimeRange: item.relativeTimeRange,\n    queryType: '',\n    datasourceUid: settings.uid,\n    model: {\n      refId: item.refId,\n      hide: false,\n      datasource: {\n        type: settings.type,\n        uid: settings.uid,\n      },\n    },\n  };\n}\n\ninterface DatasourceNotFoundProps {\n  index: number;\n  model: AlertDataQuery;\n  onUpdateDatasource: () => void;\n  onRemoveQuery: () => void;\n}\n\nconst DatasourceNotFound = ({ index, onUpdateDatasource, onRemoveQuery, model }: DatasourceNotFoundProps) => {\n  const refId = model.refId;\n\n  const [showDetails, setShowDetails] = useState<boolean>(false);\n\n  const toggleDetails = () => {\n    setShowDetails((show) => !show);\n  };\n\n  const handleUpdateDatasource = () => {\n    onUpdateDatasource();\n  };\n\n  return (\n    <EmptyQueryWrapper>\n      <QueryOperationRow title={refId} draggable index={index} id={refId} isOpen collapsable={false}>\n        <Card>\n          <Card.Heading>This datasource has been removed</Card.Heading>\n          <Card.Description>\n            The datasource for this query was not found, it was either removed or is not installed correctly.\n          </Card.Description>\n          <Card.Figure>\n            <Icon name=\"question-circle\" />\n          </Card.Figure>\n          <Card.Actions>\n            <Button key=\"update\" variant=\"secondary\" onClick={handleUpdateDatasource}>\n              Update datasource\n            </Button>\n            <Button key=\"remove\" variant=\"destructive\" onClick={onRemoveQuery}>\n              Remove query\n            </Button>\n          </Card.Actions>\n          <Card.SecondaryActions>\n            <Button\n              key=\"details\"\n              onClick={toggleDetails}\n              icon={showDetails ? 'angle-up' : 'angle-down'}\n              fill=\"text\"\n              size=\"sm\"\n            >\n              Show details\n            </Button>\n          </Card.SecondaryActions>\n        </Card>\n        {showDetails && (\n          <div>\n            <pre>\n              <code>{JSON.stringify(model, null, 2)}</code>\n            </pre>\n          </div>\n        )}\n      </QueryOperationRow>\n    </EmptyQueryWrapper>\n  );\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { QueryRows } from './QueryRows';\n\ninterface Props {\n  panelData: Record<string, PanelData>;\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  onRunQueries: () => void;\n  onChangeQueries: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport const QueryEditor = ({\n  queries,\n  expressions,\n  panelData,\n  onRunQueries,\n  onChangeQueries,\n  onDuplicateQuery,\n  condition,\n  onSetCondition,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <QueryRows\n        data={panelData}\n        queries={queries}\n        expressions={expressions}\n        onRunQueries={onRunQueries}\n        onQueriesChange={onChangeQueries}\n        onDuplicateQuery={onDuplicateQuery}\n        condition={condition}\n        onSetCondition={onSetCondition}\n      />\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css`\n    background-color: ${theme.colors.background.primary};\n    height: 100%;\n  `,\n});\n","import { css } from '@emotion/css';\nimport React, { FC, useEffect, useState } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { PanelData, CoreApp, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { useStyles2 } from '@grafana/ui';\nimport { getTimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { isPromOrLokiQuery } from '../../utils/rule-form';\n\nimport { VizWrapper } from './VizWrapper';\n\nexport interface RecordingRuleEditorProps {\n  queries: AlertQuery[];\n  onChangeQuery: (updatedQueries: AlertQuery[]) => void;\n  runQueries: () => void;\n  panelData: Record<string, PanelData>;\n  dataSourceName: string;\n}\n\nexport const RecordingRuleEditor: FC<RecordingRuleEditorProps> = ({\n  queries,\n  onChangeQuery,\n  runQueries,\n  panelData,\n  dataSourceName,\n}) => {\n  const [data, setData] = useState<PanelData>({\n    series: [],\n    state: LoadingState.NotStarted,\n    timeRange: getTimeSrv().timeRange(),\n  });\n\n  const styles = useStyles2(getStyles);\n\n  useEffect(() => {\n    setData(panelData?.[queries[0]?.refId]);\n  }, [panelData, queries]);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const handleChangedQuery = (changedQuery: DataQuery) => {\n    const query = queries[0];\n    const dataSourceId = getDataSourceSrv().getInstanceSettings(dataSourceName)?.uid;\n\n    if (!isPromOrLokiQuery(changedQuery) || !dataSourceId) {\n      return;\n    }\n\n    const expr = changedQuery.expr;\n\n    const merged = {\n      ...query,\n      ...changedQuery,\n      datasourceUid: dataSourceId,\n      expr,\n      model: {\n        expr,\n        datasource: changedQuery.datasource,\n        refId: changedQuery.refId,\n        editorMode: changedQuery.editorMode,\n        instant: Boolean(changedQuery.instant),\n        range: Boolean(changedQuery.range),\n        legendFormat: changedQuery.legendFormat,\n      },\n    };\n    onChangeQuery([merged]);\n  };\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return <div>Could not load query editor due to: {errorMessage}</div>;\n  }\n\n  const QueryEditor = dataSource.components.QueryEditor;\n\n  return (\n    <>\n      {queries.length && (\n        <QueryEditor\n          query={queries[0]}\n          queries={queries}\n          app={CoreApp.UnifiedAlerting}\n          onChange={handleChangedQuery}\n          onRunQuery={runQueries}\n          datasource={dataSource}\n        />\n      )}\n\n      {data && (\n        <div className={styles.vizWrapper}>\n          <VizWrapper data={data} />\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  vizWrapper: css`\n    margin: ${theme.spacing(1, 0)};\n  `,\n});\n","import React, { useCallback } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { DataSourcePicker } from 'app/features/datasources/components/picker/DataSourcePicker';\nimport { dispatch } from 'app/store/store';\n\nimport { useRulesSourcesWithRuler } from '../../hooks/useRuleSourcesWithRuler';\nimport { fetchAllPromBuildInfoAction } from '../../state/actions';\n\ninterface Props {\n  disabled?: boolean;\n  onChange: (ds: DataSourceInstanceSettings) => void;\n  value: string | null;\n  onBlur?: () => void;\n  name?: string;\n}\n\nexport function CloudRulesSourcePicker({ value, disabled, ...props }: Props): JSX.Element {\n  const rulesSourcesWithRuler = useRulesSourcesWithRuler();\n\n  const { loading = true } = useAsync(() => dispatch(fetchAllPromBuildInfoAction()), [dispatch]);\n\n  const dataSourceFilter = useCallback(\n    (ds: DataSourceInstanceSettings): boolean => {\n      return !!rulesSourcesWithRuler.find(({ id }) => id === ds.id);\n    },\n    [rulesSourcesWithRuler]\n  );\n\n  return (\n    <DataSourcePicker\n      disabled={loading || disabled}\n      noDefault\n      alerting\n      filter={dataSourceFilter}\n      current={value}\n      {...props}\n    />\n  );\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings, GrafanaTheme2 } from '@grafana/data';\nimport { Field, InputControl, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { CloudRulesSourcePicker } from '../CloudRulesSourcePicker';\n\nexport interface CloudDataSourceSelectorProps {\n  disabled?: boolean;\n  onChangeCloudDatasource: (datasourceUid: string) => void;\n}\nexport const CloudDataSourceSelector = ({ disabled, onChangeCloudDatasource }: CloudDataSourceSelectorProps) => {\n  const {\n    control,\n    formState: { errors },\n    setValue,\n    watch,\n  } = useFormContext<RuleFormValues & { location?: string }>();\n\n  const styles = useStyles2(getStyles);\n  const ruleFormType = watch('type');\n\n  return (\n    <>\n      <div className={styles.flexRow}>\n        {(ruleFormType === RuleFormType.cloudAlerting || ruleFormType === RuleFormType.cloudRecording) && (\n          <Field\n            className={styles.formInput}\n            label={disabled ? 'Data source' : 'Select data source'}\n            error={errors.dataSourceName?.message}\n            invalid={!!errors.dataSourceName?.message}\n            data-testid=\"datasource-picker\"\n          >\n            <InputControl\n              render={({ field: { onChange, ref, ...field } }) => (\n                <CloudRulesSourcePicker\n                  {...field}\n                  disabled={disabled}\n                  onChange={(ds: DataSourceInstanceSettings) => {\n                    // reset location if switching data sources, as different rules source will have different groups and namespaces\n                    setValue('location', undefined);\n                    // reset expression as they don't need to persist after changing datasources\n                    setValue('expression', '');\n                    onChange(ds?.name ?? null);\n                    onChangeCloudDatasource(ds?.uid ?? null);\n                  }}\n                />\n              )}\n              name=\"dataSourceName\"\n              control={control}\n              rules={{\n                required: { value: true, message: 'Please select a data source' },\n              }}\n            />\n          </Field>\n        )}\n      </div>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  formInput: css`\n    width: 330px;\n    & + & {\n      margin-left: ${theme.spacing(3)};\n    }\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: flex-end;\n  `,\n});\n","import React from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { Stack } from '@grafana/experimental';\nimport { DataSourceJsonData } from '@grafana/schema';\nimport { RadioButtonGroup, Text } from '@grafana/ui';\nimport { contextSrv } from 'app/core/core';\nimport { ExpressionDatasourceUID } from 'app/features/expressions/types';\nimport { AccessControlAction } from 'app/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\n\nfunction getAvailableRuleTypes() {\n  const canCreateGrafanaRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleCreate);\n  const canCreateCloudRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleExternalWrite);\n  const defaultRuleType = canCreateGrafanaRules ? RuleFormType.grafana : RuleFormType.cloudAlerting;\n\n  const enabledRuleTypes: RuleFormType[] = [];\n  if (canCreateGrafanaRules) {\n    enabledRuleTypes.push(RuleFormType.grafana);\n  }\n  if (canCreateCloudRules) {\n    enabledRuleTypes.push(RuleFormType.cloudAlerting, RuleFormType.cloudRecording);\n  }\n\n  return { enabledRuleTypes, defaultRuleType };\n}\n\nconst onlyOneDSInQueries = (queries: AlertQuery[]) => {\n  return queries.filter((q) => q.datasourceUid !== ExpressionDatasourceUID).length === 1;\n};\nconst getCanSwitch = ({\n  queries,\n  ruleFormType,\n  rulesSourcesWithRuler,\n}: {\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  ruleFormType: RuleFormType | undefined;\n}) => {\n  // get available rule types\n  const availableRuleTypes = getAvailableRuleTypes();\n\n  // check if we have only one query in queries and if it's a cloud datasource\n  const onlyOneDS = onlyOneDSInQueries(queries);\n  const dataSourceIdFromQueries = queries[0]?.datasourceUid ?? '';\n  const isRecordingRuleType = ruleFormType === RuleFormType.cloudRecording;\n\n  //let's check if we switch to cloud type\n  const canSwitchToCloudRule =\n    !isRecordingRuleType &&\n    onlyOneDS &&\n    rulesSourcesWithRuler.some((dsJsonData) => dsJsonData.uid === dataSourceIdFromQueries);\n\n  const canSwitchToGrafanaRule = !isRecordingRuleType;\n  // check for enabled types\n  const grafanaTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.grafana);\n  const cloudTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.cloudAlerting);\n\n  // can we switch to the other type? (cloud or grafana)\n  const canSwitchFromCloudToGrafana =\n    ruleFormType === RuleFormType.cloudAlerting && grafanaTypeEnabled && canSwitchToGrafanaRule;\n  const canSwitchFromGrafanaToCloud =\n    ruleFormType === RuleFormType.grafana && canSwitchToCloudRule && cloudTypeEnabled && canSwitchToCloudRule;\n\n  return canSwitchFromCloudToGrafana || canSwitchFromGrafanaToCloud;\n};\n\nexport interface SmartAlertTypeDetectorProps {\n  editingExistingRule: boolean;\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  onClickSwitch: () => void;\n}\n\nexport function SmartAlertTypeDetector({\n  editingExistingRule,\n  rulesSourcesWithRuler,\n  queries,\n  onClickSwitch,\n}: SmartAlertTypeDetectorProps) {\n  const { getValues } = useFormContext<RuleFormValues>();\n  const [ruleFormType] = getValues(['type']);\n  const canSwitch = getCanSwitch({ queries, ruleFormType, rulesSourcesWithRuler });\n\n  const options = [\n    { label: 'Grafana-managed', value: RuleFormType.grafana },\n    { label: 'Data source-managed', value: RuleFormType.cloudAlerting },\n  ];\n\n  // if we can't switch to data-source managed, disable it\n  // TODO figure out how to show a popover to the user to indicate _why_ it's disabled\n  const disabledOptions = canSwitch ? [] : [RuleFormType.cloudAlerting];\n\n  return (\n    <Stack direction=\"column\" gap={1} alignItems=\"flex-start\">\n      <Stack direction=\"column\" gap={0}>\n        <Text variant=\"h5\">Rule type</Text>\n        <Stack direction=\"row\" gap={0.5} alignItems=\"baseline\">\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            Select where the alert rule will be managed.\n          </Text>\n          <NeedHelpInfo\n            contentText={\n              <>\n                <Text color=\"primary\" variant=\"h6\">\n                  Grafana-managed alert rules\n                </Text>\n                <p>\n                  Grafana-managed alert rules allow you to create alerts that can act on data from any of our supported\n                  data sources, including having multiple data sources in the same rule. You can also add expressions to\n                  transform your data and set alert conditions. Using images in alert notifications is also supported.\n                </p>\n                <Text color=\"primary\" variant=\"h6\">\n                  Data source-managed alert rules\n                </Text>\n                <p>\n                  Data source-managed alert rules can be used for Grafana Mimir or Grafana Loki data sources which have\n                  been configured to support rule creation. The use of expressions or multiple queries is not supported.\n                </p>\n              </>\n            }\n            externalLink=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/alert-rule-types/\"\n            linkText=\"Read about alert rule types\"\n            title=\"Alert rule types\"\n          />\n        </Stack>\n      </Stack>\n      <RadioButtonGroup\n        options={options}\n        disabled={editingExistingRule}\n        disabledOptions={disabledOptions}\n        value={ruleFormType}\n        onChange={onClickSwitch}\n      />\n      {/* editing an existing rule, we just show \"cannot be changed\" */}\n      {editingExistingRule && (\n        <Text color=\"secondary\">The alert rule type cannot be changed for an existing rule.</Text>\n      )}\n      {/* in regular alert creation we tell the user what options they have when using a cloud data source */}\n      {!editingExistingRule && (\n        <>\n          {canSwitch ? (\n            <Text color=\"secondary\">\n              {ruleFormType === RuleFormType.grafana\n                ? 'The data source selected in your query supports alert rule management. Switch to data source-managed if you want the alert rule to be managed by the data source instead of Grafana.'\n                : 'Switch to Grafana-managed to use expressions, multiple queries, images in notifications and various other features.'}\n            </Text>\n          ) : (\n            <Text color=\"secondary\">Based on the selected data sources this alert rule will be Grafana-managed.</Text>\n          )}\n        </>\n      )}\n    </Stack>\n  );\n}\n","import { ExpressionDatasourceUID } from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nexport const hasCyclicalReferences = (queries: AlertQuery[]) => {\n  try {\n    JSON.stringify(queries);\n    return false;\n  } catch (e) {\n    return true;\n  }\n};\n\nexport const findDataSourceFromExpressionRecursive = (\n  queries: AlertQuery[],\n  alertQuery: AlertQuery\n): AlertQuery | null | undefined => {\n  //Check if this is not cyclical structre\n  if (hasCyclicalReferences(queries)) {\n    return null;\n  }\n  // We have the data source in this dataQuery\n  if (alertQuery.datasourceUid !== ExpressionDatasourceUID) {\n    return alertQuery;\n  }\n  // alertQuery it's an expression, we have to traverse all the tree up to the data source\n  else {\n    const alertQueryReferenced = queries.find((alertQuery_) => alertQuery_.refId === alertQuery.model.expression);\n    if (alertQueryReferenced) {\n      return findDataSourceFromExpressionRecursive(queries, alertQueryReferenced);\n    } else {\n      return null;\n    }\n  }\n};\n","import { createAction, createReducer } from '@reduxjs/toolkit';\n\nimport { DataQuery, getDefaultRelativeTimeRange, rangeUtil, RelativeTimeRange } from '@grafana/data';\nimport { getNextRefIdChar } from 'app/core/utils/query';\nimport { findDataSourceFromExpressionRecursive } from 'app/features/alerting/utils/dataSourceFromExpression';\nimport { dataSource as expressionDatasource } from 'app/features/expressions/ExpressionDatasource';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionDatasourceUID, ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport { defaultCondition } from 'app/features/expressions/utils/expressionTypes';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { queriesWithUpdatedReferences, refIdExists } from '../util';\n\nexport interface QueriesAndExpressionsState {\n  queries: AlertQuery[];\n}\n\nconst findDataSourceFromExpression = (\n  queries: AlertQuery[],\n  expression: string | undefined\n): AlertQuery | null | undefined => {\n  const firstReference = queries.find((alertQuery) => alertQuery.refId === expression);\n  const dataSource = firstReference && findDataSourceFromExpressionRecursive(queries, firstReference);\n  return dataSource;\n};\n\nconst initialState: QueriesAndExpressionsState = {\n  queries: [],\n};\n\nexport const duplicateQuery = createAction<AlertQuery>('duplicateQuery');\nexport const addNewDataQuery = createAction('addNewDataQuery');\nexport const setDataQueries = createAction<AlertQuery[]>('setDataQueries');\n\nexport const addNewExpression = createAction<ExpressionQueryType>('addNewExpression');\nexport const removeExpression = createAction<string>('removeExpression');\nexport const removeExpressions = createAction('removeExpressions');\nexport const addExpressions = createAction<AlertQuery[]>('addExpressions');\nexport const updateExpression = createAction<ExpressionQuery>('updateExpression');\nexport const updateExpressionRefId = createAction<{ oldRefId: string; newRefId: string }>('updateExpressionRefId');\nexport const rewireExpressions = createAction<{ oldRefId: string; newRefId: string }>('rewireExpressions');\nexport const updateExpressionType = createAction<{ refId: string; type: ExpressionQueryType }>('updateExpressionType');\nexport const updateExpressionTimeRange = createAction('updateExpressionTimeRange');\nexport const updateMaxDataPoints = createAction<{ refId: string; maxDataPoints: number }>('updateMaxDataPoints');\nexport const updateMinInterval = createAction<{ refId: string; minInterval: string }>('updateMinInterval');\n\nexport const setRecordingRulesQueries = createAction<{ recordingRuleQueries: AlertQuery[]; expression: string }>(\n  'setRecordingRulesQueries'\n);\n\nexport const queriesAndExpressionsReducer = createReducer(initialState, (builder) => {\n  // data queries actions\n  builder\n    .addCase(duplicateQuery, (state, { payload }) => {\n      state.queries = addQuery(state.queries, payload);\n    })\n    .addCase(addNewDataQuery, (state) => {\n      const datasource = getDefaultOrFirstCompatibleDataSource();\n      if (!datasource) {\n        return;\n      }\n\n      state.queries = addQuery(state.queries, {\n        datasourceUid: datasource.uid,\n        model: {\n          refId: '',\n          datasource: {\n            type: datasource.type,\n            uid: datasource.uid,\n          },\n        },\n      });\n    })\n    .addCase(setDataQueries, (state, { payload }) => {\n      const expressionQueries = state.queries.filter((query) => isExpressionQuery(query.model));\n      state.queries = [...payload, ...expressionQueries];\n    })\n    .addCase(setRecordingRulesQueries, (state, { payload }) => {\n      const query = payload.recordingRuleQueries[0];\n      const recordingRuleQuery = {\n        ...query,\n        ...{ expr: payload.expression, model: query?.model },\n      };\n\n      state.queries = [recordingRuleQuery];\n    })\n    .addCase(updateMaxDataPoints, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                maxDataPoints: action.payload.maxDataPoints,\n              },\n            }\n          : query;\n      });\n    })\n    .addCase(updateMinInterval, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                intervalMs: action.payload.minInterval ? rangeUtil.intervalToMs(action.payload.minInterval) : undefined,\n              },\n            }\n          : query;\n      });\n    });\n\n  // expressions actions\n  builder\n    .addCase(addNewExpression, (state, { payload }) => {\n      state.queries = addQuery(state.queries, {\n        datasourceUid: ExpressionDatasourceUID,\n        model: expressionDatasource.newQuery({\n          type: payload,\n          conditions: [{ ...defaultCondition, query: { params: [] } }],\n          expression: '',\n        }),\n      });\n    })\n    .addCase(removeExpression, (state, { payload }) => {\n      state.queries = state.queries.filter((query) => query.refId !== payload);\n    })\n    .addCase(removeExpressions, (state) => {\n      state.queries = state.queries.filter((query) => !isExpressionQuery(query.model));\n    })\n    .addCase(addExpressions, (state, { payload }) => {\n      state.queries = [...state.queries, ...payload];\n    })\n    .addCase(updateExpression, (state, { payload }) => {\n      state.queries = state.queries.map((query) => {\n        const dataSourceAlertQuery = findDataSourceFromExpression(state.queries, payload.expression);\n\n        const relativeTimeRange = dataSourceAlertQuery\n          ? dataSourceAlertQuery.relativeTimeRange\n          : getDefaultRelativeTimeRange();\n\n        if (query.refId === payload.refId) {\n          query.model = payload;\n          if (payload.type === ExpressionQueryType.resample) {\n            query.relativeTimeRange = relativeTimeRange;\n          }\n        }\n        return query;\n      });\n    })\n    .addCase(updateExpressionTimeRange, (state) => {\n      const newState = state.queries.map((query) => {\n        // It's an expression , let's update the relativeTimeRange with its dataSource relativeTimeRange\n        if (query.datasourceUid === ExpressionDatasourceUID) {\n          const dataSource = findDataSourceFromExpression(state.queries, query.model.expression);\n          const relativeTimeRange = dataSource ? dataSource.relativeTimeRange : getDefaultRelativeTimeRange();\n          query.relativeTimeRange = relativeTimeRange;\n        }\n        return query;\n      });\n      state.queries = newState;\n    })\n    .addCase(updateExpressionRefId, (state, { payload }) => {\n      const { newRefId, oldRefId } = payload;\n\n      // if the new refId already exists we just refuse to update the state\n      const newRefIdExists = refIdExists(state.queries, newRefId);\n      if (newRefIdExists) {\n        return;\n      }\n\n      const updatedQueries = queriesWithUpdatedReferences(state.queries, oldRefId, newRefId);\n      state.queries = updatedQueries.map((query) => {\n        if (query.refId === oldRefId) {\n          return {\n            ...query,\n            refId: newRefId,\n            model: {\n              ...query.model,\n              refId: newRefId,\n            },\n          };\n        }\n\n        return query;\n      });\n    })\n    .addCase(rewireExpressions, (state, { payload }) => {\n      state.queries = queriesWithUpdatedReferences(state.queries, payload.oldRefId, payload.newRefId);\n    })\n    .addCase(updateExpressionType, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...expressionDatasource.newQuery({\n                  type: action.payload.type,\n                  conditions: [{ ...defaultCondition, query: { params: [] } }],\n                  expression: '',\n                }),\n                refId: action.payload.refId,\n              },\n            }\n          : query;\n      });\n    });\n});\n\nconst addQuery = (\n  queries: AlertQuery[],\n  queryToAdd: Pick<AlertQuery, 'model' | 'datasourceUid' | 'relativeTimeRange'>\n): AlertQuery[] => {\n  const refId = getNextRefIdChar(queries);\n  const query: AlertQuery = {\n    ...queryToAdd,\n    refId,\n    queryType: '',\n    model: {\n      ...queryToAdd.model,\n      hide: false,\n      refId,\n    },\n    relativeTimeRange: queryToAdd.relativeTimeRange ?? defaultTimeRange(queryToAdd.model),\n  };\n\n  return [...queries, query];\n};\n\nconst defaultTimeRange = (model: DataQuery): RelativeTimeRange | undefined => {\n  if (isExpressionQuery(model)) {\n    return;\n  }\n\n  return getDefaultRelativeTimeRange();\n};\n","import { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { LoadingState, PanelData } from '@grafana/data';\n\nimport { AlertQuery } from '../../../../../../types/unified-alerting-dto';\nimport { AlertingQueryRunner } from '../../../state/AlertingQueryRunner';\n\nexport function useAlertQueryRunner() {\n  const [queryPreviewData, setQueryPreviewData] = useState<Record<string, PanelData>>({});\n\n  const runner = useRef(new AlertingQueryRunner());\n\n  useEffect(() => {\n    const currentRunner = runner.current;\n\n    currentRunner.get().subscribe((data) => {\n      setQueryPreviewData(data);\n    });\n\n    return () => {\n      currentRunner.destroy();\n    };\n  }, []);\n\n  const clearPreviewData = useCallback(() => {\n    setQueryPreviewData({});\n  }, []);\n\n  const cancelQueries = useCallback(() => {\n    runner.current.cancel();\n  }, []);\n\n  const runQueries = useCallback((queriesToPreview: AlertQuery[]) => {\n    runner.current.run(queriesToPreview);\n  }, []);\n\n  const isPreviewLoading = useMemo(() => {\n    return Object.values(queryPreviewData).some((d) => d.state === LoadingState.Loading);\n  }, [queryPreviewData]);\n\n  return { queryPreviewData, runQueries, cancelQueries, isPreviewLoading, clearPreviewData };\n}\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport React, { useCallback, useEffect, useMemo, useReducer, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { getDefaultRelativeTimeRange, GrafanaTheme2 } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Stack } from '@grafana/experimental';\nimport { config, getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, Dropdown, Field, Icon, InputControl, Menu, MenuItem, Tooltip, useStyles2 } from '@grafana/ui';\nimport { Text } from '@grafana/ui/src/components/Text/Text';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionDatasourceUID, ExpressionQueryType, expressionTypes } from 'app/features/expressions/types';\nimport { useDispatch } from 'app/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { useRulesSourcesWithRuler } from '../../../hooks/useRuleSourcesWithRuler';\nimport { fetchAllPromBuildInfoAction } from '../../../state/actions';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { isPromOrLokiQuery, PromOrLokiQuery } from '../../../utils/rule-form';\nimport { ExpressionEditor } from '../ExpressionEditor';\nimport { ExpressionsEditor } from '../ExpressionsEditor';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\nimport { QueryEditor } from '../QueryEditor';\nimport { RecordingRuleEditor } from '../RecordingRuleEditor';\nimport { RuleEditorSection } from '../RuleEditorSection';\nimport { errorFromCurrentCondition, errorFromPreviewData, findRenamedDataQueryReferences, refIdExists } from '../util';\n\nimport { CloudDataSourceSelector } from './CloudDataSourceSelector';\nimport { SmartAlertTypeDetector } from './SmartAlertTypeDetector';\nimport {\n  addExpressions,\n  addNewDataQuery,\n  addNewExpression,\n  duplicateQuery,\n  queriesAndExpressionsReducer,\n  removeExpression,\n  removeExpressions,\n  rewireExpressions,\n  setDataQueries,\n  setRecordingRulesQueries,\n  updateExpression,\n  updateExpressionRefId,\n  updateExpressionTimeRange,\n  updateExpressionType,\n} from './reducer';\nimport { useAlertQueryRunner } from './useAlertQueryRunner';\n\ninterface Props {\n  editingExistingRule: boolean;\n  onDataChange: (error: string) => void;\n}\n\nexport const QueryAndExpressionsStep = ({ editingExistingRule, onDataChange }: Props) => {\n  const {\n    setValue,\n    getValues,\n    watch,\n    formState: { errors },\n    control,\n  } = useFormContext<RuleFormValues>();\n\n  const { queryPreviewData, runQueries, cancelQueries, isPreviewLoading, clearPreviewData } = useAlertQueryRunner();\n\n  const initialState = {\n    queries: getValues('queries'),\n  };\n\n  const [{ queries }, dispatch] = useReducer(queriesAndExpressionsReducer, initialState);\n  const [type, condition, dataSourceName] = watch(['type', 'condition', 'dataSourceName']);\n\n  const isGrafanaManagedType = type === RuleFormType.grafana;\n  const isRecordingRuleType = type === RuleFormType.cloudRecording;\n  const isCloudAlertRuleType = type === RuleFormType.cloudAlerting;\n\n  const dispatchReduxAction = useDispatch();\n  useEffect(() => {\n    dispatchReduxAction(fetchAllPromBuildInfoAction());\n  }, [dispatchReduxAction]);\n\n  const rulesSourcesWithRuler = useRulesSourcesWithRuler();\n\n  const runQueriesPreview = useCallback(() => {\n    if (isCloudAlertRuleType) {\n      // we will skip preview for cloud rules, these do not have any time series preview\n      // Grafana Managed rules and recording rules do\n      return;\n    }\n\n    runQueries(getValues('queries'));\n  }, [isCloudAlertRuleType, runQueries, getValues]);\n\n  // whenever we update the queries we have to update the form too\n  useEffect(() => {\n    setValue('queries', queries, { shouldValidate: false });\n  }, [queries, runQueries, setValue]);\n\n  const noCompatibleDataSources = getDefaultOrFirstCompatibleDataSource() === undefined;\n\n  // data queries only\n  const dataQueries = useMemo(() => {\n    return queries.filter((query) => !isExpressionQuery(query.model));\n  }, [queries]);\n\n  // expression queries only\n  const expressionQueries = useMemo(() => {\n    return queries.filter((query) => isExpressionQuery(query.model));\n  }, [queries]);\n\n  const emptyQueries = queries.length === 0;\n\n  // apply some validations and asserts to the results of the evaluation when creating or editing\n  // Grafana-managed alert rules\n  useEffect(() => {\n    if (!isGrafanaManagedType) {\n      return;\n    }\n\n    const currentCondition = getValues('condition');\n    if (!currentCondition) {\n      return;\n    }\n\n    const previewData = queryPreviewData[currentCondition];\n    if (!previewData) {\n      return;\n    }\n\n    const error = errorFromPreviewData(previewData) ?? errorFromCurrentCondition(previewData);\n\n    onDataChange(error?.message || '');\n  }, [queryPreviewData, getValues, onDataChange, isGrafanaManagedType]);\n\n  const handleSetCondition = useCallback(\n    (refId: string | null) => {\n      if (!refId) {\n        return;\n      }\n\n      runQueriesPreview(); //we need to run the queries to know if the condition is valid\n\n      setValue('condition', refId);\n    },\n    [runQueriesPreview, setValue]\n  );\n\n  const onUpdateRefId = useCallback(\n    (oldRefId: string, newRefId: string) => {\n      const newRefIdExists = refIdExists(queries, newRefId);\n      // TODO we should set an error and explain what went wrong instead of just refusing to update\n      if (newRefIdExists) {\n        return;\n      }\n\n      dispatch(updateExpressionRefId({ oldRefId, newRefId }));\n\n      // update condition too if refId was updated\n      if (condition === oldRefId) {\n        handleSetCondition(newRefId);\n      }\n    },\n    [condition, queries, handleSetCondition]\n  );\n\n  const updateExpressionAndDatasource = useSetExpressionAndDataSource();\n\n  const onChangeQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      // Most data sources triggers onChange and onRunQueries consecutively\n      // It means our reducer state is always one step behind when runQueries is invoked\n      // Invocation cycle => onChange -> dispatch(setDataQueries) -> onRunQueries -> setDataQueries Reducer\n      // As a workaround we update form values as soon as possible to avoid stale state\n      // This way we can access up to date queries in runQueriesPreview without waiting for re-render\n      setValue('queries', updatedQueries, { shouldValidate: false });\n\n      updateExpressionAndDatasource(updatedQueries);\n\n      dispatch(setDataQueries(updatedQueries));\n      dispatch(updateExpressionTimeRange());\n\n      // check if we need to rewire expressions (and which ones)\n      const [oldRefId, newRefId] = findRenamedDataQueryReferences(queries, updatedQueries);\n      if (oldRefId && newRefId) {\n        dispatch(rewireExpressions({ oldRefId, newRefId }));\n      }\n    },\n    [queries, setValue, updateExpressionAndDatasource]\n  );\n\n  const onChangeRecordingRulesQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      const query = updatedQueries[0];\n\n      if (!isPromOrLokiQuery(query.model)) {\n        return;\n      }\n\n      const expression = query.model.expr;\n\n      setValue('queries', updatedQueries, { shouldValidate: false });\n      updateExpressionAndDatasource(updatedQueries);\n\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: updatedQueries, expression }));\n      runQueriesPreview();\n    },\n    [runQueriesPreview, setValue, updateExpressionAndDatasource]\n  );\n\n  const recordingRuleDefaultDatasource = rulesSourcesWithRuler[0];\n\n  useEffect(() => {\n    clearPreviewData();\n    if (type === RuleFormType.cloudRecording) {\n      const expr = getValues('expression');\n\n      if (!recordingRuleDefaultDatasource) {\n        return;\n      }\n\n      const datasourceUid =\n        (editingExistingRule && getDataSourceSrv().getInstanceSettings(dataSourceName)?.uid) ||\n        recordingRuleDefaultDatasource.uid;\n\n      const defaultQuery = {\n        refId: 'A',\n        datasourceUid,\n        queryType: '',\n        relativeTimeRange: getDefaultRelativeTimeRange(),\n        expr,\n        model: {\n          refId: 'A',\n          hide: false,\n          expr,\n        },\n      };\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: [defaultQuery], expression: expr }));\n    }\n  }, [type, recordingRuleDefaultDatasource, editingExistingRule, getValues, dataSourceName, clearPreviewData]);\n\n  const onDuplicateQuery = useCallback((query: AlertQuery) => {\n    dispatch(duplicateQuery(query));\n  }, []);\n\n  // update the condition if it's been removed\n  useEffect(() => {\n    if (!refIdExists(queries, condition)) {\n      const lastRefId = queries.at(-1)?.refId ?? null;\n      handleSetCondition(lastRefId);\n    }\n  }, [condition, queries, handleSetCondition]);\n\n  const onClickType = useCallback(\n    (type: ExpressionQueryType) => {\n      dispatch(addNewExpression(type));\n    },\n    [dispatch]\n  );\n\n  const styles = useStyles2(getStyles);\n\n  // Cloud alerts load data from form values\n  // whereas Grafana managed alerts load data from reducer\n  //when data source is changed in the cloud selector we need to update the queries in the reducer\n\n  const onChangeCloudDatasource = useCallback(\n    (datasourceUid: string) => {\n      const newQueries = cloneDeep(queries);\n      newQueries[0].datasourceUid = datasourceUid;\n      setValue('queries', newQueries, { shouldValidate: false });\n\n      updateExpressionAndDatasource(newQueries);\n\n      dispatch(setDataQueries(newQueries));\n    },\n    [queries, setValue, updateExpressionAndDatasource, dispatch]\n  );\n\n  // ExpressionEditor for cloud query needs to update queries in the reducer and in the form\n  // otherwise the value is not updated for Grafana managed alerts\n\n  const onChangeExpression = (value: string) => {\n    const newQueries = cloneDeep(queries);\n\n    if (newQueries[0].model) {\n      if (isPromOrLokiQuery(newQueries[0].model)) {\n        newQueries[0].model.expr = value;\n      } else {\n        // first time we come from grafana-managed type\n        // we need to convert the model to PromOrLokiQuery\n        const promLoki: PromOrLokiQuery = {\n          ...cloneDeep(newQueries[0].model),\n          expr: value,\n        };\n        newQueries[0].model = promLoki;\n      }\n    }\n\n    setValue('queries', newQueries, { shouldValidate: false });\n\n    updateExpressionAndDatasource(newQueries);\n\n    dispatch(setDataQueries(newQueries));\n    runQueriesPreview();\n  };\n\n  const removeExpressionsInQueries = useCallback(() => dispatch(removeExpressions()), [dispatch]);\n\n  const addExpressionsInQueries = useCallback(\n    (expressions: AlertQuery[]) => dispatch(addExpressions(expressions)),\n    [dispatch]\n  );\n\n  // we need to keep track of the previous expressions and condition reference to be able to restore them when switching back to grafana managed\n  const [prevExpressions, setPrevExpressions] = useState<AlertQuery[]>([]);\n  const [prevCondition, setPrevCondition] = useState<string | null>(null);\n\n  const restoreExpressionsInQueries = useCallback(() => {\n    addExpressionsInQueries(prevExpressions);\n  }, [prevExpressions, addExpressionsInQueries]);\n\n  const onClickSwitch = useCallback(() => {\n    const typeInForm = getValues('type');\n    if (typeInForm === RuleFormType.cloudAlerting) {\n      setValue('type', RuleFormType.grafana);\n      setValue('dataSourceName', null); // set data source name back to \"null\"\n\n      prevExpressions.length > 0 && restoreExpressionsInQueries();\n      prevCondition && setValue('condition', prevCondition);\n    } else {\n      setValue('type', RuleFormType.cloudAlerting);\n      // dataSourceName is used only by Mimir/Loki alerting and recording rules\n      // It should be empty for Grafana managed alert rules\n      const newDsName = getDataSourceSrv().getInstanceSettings(queries[0].datasourceUid)?.name;\n      if (newDsName) {\n        setValue('dataSourceName', newDsName);\n      }\n\n      updateExpressionAndDatasource(queries);\n\n      const expressions = queries.filter((query) => query.datasourceUid === ExpressionDatasourceUID);\n      setPrevExpressions(expressions);\n      removeExpressionsInQueries();\n      setPrevCondition(condition);\n    }\n  }, [\n    getValues,\n    setValue,\n    prevExpressions.length,\n    restoreExpressionsInQueries,\n    prevCondition,\n    updateExpressionAndDatasource,\n    queries,\n    removeExpressionsInQueries,\n    condition,\n  ]);\n\n  return (\n    <RuleEditorSection\n      stepNo={2}\n      title={type !== RuleFormType.cloudRecording ? 'Define query and alert condition' : 'Define query'}\n      description={\n        <Stack direction=\"row\" gap={0.5} alignItems=\"baseline\">\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            Define queries and/or expressions and then choose one of them as the alert rule condition. This is the\n            threshold that an alert rule must meet or exceed in order to fire.\n          </Text>\n          <NeedHelpInfo\n            contentText={`An alert rule consists of one or more queries and expressions that select the data you want to measure.\n          Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire.\n          For more information on queries and expressions, see Query and transform data.`}\n            externalLink={`https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/`}\n            linkText={`Read about query and condition`}\n            title=\"Define query and alert condition\"\n          />\n        </Stack>\n      }\n    >\n      {/* This is the cloud data source selector */}\n      {(type === RuleFormType.cloudRecording || type === RuleFormType.cloudAlerting) && (\n        <CloudDataSourceSelector onChangeCloudDatasource={onChangeCloudDatasource} disabled={editingExistingRule} />\n      )}\n\n      {/* This is the PromQL Editor for recording rules */}\n      {isRecordingRuleType && dataSourceName && (\n        <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n          <RecordingRuleEditor\n            dataSourceName={dataSourceName}\n            queries={queries}\n            runQueries={runQueriesPreview}\n            onChangeQuery={onChangeRecordingRulesQueries}\n            panelData={queryPreviewData}\n          />\n        </Field>\n      )}\n\n      {/* This is the PromQL Editor for Cloud rules */}\n      {isCloudAlertRuleType && dataSourceName && (\n        <Stack direction=\"column\">\n          <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n            <InputControl\n              name=\"expression\"\n              render={({ field: { ref, ...field } }) => {\n                return (\n                  <ExpressionEditor\n                    {...field}\n                    dataSourceName={dataSourceName}\n                    showPreviewAlertsButton={!isRecordingRuleType}\n                    onChange={onChangeExpression}\n                  />\n                );\n              }}\n              control={control}\n              rules={{\n                required: { value: true, message: 'A valid expression is required' },\n              }}\n            />\n          </Field>\n          <SmartAlertTypeDetector\n            editingExistingRule={editingExistingRule}\n            queries={queries}\n            rulesSourcesWithRuler={rulesSourcesWithRuler}\n            onClickSwitch={onClickSwitch}\n          />\n        </Stack>\n      )}\n\n      {/* This is the editor for Grafana managed rules */}\n      {isGrafanaManagedType && (\n        <Stack direction=\"column\">\n          {/* Data Queries */}\n          <QueryEditor\n            queries={dataQueries}\n            expressions={expressionQueries}\n            onRunQueries={runQueriesPreview}\n            onChangeQueries={onChangeQueries}\n            onDuplicateQuery={onDuplicateQuery}\n            panelData={queryPreviewData}\n            condition={condition}\n            onSetCondition={handleSetCondition}\n          />\n          <Tooltip content={'You appear to have no compatible data sources'} show={noCompatibleDataSources}>\n            <Button\n              type=\"button\"\n              onClick={() => {\n                dispatch(addNewDataQuery());\n              }}\n              variant=\"secondary\"\n              aria-label={selectors.components.QueryTab.addQuery}\n              disabled={noCompatibleDataSources}\n              className={styles.addQueryButton}\n            >\n              Add query\n            </Button>\n          </Tooltip>\n          <SmartAlertTypeDetector\n            editingExistingRule={editingExistingRule}\n            rulesSourcesWithRuler={rulesSourcesWithRuler}\n            queries={queries}\n            onClickSwitch={onClickSwitch}\n          />\n          {/* Expression Queries */}\n          <Stack direction=\"column\" gap={0}>\n            <Text element=\"h5\">Expressions</Text>\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              Manipulate data returned from queries with math and other operations.\n            </Text>\n          </Stack>\n\n          <ExpressionsEditor\n            queries={queries}\n            panelData={queryPreviewData}\n            condition={condition}\n            onSetCondition={handleSetCondition}\n            onRemoveExpression={(refId) => {\n              dispatch(removeExpression(refId));\n            }}\n            onUpdateRefId={onUpdateRefId}\n            onUpdateExpressionType={(refId, type) => {\n              dispatch(updateExpressionType({ refId, type }));\n            }}\n            onUpdateQueryExpression={(model) => {\n              dispatch(updateExpression(model));\n            }}\n          />\n          {/* action buttons */}\n          <Stack direction=\"row\">\n            {config.expressionsEnabled && <TypeSelectorButton onClickType={onClickType} />}\n\n            {isPreviewLoading && (\n              <Button icon=\"fa fa-spinner\" type=\"button\" variant=\"destructive\" onClick={cancelQueries}>\n                Cancel\n              </Button>\n            )}\n            {!isPreviewLoading && (\n              <Button icon=\"sync\" type=\"button\" onClick={runQueriesPreview} disabled={emptyQueries}>\n                Preview\n              </Button>\n            )}\n          </Stack>\n\n          {/* No Queries */}\n          {emptyQueries && (\n            <Alert title=\"No queries or expressions have been configured\" severity=\"warning\">\n              Create at least one query or expression to be alerted on\n            </Alert>\n          )}\n        </Stack>\n      )}\n    </RuleEditorSection>\n  );\n};\n\nfunction TypeSelectorButton({ onClickType }: { onClickType: (type: ExpressionQueryType) => void }) {\n  const newMenu = (\n    <Menu>\n      {expressionTypes.map((type) => (\n        <Tooltip key={type.value} content={type.description ?? ''} placement=\"right\">\n          <MenuItem\n            key={type.value}\n            onClick={() => onClickType(type.value ?? ExpressionQueryType.math)}\n            label={type.label ?? ''}\n          />\n        </Tooltip>\n      ))}\n    </Menu>\n  );\n\n  return (\n    <Dropdown overlay={newMenu}>\n      <Button variant=\"secondary\">\n        Add expression\n        <Icon name=\"angle-down\" />\n      </Button>\n    </Dropdown>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  addQueryButton: css`\n    width: fit-content;\n  `,\n  helpInfo: css`\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    width: fit-content;\n    font-weight: ${theme.typography.fontWeightMedium};\n    margin-left: ${theme.spacing(1)};\n    font-size: ${theme.typography.size.sm};\n    cursor: pointer;\n  `,\n  helpInfoText: css`\n    margin-left: ${theme.spacing(0.5)};\n    text-decoration: underline;\n  `,\n  infoLink: css`\n    color: ${theme.colors.text.link};\n  `,\n});\n\nconst useSetExpressionAndDataSource = () => {\n  const { setValue } = useFormContext<RuleFormValues>();\n\n  return (updatedQueries: AlertQuery[]) => {\n    // update data source name and expression if it's been changed in the queries from the reducer when prom or loki query\n    const query = updatedQueries[0];\n    if (!query) {\n      return;\n    }\n\n    const dataSourceSettings = getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n    if (!dataSourceSettings) {\n      throw new Error('The Data source has not been defined.');\n    }\n\n    if (isPromOrLokiQuery(query.model)) {\n      const expression = query.model.expr;\n      setValue('expression', expression);\n    }\n  };\n};\n","export function generateCopiedName(originalName: string, exisitingNames: string[]) {\n  const nonDuplicateName = originalName.replace(/\\(copy( [0-9]+)?\\)$/, '').trim();\n\n  let newName = `${nonDuplicateName} (copy)`;\n\n  for (let i = 2; exisitingNames.includes(newName); i++) {\n    newName = `${nonDuplicateName} (copy ${i})`;\n  }\n\n  return newName;\n}\n","import { css } from '@emotion/css';\nimport React, { CSSProperties } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\n\ninterface StackProps {\n  direction?: CSSProperties['flexDirection'];\n  alignItems?: CSSProperties['alignItems'];\n  wrap?: boolean;\n  gap?: number;\n  flexGrow?: CSSProperties['flexGrow'];\n  children: React.ReactNode;\n}\n\nexport function Stack(props: StackProps) {\n  const styles = useStyles2(getStyles, props);\n  return <div className={styles.root}>{props.children}</div>;\n}\n\nconst getStyles = (theme: GrafanaTheme2, props: StackProps) => ({\n  root: css({\n    display: 'flex',\n    flexDirection: props.direction ?? 'row',\n    flexWrap: props.wrap ?? true ? 'wrap' : undefined,\n    alignItems: props.alignItems,\n    gap: theme.spacing(props.gap ?? 2),\n    flexGrow: props.flexGrow,\n  }),\n});\n"],"names":["AlertWarning","title","children","Alert","warningStyles","theme","GrafanaRuleExportPreview","alertUid","exportFormat","onClose","ruleTextDefinition","isFetching","alertRuleApi","downloadFileName","LoadingPlaceholder","FileExportPreview","GrafanaRuleExporter","activeTab","setActiveTab","GrafanaExportDrawer","GroupAndNamespaceFields","rulesSourceName","control","watch","errors","setValue","style","getStyle","rulerRequests","useUnifiedAlertingSelector","state","dispatch","rulesConfig","namespace","namespaceOptions","groupOptions","group","Field","InputControl","onChange","ref","field","value","CloudEvaluationBehavior","styles","getStyles","register","type","dataSourceName","RuleEditorSection","Input","Select","time","PreviewRule","RecordingRulesNameSpaceAndGroupStep","AlertRuleForm","existing","prefill","notifyApp","queryParams","useQueryParams","showEditYaml","setShowEditYaml","evaluateEvery","setEvaluateEvery","routeParams","ruleType","uidFromParams","returnTo","showDeleteModal","setShowDeleteModal","defaultValues","formValuesFromPrefill","formValuesFromQueryParams","formAPI","handleSubmit","showDataSourceDependantStep","submitState","useCleanup","conditionErrorMsg","setConditionErrorMsg","checkAlertCondition","msg","submit","values","exitOnSave","key","deleteRule","identifier","onInvalid","config","cancelRuleCreation","evaluateEveryInForm","actionButtons","Button","Spinner","isCortexLokiOrRecordingRule","AppChromeUpdate","e","CustomScrollbar","Stack","AlertRuleNameInput","QueryAndExpressionsStep","GrafanaEvaluationBehavior","AnnotationsStep","NotificationsStep","ConfirmModal","RuleInspector","ruleDefinition","ruleFromQueryParams","rule","CloneRuleEditor","sourceRuleId","loading","error","useAsync","ruleClone","cloneRuleDefinition","formPrefill","changeRuleName","newName","ExistingRuleEditor","id","loadingAlertRule","result","dispatched","isEditable","loadingEditable","useIsRuleEditable","defaultPageNav","getPageNav","RuleEditor","match","searchParams","useURLSearchParams","copyFromId","copyFromIdentifier","canCreateGrafanaRules","canCreateCloudRules","canEditRules","getContent","AlertingPageWrapper","ModifyExportRuleForm","ruleForm","exportData","setExportData","formValues","GrafanaRuleDesignExporter","useGetGroup","nameSpace","dsFeatures","rulerConfig","getPayloadToExport","uid","existingGroup","grafanaRuleDto","updatedRule","alreadyExistsInGroup","updatedRules","useGetPayloadToExport","rulerGroupDto","GrafanaRuleDesignExportPreview","exportValues","getExport","loadingGroup","payload","GrafanaModifyExport","ruleIdentifier","setRuleIdentifier","loadingBuildInfo","alertRule","recordingRuleNameValidationPattern","ruleFormType","entityName","useGetAlertManagersSourceNamesAndImage","amConfigStatus","alertmanagerApi","externalDsAlertManagers","ds","alertmanagerChoice","NotificationPreviewByAlertManager","NotificationPreview","alertQueries","customLabels","condition","folder","alertName","disabled","previewEndpoint","trigger","data","isLoading","previewUninitialized","potentialInstances","label","onPreview","alertManagerSourceNamesAndImage","onlyOneAM","Text","alertManagerSource","labels","queries","shouldRenderPreview","NotificationsStepDescription","NeedHelpInfo","Icon","LabelsField","isCloudPreviewRequest","request","isGrafanaPreviewRequest","previewAlertRule","fetchAlertRulePreview","dataSourceUid","withLoadingIndicator","createResponse","map","catchError","of","toDataQueryError","share","PreviewRuleResult","props","preview","fieldConfig","width","height","PanelRenderer","fields","usePreview","allDataSourcesAvailable","useAlertQueriesStatus","isPreviewAvailable","setPreview","getValues","isMounted","useMountedState","createPreviewRequest","takeWhile","response","isCompleted","expression","dsSettings","useRulesSourcesWithRuler","dataSources","dsConfig","mapDataFrameToAlertPreview","labelFields","stateFieldIndex","infoFieldIndex","labelIndexes","labelField","instanceStatusCount","instances","index","labelValues","labelIndex","info","CloudAlertPreview","alertPreview","instanceTags","AlertStateTag","TagList","Tooltip","ExpressionEditor","showPreviewAlertsButton","mapToValue","mapToQuery","useQueryMappers","dataQuery","dataSource","onChangeQuery","query","onRunQueriesClick","dsi","errorMessage","previewLoaded","QueryEditor","previewDataFrame","s","previewHasAlerts","DataSourcePluginContextProvider","ExpressionsEditor","onSetCondition","panelData","onUpdateRefId","onRemoveExpression","onUpdateExpressionType","onUpdateQueryExpression","expressionQueries","acc","isAlertCondition","warning","Expression","QueryOptions","queryOptions","onChangeTimeRange","onChangeQueryOptions","showOptions","setShowOptions","timeRange","Toggletip","InlineField","RelativeTimeRangePicker","range","MaxDataPointsOption","options","MinIntervalOption","clearButton","DEFAULT_MAX_DATA_POINTS","DEFAULT_MIN_INTERVAL","QueryWrapper","onChangeDataSource","onRunQueries","onRemoveQuery","onDuplicateQuery","thresholds","thresholdsType","onChangeThreshold","dsInstance","setDsInstance","queryWithDefaults","SelectingDataSourceTooltip","HeaderExtras","alertQueryOptions","ExpressionStatusIndicator","showVizualisation","QueryEditorRow","settings","VizWrapper","EmptyQueryWrapper","onMaxDataPointsBlur","event","maxDataPointsNumber","maxDataPoints","onMinIntervalBlur","minInterval","QueryRows","onQueriesChange","q","item","itemIndex","updatedQueries","previousSettings","copyModel","newModel","startIndex","endIndex","update","removed","expressions","thresholdByRefId","provided","isCondition","DatasourceNotFound","defaultDataSource","onUpdateDatasource","model","refId","showDetails","setShowDetails","toggleDetails","show","handleUpdateDatasource","QueryOperationRow","Card","onChangeQueries","RecordingRuleEditor","runQueries","setData","handleChangedQuery","changedQuery","dataSourceId","expr","merged","CloudRulesSourcePicker","rulesSourcesWithRuler","dataSourceFilter","DataSourcePicker","CloudDataSourceSelector","onChangeCloudDatasource","getAvailableRuleTypes","defaultRuleType","enabledRuleTypes","onlyOneDSInQueries","getCanSwitch","availableRuleTypes","onlyOneDS","dataSourceIdFromQueries","isRecordingRuleType","canSwitchToCloudRule","dsJsonData","canSwitchToGrafanaRule","grafanaTypeEnabled","cloudTypeEnabled","canSwitchFromCloudToGrafana","canSwitchFromGrafanaToCloud","SmartAlertTypeDetector","editingExistingRule","onClickSwitch","canSwitch","disabledOptions","RadioButtonGroup","hasCyclicalReferences","findDataSourceFromExpressionRecursive","alertQuery","alertQueryReferenced","alertQuery_","findDataSourceFromExpression","firstReference","initialState","duplicateQuery","addNewDataQuery","setDataQueries","addNewExpression","removeExpression","removeExpressions","addExpressions","updateExpression","updateExpressionRefId","rewireExpressions","updateExpressionType","updateExpressionTimeRange","updateMaxDataPoints","updateMinInterval","setRecordingRulesQueries","queriesAndExpressionsReducer","builder","addQuery","datasource","recordingRuleQuery","action","dataSourceAlertQuery","relativeTimeRange","newState","newRefId","oldRefId","queryToAdd","defaultTimeRange","useAlertQueryRunner","queryPreviewData","setQueryPreviewData","runner","AlertingQueryRunner","currentRunner","clearPreviewData","cancelQueries","queriesToPreview","isPreviewLoading","d","onDataChange","isGrafanaManagedType","isCloudAlertRuleType","dispatchReduxAction","runQueriesPreview","noCompatibleDataSources","dataQueries","emptyQueries","currentCondition","previewData","handleSetCondition","updateExpressionAndDatasource","useSetExpressionAndDataSource","onChangeRecordingRulesQueries","recordingRuleDefaultDatasource","defaultQuery","lastRefId","onClickType","datasourceUid","newQueries","onChangeExpression","promLoki","removeExpressionsInQueries","addExpressionsInQueries","prevExpressions","setPrevExpressions","prevCondition","setPrevCondition","restoreExpressionsInQueries","newDsName","selectors","TypeSelectorButton","newMenu","Menu","MenuItem","Dropdown","generateCopiedName","originalName","exisitingNames","nonDuplicateName","i"],"sourceRoot":""}