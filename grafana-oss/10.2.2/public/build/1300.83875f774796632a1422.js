(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1300],{54522:(Ie,W,v)=>{"use strict";v.d(W,{a:()=>H});var I=v(39953),m=v(41407),N=v(69171),i=v(97250),o=v(38637),Y=v(99242),te=Object.defineProperty,re=Object.defineProperties,we=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,Q=(k,z,U)=>z in k?te(k,z,{enumerable:!0,configurable:!0,writable:!0,value:U}):k[z]=U,J=(k,z)=>{for(var U in z||(z={}))$.call(z,U)&&Q(k,U,z[U]);if(ie)for(var U of ie(z))w.call(z,U)&&Q(k,U,z[U]);return k},de=(k,z)=>re(k,we(z));const H=({config:k,onChange:z,className:U})=>{const Le=ee=>{z(de(J({},k),{jsonData:de(J({},k.jsonData),{keepCookies:ee})}))},Ce=ee=>{z(de(J({},k),{jsonData:de(J({},k.jsonData),{timeout:parseInt(ee.currentTarget.value,10)})}))},ft={container:(0,m.css)({maxWidth:578})};return I.createElement(Y._,{title:"Advanced HTTP settings",className:(0,m.cx)(ft.container,U)},I.createElement(N._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:k.readOnly,grow:!0},I.createElement(i.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:k.jsonData.keepCookies,onChange:Le})),I.createElement(N._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:k.readOnly,grow:!0},I.createElement(o.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:k.jsonData.timeout,onChange:Ce})))}},25243:(Ie,W,v)=>{"use strict";v.d(W,{i:()=>i});var I=v(41407),m=v(39953),N=v(82803);const i=({hideLine:Y=!1})=>{const te=(0,N.wW)(o);return Y?m.createElement("hr",{className:te.dividerHideLine}):m.createElement("hr",{className:te.divider})},o=Y=>({divider:(0,I.css)`
    margin: ${Y.spacing(4,0)};
  `,dividerHideLine:(0,I.css)`
    border: none;
    margin: ${Y.spacing(3,0)};
  `})},51300:(Ie,W,v)=>{"use strict";v.r(W),v.d(W,{plugin:()=>qi});var I=v(54721),m=v(36316),N=v(77014),i=v(41407),o=v(39953),Y=v(54554),te=v(33155),re=v(82803),we=v(54795),ie=v(99491),$=v(69171),w=v(38637);const Q=t=>(e,r)=>{const n={};for(const a in t)n[a]=t[a](e[a],r);return n},J=(t,e,r)=>(0,o.useCallback)(a=>{t(r(e,a))},[t,e,r]),de=(0,o.createContext)(void 0),H=()=>{const t=(0,o.useContext)(de);if(!t)throw new Error("Use DispatchContext first.");return t},k=t=>({name:t,pipelineAgg:""}),z=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,U=t=>t.settings?.model==="ewma",Le=t=>t.settings?.model==="holt",Ce=t=>t.settings?.model==="holt_winters",ft=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),ee=t=>R[t.type].requiresField,Qe=t=>R[t.type].isPipelineAgg,qe=t=>R[t.type].supportsMultipleBucketPaths,bs=t=>R[t.type].supportsMissing,gt=t=>R[t.type].hasSettings,he=t=>R[t.type].hasMeta,fe=t=>R[t.type].supportsInlineScript,Ue=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],Rt=t=>Ue.includes(t),R={count:{label:"Count",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[k(z([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,impliedQueryType:"raw_document",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,impliedQueryType:"raw_data",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,impliedQueryType:"logs",supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},Es={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},Lt=(t,e)=>{const r=e.filter(n=>qe(n)?n.pipelineVariables?.some(a=>a.pipelineAgg===t.id):ee(n)&&t.id===n.field);return[...r,...r.flatMap(n=>Lt(n,e))]},pt=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],Ss=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],Ge={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"},mt="3";function ye(t="1"){return{type:"count",id:t}}function ve(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const Qt=(t,e)=>t.find(r=>r.id===e);function Me(t,e){return!!t?.metrics?.some(r=>r.type===e)}function Ke(t){return t in Es}function xs(t){return!!R[t].supportsMultipleBucketPaths}var ke=v(64912);const ge=t=>ee(t)?`${R[t.type].label} ${t.field}`:R[t.type].label,Ye=t=>Object.entries(t).reduce((e,[r,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const a=Ye(n);return Object.keys(a).length===0?{...e}:{...e,[r]:a}}return{...e,[r]:n}},{}),ht=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},Ae=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",yt=t=>!!(0,ke.gte)(t,"7.16.0"),vt="Support for Elasticsearch versions after their end-of-life (currently versions < 7.16) was removed. Using unsupported version of Elasticsearch may lead to unexpected and incorrect results.",bt=t=>t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram";var L=v(77960);const Je=(0,L.PH)("@metrics/add"),Ze=(0,L.PH)("@metrics/remove"),Xe=(0,L.PH)("@metrics/toggle_visibility"),Be=(0,L.PH)("@metrics/change_field"),Te=(0,L.PH)("@metrics/change_type"),et=(0,L.PH)("@metrics/change_attr"),q=(0,L.PH)("@metrics/change_setting"),Et=(0,L.PH)("@metrics/change_meta"),_e=(0,L.PH)("init"),kt=(0,L.PH)("change_query"),Bt=(0,L.PH)("change_alias_pattern"),Fs=(t,e)=>kt.match(e)?e.payload:_e.match(e)?t||"":t,$s=(t,e)=>Bt.match(e)?e.payload:_e.match(e)?t||"":t;var St=v(36602);const Vt=()=>({label:"",query:"*"}),j={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[Vt()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:mt}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:St.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}},nested:{label:"Nested (experimental)",requiresField:!0,defaultSettings:{}}},Wt=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],xt=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],Is=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],tt=(0,L.PH)("@bucketAggs/add"),st=(0,L.PH)("@bucketAggs/remove"),jt=(0,L.PH)("@bucketAggs/change_type"),zt=(0,L.PH)("@bucketAggs/change_field"),G=(0,L.PH)("@bucketAggs/change_setting"),ws=t=>(e,r)=>{if(tt.match(r)){const n={id:r.payload,type:"terms",settings:j.terms.defaultSettings},a=e[e.length-1];return a?.type==="date_histogram"?[...e.slice(0,e.length-1),n,a]:[...e,n]}return st.match(r)?e.filter(n=>n.id!==r.payload):jt.match(r)?e.map(n=>n.id!==r.payload.id?n:{id:n.id,type:r.payload.newType,settings:j[r.payload.newType].defaultSettings}):zt.match(r)?e.map(n=>n.id!==r.payload.id?n:{...n,field:r.payload.newField}):Te.match(r)?R[r.payload.type].impliedQueryType!=="metrics"?[]:e.length===0?[{...ve("2"),field:t}]:e:G.match(r)?e.map(n=>{if(n.id!==r.payload.bucketAgg.id)return n;const a=Ye({...n.settings,[r.payload.settingName]:r.payload.newValue});return{...n,settings:{...a}}}):_e.match(r)?e&&e.length>0?e:[{...ve("2"),field:t}]:e},Cs=(t,e)=>{if(Je.match(e))return[...t,ye(e.payload)];if(Ze.match(e)){const r=t.find(u=>u.id===e.payload),n=[r,...Lt(r,t)],a=t.filter(u=>!n.some(f=>f.id===u.id));return a.length===0?[ye("1")]:a}return Te.match(e)?t.filter(r=>R[e.payload.type].impliedQueryType==="metrics"?!0:r.id===e.payload.id).map(r=>r.id!==e.payload.id?r:{id:r.id,type:e.payload.type,...R[e.payload.type].defaults}):Be.match(e)?t.map(r=>{if(r.id!==e.payload.id)return r;const n={...r,field:e.payload.field};return Qe(r)?{...n,pipelineAgg:e.payload.field}:n}):Xe.match(e)?t.map(r=>r.id!==e.payload?r:{...r,hide:!r.hide}):q.match(e)?t.map(r=>{if(r.id!==e.payload.metric.id)return r;if(gt(r)){const n=Ye({...r.settings,[e.payload.settingName]:e.payload.newValue});return{...r,settings:{...n}}}return r}):Et.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:he(r)?{...r,meta:{...r.meta,[e.payload.meta]:e.payload.newValue}}:r):et.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:{...r,[e.payload.attribute]:e.payload.newValue}):_e.match(e)?t&&t.length>0?t:[ye("1")]:t},Ht=(0,o.createContext)(void 0),qt=(0,o.createContext)(void 0),Ft=(0,o.createContext)(void 0),Ms=({children:t,onChange:e,onRunQuery:r,query:n,datasource:a,range:u})=>{const f=(0,o.useCallback)(C=>{e(C),r()},[e,r]),p=Q({query:Fs,alias:$s,metrics:Cs,bucketAggs:ws(a.timeField)}),h=J(C=>f({...n,...C,timeField:a.timeField}),n,p),g=!n.metrics||!n.bucketAggs||n.query===void 0,[y,S]=(0,o.useState)(g);return(0,o.useEffect)(()=>{y&&g&&(h(_e()),S(!1))},[y,h,g]),g?null:o.createElement(Ht.Provider,{value:a},o.createElement(qt.Provider,{value:n},o.createElement(Ft.Provider,{value:u},o.createElement(de.Provider,{value:h},t))))},Pe=t=>()=>{const e=(0,o.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},le=Pe(qt),Ut=Pe(Ht),As=Pe(Ft),ce=t=>t.id,rt=t=>parseInt(t,10),Ts=()=>{const{metrics:t,bucketAggs:e}=le();return(0,o.useMemo)(()=>(Math.max(...[...t?.map(ce)||["0"],...e?.map(ce)||["0"]].map(rt))+1).toString(),[t,e])};var De=v(4919),_=v(86832),$t=v(74661),be=v(27303),It=v(68497);const Gt=({children:t,label:e,onRemoveClick:r,onHideClick:n,hidden:a=!1})=>{const u=(0,re.wW)(Kt);return o.createElement($t.Z,null,o.createElement(be.m,null,o.createElement(ie.W,{width:17,as:"div"},o.createElement("span",null,e),o.createElement("span",{className:u.iconWrapper},n&&o.createElement(It.h,{name:a?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":a,className:u.icon,tooltip:"Hide row"}),o.createElement(It.h,{name:"trash-alt",size:"sm",className:u.icon,onClick:r||_.noop,disabled:!r,tooltip:"Remove row"})))),t)},Kt=t=>({iconWrapper:(0,i.css)`
      display: flex;
    `,icon:(0,i.css)`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var Yt=v(26005),Ve=v(60314),oe=v(31312);const it=t=>j[t.type].requiresField,_s=["date_histogram","histogram","terms","filters","geohash_grid","nested"],Jt=t=>_s.includes(t),Ps=t=>{if(Rt(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(Jt(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Zt=({text:t})=>({label:t,value:t}),nt=t=>{const e=Ut(),r=As(),n=Array.isArray(t)?t:Ps(t);let a;return async u=>(a||(a=await(0,oe.n)(e.getFields(n,r))),a.filter(({text:f})=>u===void 0||f.includes(u)).map(Zt))},Ee=(0,i.css)`
  min-width: 150px;
`;var Ds=v(12190);const Os=(t,e)=>({wrapper:(0,i.css)`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:(0,i.css)`
      padding-top: ${t.spacing(.5)};
    `,icon:(0,i.css)`
      margin-right: ${t.spacing(.5)};
    `,button:(0,i.css)`
      justify-content: start;
      ${e&&(0,i.css)`
        color: ${t.colors.text.disabled};
      `}
    `}),wt=({label:t,children:e,hidden:r=!1})=>{const[n,a]=(0,o.useState)(!1),u=(0,re.l4)(),f=Os(u,r);return o.createElement(be.m,null,o.createElement("div",{className:(0,i.cx)(f.wrapper)},o.createElement("button",{className:(0,i.cx)("gf-form-label query-part",f.button,Ee),onClick:()=>a(!n),"aria-expanded":n,type:"button"},o.createElement(Ds.J,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:f.icon}),t),n&&o.createElement("div",{className:f.settingsWrapper},e)))};var ne=v(9558),l=v(87783);const T=t=>({value:e})=>e===t,at=(t,e)=>e===void 0||t.some(T(e))?t:[...t,{value:e,label:e}],ae=({options:t,value:e,onChange:r})=>{const[n,a]=(0,o.useState)(at(t,e)),u=f=>a([...n,{value:f,label:f}]);return{onCreateOption:f=>{u(f),r({value:f})},onChange:r,allowCustomValue:!0,options:n,value:e}},Ct=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],x=t=>({value:e})=>e===t,lt=(t,e,r)=>!r.some(x(t))&&t.trim().length>0,ir=(t,e)=>t.value?.startsWith(e)||!1,ot=({bucketAgg:t})=>{const e=H(),{current:r}=(0,o.useRef)((0,_.uniqueId)("es-date_histogram-")),n=({value:a})=>e(G({bucketAgg:t,settingName:"interval",newValue:a}));return o.createElement(o.Fragment,null,o.createElement($._,{label:"Interval",...V},o.createElement(ne.Ph,{inputId:(0,_.uniqueId)("es-date_histogram-interval"),isValidNewOption:lt,filterOption:ir,...ae({options:Ct,value:t.settings?.interval||j.date_histogram.defaultSettings?.interval,onChange:n})})),o.createElement($._,{label:"Min Doc Count",...V},o.createElement(w.I,{id:`${r}-min_doc_count`,onBlur:a=>e(G({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||j.date_histogram.defaultSettings?.min_doc_count})),o.createElement($._,{label:"Trim Edges",...V,tooltip:"Trim the edges on the timeseries datapoints"},o.createElement(w.I,{id:`${r}-trime_edges`,onBlur:a=>e(G({bucketAgg:t,settingName:"trimEdges",newValue:a.target.value})),defaultValue:t.settings?.trimEdges||j.date_histogram.defaultSettings?.trimEdges})),o.createElement($._,{label:"Offset",...V,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},o.createElement(w.I,{id:`${r}-offset`,onBlur:a=>e(G({bucketAgg:t,settingName:"offset",newValue:a.target.value})),defaultValue:t.settings?.offset||j.date_histogram.defaultSettings?.offset})),o.createElement($._,{label:"Timezone",...V},o.createElement(l.O,{value:t.settings?.timeZone||j.date_histogram.defaultSettings?.timeZone,includeInternal:[St.RQ.utc],onChange:a=>{e(G({bucketAgg:t,settingName:"timeZone",newValue:a}))}})))},Ns=({index:t,onAdd:e,onRemove:r,elements:n})=>o.createElement("div",{className:(0,i.css)`
        display: flex;
      `},t===0&&o.createElement(De.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:e,tooltip:"Add","aria-label":"Add"}),n.length>=2&&o.createElement(De.zx,{variant:"secondary",fill:"text",icon:"minus",onClick:r,tooltip:"Remove","aria-label":"Remove"})),Xt=(0,L.PH)("@bucketAggregations/filter/add"),O=(0,L.PH)("@bucketAggregations/filter/remove"),Se=(0,L.PH)("@bucketAggregations/filter/change"),Rs=(t=[],e)=>Xt.match(e)?[...t,Vt()]:O.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Se.match(e)?t.map((r,n)=>n!==e.payload.index?r:e.payload.filter):t,Ls=({bucketAgg:t})=>{const{current:e}=(0,o.useRef)((0,_.uniqueId)("es-filters-")),r=H(),n=J(a=>r(G({bucketAgg:t,settingName:"filters",newValue:a})),t.settings?.filters,Rs);return(0,o.useEffect)(()=>{t.settings?.filters?.length||n(Xt())},[n,t.settings?.filters?.length]),o.createElement(o.Fragment,null,o.createElement("div",{className:(0,i.css)`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((a,u)=>o.createElement("div",{key:u,className:(0,i.css)`
              display: flex;
            `},o.createElement($._,{label:"Query",labelWidth:8},o.createElement("div",{className:(0,i.css)`
                  width: 150px;
                `},o.createElement(we.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onChange:f=>n(Se({index:u,filter:{...a,query:f}})),query:a.query}))),o.createElement($._,{label:"Label",labelWidth:8},o.createElement(w.I,{width:16,id:`${e}-label-${u}`,placeholder:"Label",onBlur:f=>n(Se({index:u,filter:{...a,label:f.target.value}})),defaultValue:a.label})),o.createElement(Ns,{index:u,elements:t.settings?.filters||[],onAdd:()=>n(Xt()),onRemove:()=>n(O(u))})))))},es=({bucketAgg:t})=>{const{metrics:e}=le(),r=Qs(e),{current:n}=(0,o.useRef)((0,_.uniqueId)("es-terms-")),a=H();return o.createElement(o.Fragment,null,o.createElement($._,{label:"Order",...V},o.createElement(ne.Ph,{inputId:`${n}-order`,onChange:u=>a(G({bucketAgg:t,settingName:"order",newValue:u.value})),options:xt,value:t.settings?.order||j.terms.defaultSettings?.order})),o.createElement($._,{label:"Size",...V},o.createElement(ne.Ph,{inputId:`${n}-size`,...ae({options:Is,value:t.settings?.size||j.terms.defaultSettings?.size,onChange({value:u}){a(G({bucketAgg:t,settingName:"size",newValue:u}))}})})),o.createElement($._,{label:"Min Doc Count",...V},o.createElement(w.I,{id:`${n}-min_doc_count`,onBlur:u=>a(G({bucketAgg:t,settingName:"min_doc_count",newValue:u.target.value})),defaultValue:t.settings?.min_doc_count||j.terms.defaultSettings?.min_doc_count})),o.createElement($._,{label:"Order By",...V},o.createElement(ne.Ph,{inputId:`${n}-order_by`,onChange:u=>a(G({bucketAgg:t,settingName:"orderBy",newValue:u.value})),options:r,value:t.settings?.orderBy||j.terms.defaultSettings?.orderBy})),o.createElement($._,{label:"Missing",...V},o.createElement(w.I,{id:`${n}-missing`,onBlur:u=>a(G({bucketAgg:t,settingName:"missing",newValue:u.target.value})),defaultValue:t.settings?.missing||j.terms.defaultSettings?.missing})))};function ts(t){return t.meta?Object.keys(t.meta).filter(r=>t.meta?.[r]).map(r=>{let n=r;return r==="std_deviation_bounds_lower"&&(n="std_lower"),r==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${ge(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function We(t){return t.settings?.percents?t.settings.percents.map(e=>{const r=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${ge(t)} (${e})`,value:`${t.id}[${r}]`}}):[]}function F(t){return t.type!=="top_metrics"&&!Qe(t)}const Qs=(t=[])=>{const e=t.filter(F).flatMap(r=>r.type==="extended_stats"?ts(r):r.type==="percentiles"?We(r):{label:ge(r),value:r.id});return[...Wt,...e]},Mt=t=>e=>e.value===t,ss=t=>{const{metrics:e}=le();switch(t.type){case"terms":{const r=t.settings?.order||"desc",n=t.settings?.size||"10",a=parseInt(t.settings?.min_doc_count||"0",10),u=t.settings?.orderBy||"_term";let f="";n!=="0"&&(f=`${xt.find(Mt(r))?.label} ${n}, `),a>0&&(f+=`Min Doc Count: ${a}, `),f+="Order by: ";const p=Wt.find(Mt(u));if(p)f+=p.label;else{const h=e?.find(g=>g.id===ht(u));h?f+=ge(h):f+="metric not found"}return n==="0"&&(f+=` (${r})`),f}case"histogram":{const r=t.settings?.interval||"1000",n=parseInt(t.settings?.min_doc_count||"1",10);return`Interval: ${r}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||j.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${parseInt(t.settings?.precision||mt,10)}`;case"date_histogram":{const r=t.settings?.interval||"auto",n=parseInt(t.settings?.min_doc_count||"0",10),a=parseInt(t.settings?.trimEdges||"0",10);let u=`Interval: ${r}`;return n>0&&(u+=`, Min Doc Count: ${n}`),a>0&&(u+=`, Trim edges: ${a}`),u}default:return"Settings"}},V={labelWidth:16},rs=({bucketAgg:t})=>{const{current:e}=(0,o.useRef)((0,_.uniqueId)("es-setting-")),r=H(),n=ss(t);return o.createElement(wt,{label:n},t.type==="terms"&&o.createElement(es,{bucketAgg:t}),t.type==="date_histogram"&&o.createElement(ot,{bucketAgg:t}),t.type==="filters"&&o.createElement(Ls,{bucketAgg:t}),t.type==="geohash_grid"&&o.createElement($._,{label:"Precision",...V},o.createElement(w.I,{id:`${e}-geohash_grid-precision`,onBlur:a=>r(G({bucketAgg:t,settingName:"precision",newValue:a.target.value})),defaultValue:t.settings?.precision||j[t.type].defaultSettings?.precision})),t.type==="histogram"&&o.createElement(o.Fragment,null,o.createElement($._,{label:"Interval",...V},o.createElement(w.I,{id:`${e}-histogram-interval`,onBlur:a=>r(G({bucketAgg:t,settingName:"interval",newValue:a.target.value})),defaultValue:t.settings?.interval||j[t.type].defaultSettings?.interval})),o.createElement($._,{label:"Min Doc Count",...V},o.createElement(w.I,{id:`${e}-histogram-min_doc_count`,onBlur:a=>r(G({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||j[t.type].defaultSettings?.min_doc_count}))))},is=Object.entries(j).map(([t,{label:e}])=>({label:e,value:t})),ks=t=>({label:j[t.type].label,value:t.type}),At=({value:t})=>{const e=H(),r=nt(t.type);return o.createElement(o.Fragment,null,o.createElement(be.m,null,o.createElement(Yt.X,{className:Ee,options:is,onChange:n=>e(jt({id:t.id,newType:n.value})),value:ks(t)}),it(t)&&o.createElement(Ve.V,{className:Ee,loadOptions:r,onChange:n=>e(zt({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),o.createElement(rs,{bucketAgg:t}))},Bs=({nextId:t})=>{const e=H(),{bucketAggs:r}=le(),n=r?.length||0;return o.createElement(o.Fragment,null,r.map((a,u)=>o.createElement(Gt,{key:`${a.type}-${a.id}`,label:u===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(st(a.id)))},o.createElement(At,{value:a}),u===0&&o.createElement(De.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(tt(t)),tooltip:"Add grouping condition","aria-label":"Add grouping condition"}))))};var xe=v(26286);const pe=(0,i.css)`
  white-space: nowrap;
`,Tt=t=>({label:ge(t),value:t}),ns=t=>t.map(Tt),as=({options:t,onChange:e,className:r,value:n})=>{const a=t.find(u=>u.id===n);return o.createElement(Yt.X,{className:(0,i.cx)(r,pe),options:ns(t),onChange:e,placeholder:"Select Metric",value:a?Tt(a):void 0})};function Z({label:t,settingName:e,metric:r,placeholder:n,tooltip:a}){const u=H(),[f]=(0,o.useState)((0,_.uniqueId)("es-field-id-"));let h=r.settings?.[e]||"";return e==="script"&&(h=Ae(r)),o.createElement($._,{label:t,labelWidth:16,tooltip:a},o.createElement(w.I,{id:f,placeholder:n,onBlur:g=>u(q({metric:r,settingName:e,newValue:g.target.value})),defaultValue:h}))}const ct=(0,L.PH)("@pipelineVariables/add"),_t=(0,L.PH)("@pipelineVariables/remove"),je=(0,L.PH)("@pipelineVariables/rename"),ls=(0,L.PH)("@pipelineVariables/change_metric"),os=(t=[],e)=>ct.match(e)?[...t,k(z(t))]:_t.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):je.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,name:e.payload.newName}):ls.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,pipelineAgg:e.payload.newMetric}):t,Vs=({value:t,previousMetrics:e})=>{const r=H(),n=J(a=>r(et({metric:t,attribute:"pipelineVariables",newValue:a})),t.pipelineVariables,os);return(0,o.useEffect)(()=>{t.pipelineVariables?.length||n(ct())},[n,t.pipelineVariables?.length]),o.createElement(o.Fragment,null,o.createElement("div",{className:(0,i.css)`
          display: flex;
        `},o.createElement(ie.W,{width:16},"Variables"),o.createElement("div",{className:(0,i.css)`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((a,u)=>o.createElement(o.Fragment,{key:(0,_.uniqueId)("es-bs-")},o.createElement("div",{className:(0,i.css)`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},o.createElement(w.I,{"aria-label":"Variable name",defaultValue:a.name,placeholder:"Variable Name",onBlur:f=>n(je({newName:f.target.value,index:u}))}),o.createElement(as,{onChange:f=>n(ls({newMetric:f.value.id,index:u})),options:e,value:a.pipelineAgg})),o.createElement(Ns,{index:u,elements:t.pipelineVariables||[],onAdd:()=>n(ct()),onRemove:()=>n(_t(u))}))))),o.createElement(Z,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},Ws=({metric:t})=>{const e=H(),{current:r}=(0,o.useRef)((0,_.uniqueId)("es-moving-avg-"));return o.createElement(o.Fragment,null,o.createElement($._,{label:"Model",labelWidth:16},o.createElement(ne.Ph,{inputId:`${r}-model`,onChange:n=>e(q({metric:t,settingName:"model",newValue:n.value})),options:Ss,value:t.settings?.model})),o.createElement(Z,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),o.createElement(Z,{label:"Predict",settingName:"predict",metric:t}),(U(t)||Le(t)||Ce(t))&&o.createElement($._,{label:"Alpha",labelWidth:16},o.createElement(w.I,{id:`${r}-alpha`,onBlur:n=>e(q({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(Le(t)||Ce(t))&&o.createElement($._,{label:"Beta",labelWidth:16},o.createElement(w.I,{id:`${r}-beta`,onBlur:n=>e(q({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),Ce(t)&&o.createElement(o.Fragment,null,o.createElement($._,{label:"Gamma",labelWidth:16},o.createElement(w.I,{id:`${r}-gamma`,onBlur:n=>e(q({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),o.createElement($._,{label:"Period",labelWidth:16},o.createElement(w.I,{id:`${r}-period`,onBlur:n=>e(q({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),o.createElement($._,{label:"Pad",labelWidth:16},o.createElement(xe.x,{id:`${r}-pad`,onChange:n=>e(q({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(U(t)||Le(t)||Ce(t))&&o.createElement($._,{label:"Minimize",labelWidth:16},o.createElement(xe.x,{id:`${r}-minimize`,onChange:n=>e(q({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},cs=t=>({value:t,label:t}),us=({metric:t})=>{const e=H(),r=nt(["number","date"]),n=nt(t.type);return o.createElement(o.Fragment,null,o.createElement($._,{label:"Metrics",labelWidth:16},o.createElement(ne.M8,{onChange:a=>e(q({metric:t,settingName:"metrics",newValue:a.map(u=>u.value)})),loadOptions:n,value:t.settings?.metrics?.map(cs),closeMenuOnSelect:!1,defaultOptions:!0})),o.createElement($._,{label:"Order",labelWidth:16},o.createElement(ne.Ph,{onChange:a=>e(q({metric:t,settingName:"order",newValue:a.value})),options:xt,value:t.settings?.order})),o.createElement($._,{label:"Order By",labelWidth:16,className:(0,i.css)`
          & > div {
            width: 100%;
          }
        `},o.createElement(Ve.V,{className:(0,i.css)`
            margin-right: 0;
          `,loadOptions:r,onChange:a=>e(q({metric:t,settingName:"orderBy",newValue:a.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},js=t=>e=>e.value===t,Fe=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([r,n])=>n&&pt.find(js(r))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},Oe={labelWidth:16},ut=({metric:t,previousMetrics:e})=>{const{current:r}=(0,o.useRef)((0,_.uniqueId)("es-setting-")),n=H(),a=Fe(t),u=(0,o.useId)(),f=(0,o.useId)(),p=(0,o.useId)(),h=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],g=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return o.createElement(wt,{label:a,hidden:t.hide},t.type==="derivative"&&o.createElement(Z,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&o.createElement(Z,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&o.createElement(Z,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&o.createElement(Ws,{metric:t}),t.type==="moving_fn"&&o.createElement(o.Fragment,null,o.createElement(Z,{label:"Window",metric:t,settingName:"window"}),o.createElement(Z,{label:"Script",metric:t,settingName:"script"}),o.createElement(Z,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&o.createElement(us,{metric:t}),t.type==="bucket_script"&&o.createElement(Vs,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&o.createElement($._,{label:"Size",...Oe,htmlFor:u},o.createElement(w.I,{id:u,onBlur:y=>n(q({metric:t,settingName:"size",newValue:y.target.value})),defaultValue:t.settings?.size??R.raw_data.defaults.settings?.size})),t.type==="logs"&&o.createElement(Z,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&o.createElement(Z,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&o.createElement(o.Fragment,null,pt.map(y=>o.createElement(zs,{key:y.value,stat:y,onChange:S=>n(Et({metric:t,meta:y.value,newValue:S})),value:t.meta?.[y.value]!==void 0?!!t.meta?.[y.value]:!!R.extended_stats.defaults.meta?.[y.value]})),o.createElement(Z,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&o.createElement($._,{label:"Percentiles",...Oe},o.createElement(w.I,{id:`${r}-percentiles-percents`,onBlur:y=>n(q({metric:t,settingName:"percents",newValue:y.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||R.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&o.createElement(o.Fragment,null,o.createElement($._,{label:"Unit",...Oe,"data-testid":"unit-select",htmlFor:f},o.createElement(ne.Ph,{id:f,onChange:y=>n(q({metric:t,settingName:"unit",newValue:y.value})),options:h,value:t.settings?.unit})),o.createElement($._,{label:"Mode",...Oe,"data-testid":"mode-select",htmlFor:p},o.createElement(ne.Ph,{id:p,onChange:y=>n(q({metric:t,settingName:"mode",newValue:y.value})),options:g,value:t.settings?.unit}))),fe(t)&&o.createElement(Z,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),bs(t)&&o.createElement(Z,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},zs=({stat:t,onChange:e,value:r})=>{const[n]=(0,o.useState)((0,_.uniqueId)("es-field-id-"));return o.createElement($._,{label:t.label,...Oe,key:t.value},o.createElement(xe.x,{id:n,onChange:a=>e(a.target.checked),value:r}))},A=({name:t,metric:e})=>{const r=[];return o.createElement($t.Z,null,o.createElement(be.m,null,o.createElement(ie.W,{width:17,as:"div"},o.createElement("span",null,t))),o.createElement(ut,{metric:e,previousMetrics:r}))},Pt=(t,e)=>({color:e&&(0,i.css)`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),s=t=>({label:R[t.type].label,value:t.type}),c=t=>!R[t.type].isPipelineAgg,d=(t,e)=>{const r=t.some(c);return Object.entries(R).filter(([n,a])=>a.impliedQueryType==="metrics").filter(([n,{versionRange:a="*"}])=>e!=null?(0,ke.satisfies)(e,a):!0).filter(([n,a])=>r||!a.isPipelineAgg).map(([n,{label:a}])=>({label:a,value:n}))},b=({value:t})=>{const e=Pt((0,re.l4)(),!!t.hide),r=Ut(),n=le(),a=H(),u=nt(t.type),f=async g=>{const y=await r.getDatabaseVersion();return d(g,y)},p=(0,o.useCallback)(async()=>{const g=await u();return fe(t)?[{label:"None"},...g]:g},[u,t]),h=n.metrics.slice(0,n.metrics.findIndex(g=>g.id===t.id));return o.createElement(o.Fragment,null,o.createElement(be.m,null,o.createElement(Ve.V,{className:(0,i.cx)(e.color,Ee),loadOptions:()=>f(h),onChange:g=>a(Te({id:t.id,type:g.value})),value:s(t)}),ee(t)&&!Qe(t)&&o.createElement(Ve.V,{className:(0,i.cx)(e.color,Ee),loadOptions:p,onChange:g=>a(Be({id:t.id,field:g.value})),placeholder:"Select Field",value:t.field}),Qe(t)&&!qe(t)&&o.createElement(as,{className:(0,i.cx)(e.color,Ee),onChange:g=>a(Be({id:t.id,field:g.value?.id})),options:h,value:t.field})),gt(t)&&o.createElement(ut,{metric:t,previousMetrics:h}))},E=({nextId:t})=>{const e=H(),{metrics:r}=le(),n=r?.length||0;return o.createElement(o.Fragment,null,r?.map((a,u)=>{switch(a.type){case"logs":return o.createElement(A,{key:`${a.type}-${a.id}`,name:"Logs",metric:a});case"raw_data":return o.createElement(A,{key:`${a.type}-${a.id}`,name:"Raw Data",metric:a});case"raw_document":return o.createElement(o.Fragment,null,o.createElement(A,{key:`${a.type}-${a.id}`,name:"Raw Document",metric:a}),o.createElement(te.b,{severity:"warning",title:"The 'Raw Document' query type is deprecated."}));default:return o.createElement(Gt,{key:`${a.type}-${a.id}`,label:`Metric (${a.id})`,hidden:a.hide,onHideClick:()=>e(Xe(a.id)),onRemoveClick:n>1&&(()=>e(Ze(a.id)))},o.createElement(b,{value:a}),R[a.type].impliedQueryType==="metrics"&&u===0&&o.createElement(De.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(Je(t)),tooltip:"Add metric","aria-label":"Add metric"}))}}))};var P=v(20454);const M=[{value:"metrics",label:"Metrics"},{value:"logs",label:"Logs"},{value:"raw_data",label:"Raw Data"},{value:"raw_document",label:"Raw Document"}];function se(t){switch(t){case"logs":case"raw_data":case"raw_document":return t;case"metrics":return"count";default:throw new Error(`invalid query type: ${t}`)}}const Ar=()=>{const t=le(),e=H(),r=t.metrics?.[0];if(r==null)return null;const n=R[r.type].impliedQueryType,a=u=>{e(Te({id:r.id,type:se(u)}))};return o.createElement(P.S,{fullWidth:!1,options:M,value:n,onChange:a})};function Tr(t){const[e,r]=(0,o.useState)(null);return(0,o.useEffect)(()=>{let n=!1;return t.getDatabaseVersion().then(a=>{n||r(a)},a=>{console.log(a)}),()=>{n=!0}},[t]),e}const _r=({query:t,onChange:e,onRunQuery:r,datasource:n,range:a})=>{const u=Tr(n),f=u!=null&&!yt(u);return o.createElement(Ms,{datasource:n,onChange:e,onRunQuery:r,query:t,range:a||(0,Y.JK)()},f&&o.createElement(te.b,{title:vt}),o.createElement(Pr,{value:t}))},nr=t=>({root:(0,i.css)`
    display: flex;
  `,queryItem:(0,i.css)`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),ar=({value:t,onChange:e})=>{const r=(0,re.wW)(nr);return o.createElement("div",{className:r.queryItem},o.createElement(we.q,{query:t,onChange:e,placeholder:"Enter a lucene query",portalOrigin:"elasticsearch"}))},Pr=({value:t})=>{const e=H(),r=Ts(),n=(0,o.useId)(),a=(0,re.wW)(nr),u=bt(t),f=t.metrics?.every(p=>R[p.type].impliedQueryType==="metrics");return o.createElement(o.Fragment,null,o.createElement("div",{className:a.root},o.createElement(ie.W,{width:17},"Query type"),o.createElement("div",{className:a.queryItem},o.createElement(Ar,null))),o.createElement("div",{className:a.root},o.createElement(ie.W,{width:17},"Lucene Query"),o.createElement(ar,{onChange:p=>e(kt(p)),value:t?.query}),u&&o.createElement($._,{label:"Alias",labelWidth:15,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",htmlFor:n},o.createElement(w.I,{id:n,placeholder:"Alias Pattern",onBlur:p=>e(Bt(p.currentTarget.value)),defaultValue:t.alias}))),o.createElement(E,{nextId:r}),f&&o.createElement(Bs,{nextId:r}))};var Dr=v(30559),Or=v(28789),Nr=v(17613),Rr=v(66211),Lr=v(84461),Hs=v(37962),Qr=v(27770),kr=v(54522),Br=v(47169),dt=v(25243),lr=v(50820),Vr=v(24824),Wr=v(69733),qs=v(99242),Us=v(43997),jr=v(7763),zr=v(64084),Hr=v(95540),qr=v(92811);const Ur=(0,zr.B)(()=>({firstRow:(0,i.css)`
    display: flex;
  `,nameField:(0,i.css)`
    flex: 2;
  `,regexField:(0,i.css)`
    flex: 3;
  `,row:(0,i.css)`
    display: flex;
    align-items: baseline;
  `,urlField:(0,i.css)`
    display: flex;
    flex: 1;
  `,urlDisplayLabelField:(0,i.css)`
    flex: 1;
  `})),Gr=t=>{const{value:e,onChange:r,onDelete:n,suggestions:a,className:u}=t,f=Ur(),[p,h]=Kr(e.datasourceUid),g=y=>S=>{r({...e,[y]:S.currentTarget.value})};return o.createElement("div",{className:u},o.createElement("div",{className:f.firstRow},o.createElement($._,{label:"Field",htmlFor:"elasticsearch-datasource-config-field",labelWidth:12,tooltip:"Can be exact field name or a regex pattern that will match on the field name."},o.createElement(w.I,{type:"text",id:"elasticsearch-datasource-config-field",value:e.field,onChange:g("field"),width:100})),o.createElement(De.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:y=>{y.preventDefault(),n()}})),o.createElement($t.Z,null,o.createElement("div",{className:f.urlField},o.createElement(ie.W,{htmlFor:"elasticsearch-datasource-internal-link",width:12},p?"Query":"URL"),o.createElement(Hr.v,{placeholder:p?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:y=>r({...e,url:y}),suggestions:a})),o.createElement("div",{className:f.urlDisplayLabelField},o.createElement($._,{label:"URL Label",htmlFor:"elasticsearch-datasource-url-label",labelWidth:14,tooltip:"Use to override the button label."},o.createElement(w.I,{type:"text",id:"elasticsearch-datasource-url-label",value:e.urlDisplayLabel,onChange:g("urlDisplayLabel")})))),o.createElement("div",{className:f.row},o.createElement($._,{label:"Internal link",labelWidth:12},o.createElement(xe.x,{label:"Internal link",value:p||!1,onChange:()=>{p&&r({...e,datasourceUid:void 0}),h(!p)}})),p&&o.createElement(qr.q,{tracing:!0,onChange:y=>{r({...e,datasourceUid:y.uid})},current:e.datasourceUid})))};function Kr(t){const[e,r]=(0,o.useState)(!!t),n=(0,jr.Z)(t);return(0,o.useEffect)(()=>{!n&&t&&!e&&r(!0),n&&!t&&e&&r(!1)},[n,t,e]),[e,r]}const Yr=t=>({addButton:(0,i.css)`
      margin-right: 10px;
    `,container:(0,i.css)`
      margin-bottom: ${t.spacing(2)};
    `,dataLink:(0,i.css)`
      margin-bottom: ${t.spacing(1)};
    `}),Jr=t=>{const{value:e,onChange:r}=t,n=(0,re.wW)(Yr);return o.createElement(qs._,{title:"Data links",description:o.createElement(Us.W,{description:"Add links to existing fields. Links will be shown in log row details next to the field value.",suffix:"elasticsearch/#data-links",feature:"Elasticsearch data links"})},o.createElement("div",{className:n.container},e&&e.length>0&&o.createElement("div",{className:"gf-form-group"},e.map((a,u)=>o.createElement(Gr,{className:n.dataLink,key:u,value:a,onChange:f=>{const p=[...e];p.splice(u,1,f),r(p)},onDelete:()=>{const f=[...e];f.splice(u,1),r(f)},suggestions:[{value:Vr.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:Wr.L8.Value}]}))),o.createElement(De.zx,{type:"button",variant:"secondary",className:n.addButton,icon:"plus",onClick:a=>{a.preventDefault();const u=[...e||[],{field:"",url:""}];r(u)}},"Add")))},Gs=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],Zr=({value:t,onChange:e})=>o.createElement(qs._,{title:"Elasticsearch details",description:o.createElement(Us.W,{description:"Specific settings for the Elasticsearch data source.",suffix:"elasticsearch/#index-settings",feature:"Elasticsearch details"})},o.createElement($._,{label:"Index name",htmlFor:"es_config_indexName",labelWidth:29,tooltip:"Name of your Elasticsearch index. You can use a time pattern, such as YYYY.MM.DD, or a wildcard for the index name."},o.createElement(w.I,{id:"es_config_indexName",value:t.jsonData.index??(t.database||""),onChange:Xr(t,e),width:24,placeholder:"es-index-name",required:!0})),o.createElement($._,{label:"Pattern",htmlFor:"es_config_indexPattern",labelWidth:29,tooltip:"If you're using a pattern for your index, select the type, or no pattern."},o.createElement(ne.Ph,{inputId:"es_config_indexPattern",value:Gs.find(r=>r.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:Gs,onChange:ei(t,e),width:24})),o.createElement($._,{label:"Time field name",htmlFor:"es_config_timeField",labelWidth:29,tooltip:"Name of your time field. Defaults to @timestamp."},o.createElement(w.I,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:Ks("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),o.createElement($._,{label:"Max concurrent Shard Requests",htmlFor:"es_config_shardRequests",labelWidth:29,tooltip:"Maximum number of concurrent shards a search request can hit per node. Defaults to 5."},o.createElement(w.I,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:Ks("maxConcurrentShardRequests",t,e),width:24})),o.createElement($._,{label:"Min time interval",htmlFor:"es_config_minTimeInterval",labelWidth:29,tooltip:o.createElement(o.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",o.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},o.createElement(w.I,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:Ks("timeInterval",t,e),width:24,placeholder:"10s"})),o.createElement($._,{label:"X-Pack enabled",labelWidth:29,tooltip:"Enable or disable X-Pack specific features"},o.createElement(xe.x,{id:"es_config_xpackEnabled",value:t.jsonData.xpack||!1,onChange:or("xpack",t,e)})),t.jsonData.xpack&&o.createElement($._,{label:"Include Frozen Indices",htmlFor:"es_config_frozenIndices",labelWidth:29,tooltip:"Include frozen indices in searches."},o.createElement(xe.x,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:or("includeFrozen",t,e)}))),Xr=(t,e)=>r=>{e({...t,database:"",jsonData:{...t.jsonData,index:r.currentTarget.value}})},Ks=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},or=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},ei=(t,e)=>r=>{const n=r.value==="none"?void 0:r.value,a=t.jsonData.index??t.database;if(!a||a.length===0||a.startsWith("[logstash-]")){let u="";if(n!==void 0){const f=Gs.find(p=>p.value===n);f&&(u=f.example??"")}e({...t,database:"",jsonData:{...t.jsonData,index:u,interval:n}})}else e({...t,jsonData:{...t.jsonData,interval:n}})};function ti(){return 5}const si=t=>{const{value:e,onChange:r}=t,n=a=>u=>{r({...e,[a]:u.currentTarget.value})};return o.createElement(qs._,{title:"Logs",description:o.createElement(Us.W,{description:"Configure which fields the data source uses for log messages and log levels.",suffix:"elasticsearch/#logs",feature:"Elasticsearch log fields"})},o.createElement($._,{label:"Message field name",labelWidth:22,tooltip:"Configure the field to be used for log messages."},o.createElement(w.I,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),o.createElement($._,{label:"Level field name",labelWidth:22,tooltip:"Configure the field that determines the level of each log message."},o.createElement(w.I,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},ri=t=>({...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||ti(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}),ii=t=>!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,ni=t=>{const{options:e,onOptionsChange:r}=t;(0,o.useEffect)(()=>{ii(e)||r(ri(e))},[r,e]);const n=(0,Or.T2)({config:e,onChange:r});return lr.config.sigV4AuthEnabled&&(n.customMethods=[{id:"custom-sigv4",label:"SigV4 auth",description:"AWS Signature Version 4 authentication",component:o.createElement(Dr.IW,{inExperimentalAuthComponent:!0,...t})}],n.selectedMethod=e.jsonData.sigV4Auth?"custom-sigv4":n.selectedMethod),o.createElement(o.Fragment,null,e.access==="direct"&&o.createElement(te.b,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),o.createElement(Nr.j,{dataSourceName:"Elasticsearch",docsLink:"https://grafana.com/docs/grafana/latest/datasources/elasticsearch",hasRequiredFields:!1}),o.createElement(dt.i,null),o.createElement(Rr.f,{config:e,onChange:r,urlPlaceholder:"http://localhost:9200"}),o.createElement(dt.i,null),o.createElement(Lr.g,{...n,onAuthMethodSelect:a=>{r({...e,basicAuth:a===Hs.H.BasicAuth,withCredentials:a===Hs.H.CrossSiteCredentials,jsonData:{...e.jsonData,sigV4Auth:a==="custom-sigv4",oauthPassThru:a===Hs.H.OAuthForward}})}}),o.createElement(dt.i,null),o.createElement(Qr.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},o.createElement(kr.a,{config:e,onChange:r}),o.createElement(dt.i,{hideLine:!0}),lr.config.secureSocksDSProxyEnabled&&o.createElement(Br.i,{options:e,onOptionsChange:r}),o.createElement(Zr,{value:e,onChange:r}),o.createElement(dt.i,{hideLine:!0}),o.createElement(si,{value:e.jsonData,onChange:a=>r({...e,jsonData:a})}),o.createElement(dt.i,{hideLine:!0}),o.createElement(Jr,{value:e.jsonData.dataLinks,onChange:a=>{r({...e,jsonData:{...e.jsonData,dataLinks:a}})}})))};var ai=v(3747),ds=v(22605),Dt=v(63302),fs=v(10752),cr=v(84289),li=v(48140),oi=v(12202),ci=v(5632),ze=v(71476),ur=v(82696),X=v(69323),ui=v(81626),Ys=v(96083),K=v(92403),$e=v(89591),di=v(92743),Ne=v(32688),fi=v(26205),gi=v(6278),pi=v(41182),dr=v(41891),mi=v(20810);const fr={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class hi{constructor(e,r){this.pattern=e,this.interval=r,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,K.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,r){if(!this.interval)return this.pattern;const a=fr[this.interval],u=(0,K.CQ)(e||(0,K.CQ)(r).add(-7,a.amount)).utc().startOf(a.startOf),f=(0,K.CQ)(r||(0,K.CQ)(e).add(7,a.amount)).utc().startOf(a.startOf).valueOf(),p=[];for(;u.valueOf()<=f;)p.push(u.locale(this.dateLocale).format(this.pattern)),u.add(1,a.amount);return p}}var gs=v(30976);class yi extends I.iL{constructor(e,r){super(),this.datasource=e,Object.assign(this,r)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(r=>{switch(r.operator){case gs.K2.Equal:return r.name+':"'+r.value+'"';case gs.K2.NotEqual:return"-"+r.name+':"'+r.value+'"';case gs.K2.EqualRegEx:return r.name+":/"+r.value+"/";case gs.K2.NotEqualRegEx:return"-"+r.name+":/"+r.value+"/"}}).join(" AND ")}}var Js=v(8894),gr=v(26204),vi=v(4148),Zs=v(53305),bi=v(7906),pr=v(94162),Ei=v(57804);const mr=`${Ge.pre}([^@]+)${Ge.post}`;class hr{constructor(e,r){this.targets=e,this.response=r,this.processResponseToSeries=()=>{const n=[];for(let a=0;a<this.response.responses.length;a++){const u=this.response.responses[a],f=this.targets[a];if(u.error)throw this.getErrorFromElasticResponse(this.response,u.error);if(u.hits&&u.hits.hits.length>0&&this.processHits(u.hits,n,f),u.aggregations){const p=u.aggregations,h=this.targets[a],g=[],y=new pr.Z;y.refId=h.refId,this.processBuckets(p,h,g,y,{},0),this.trimDatapoints(g,h),this.nameSeries(g,h);for(let S=0;S<g.length;S++)n.push(g[S]);y.rows.length>0&&n.push(y)}}return{data:n}},this.targets=e,this.response=r}processMetrics(e,r,n,a){let u;for(let f=0;f<r.metrics.length;f++){const p=r.metrics[f];if(!p.hide)switch(p.type){case"count":{u={datapoints:[],metric:"count",props:a,refId:r.refId};for(let h=0;h<e.buckets.length;h++){const g=e.buckets[h],y=g.doc_count;u.datapoints.push([y,g.key])}n.push(u);break}case"percentiles":{if(e.buckets.length===0)break;const g=e.buckets[0][p.id].values;for(const y in g){u={datapoints:[],metric:"p"+y,props:a,field:p.field,refId:r.refId};for(let S=0;S<e.buckets.length;S++){const C=e.buckets[S],D=C[p.id].values;u.datapoints.push([D[y],C.key])}n.push(u)}break}case"extended_stats":{for(const h in p.meta)if(p.meta[h]){u={datapoints:[],metric:h,props:a,field:p.field,refId:r.refId};for(let g=0;g<e.buckets.length;g++){const y=e.buckets[g],S=y[p.id];S.std_deviation_bounds_upper=S.std_deviation_bounds.upper,S.std_deviation_bounds_lower=S.std_deviation_bounds.lower,u.datapoints.push([S[h],y.key])}n.push(u)}break}case"top_metrics":{if(p.settings?.metrics?.length)for(const h of p.settings?.metrics){u={datapoints:[],metric:p.type,props:a,refId:r.refId,field:h};for(let g=0;g<e.buckets.length;g++){const y=e.buckets[g],C=y[p.id].top.map(B=>B.metrics[h]?B.metrics[h]:null),D=[C[C.length-1],y.key];u.datapoints.push(D)}n.push(u)}break}default:{u={datapoints:[],metric:p.type,metricId:p.id,props:a,refId:r.refId},ee(p)&&(u.field=p.field);for(let h=0;h<e.buckets.length;h++){const g=e.buckets[h],y=g[p.id];y!==void 0&&(y.normalized_value?u.datapoints.push([y.normalized_value,g.key]):u.datapoints.push([y.value,g.key]))}n.push(u);break}}}}processAggregationDocs(e,r,n,a,u){if(a.columns.length===0){for(const h of(0,_.keys)(u))a.addColumn({text:h,filterable:!0});a.addColumn({text:r.field,filterable:!0})}const f=(h,g,y)=>{a.addColumn({text:g}),h.push(y)},p=(0,_.isArray)(e.buckets)?e.buckets:[e.buckets];for(const h of p){const g=[];for(const y of(0,_.values)(u))g.push(y);g.push(h.key);for(const y of n.metrics||[])switch(y.type){case"count":{f(g,this.getMetricName(y.type),h.doc_count);break}case"extended_stats":{for(const S in y.meta){if(!y.meta[S])continue;const C=h[y.id];C.std_deviation_bounds_upper=C.std_deviation_bounds.upper,C.std_deviation_bounds_lower=C.std_deviation_bounds.lower,f(g,this.getMetricName(S),C[S])}break}case"percentiles":{const S=h[y.id].values;for(const C in S)f(g,`p${C} ${y.field}`,S[C]);break}case"top_metrics":{const S=this.getMetricName(y.type);if(y.settings?.metrics)for(const C of y.settings.metrics){const D=y.settings.metrics.length>1?`${S} ${C}`:S,B=h[y.id];f(g,D,B.top[0].metrics[C])}break}default:{let S=this.getMetricName(y.type);(0,_.filter)(n.metrics,{type:y.type}).length>1&&(ee(y)&&(S+=" "+y.field),y.type==="bucket_script"&&(S=Ae(y))),f(g,S,h[y.id].value);break}}a.rows.push(g)}}processBuckets(e,r,n,a,u,f){let p,h,g,y;const S=r.bucketAggs.length-1;for(y in e)if(h=(0,_.find)(r.bucketAggs,{id:y}),g=e[y],!!h){if(h.type==="nested"){this.processBuckets(g,r,n,a,u,f+1);continue}if(f===S)h.type==="date_histogram"?this.processMetrics(g,r,n,u):this.processAggregationDocs(g,h,r,a,u);else for(const C in g.buckets)p=g.buckets[C],u=(0,_.clone)(u),p.key!==void 0?u[h.field]=p.key:u.filter=C,p.key_as_string&&(u[h.field]=p.key_as_string),this.processBuckets(p,r,n,a,u,f+1)}}getMetricName(e){const r=Object.entries(R).filter(([a])=>a===e).map(([a,u])=>u)[0];if(r)return r.label;const n=pt.find(a=>a.value===e);return n?n.label:e}getSeriesName(e,r,n){let a=this.getMetricName(e.metric);if(r.alias){const p=/\{\{([\s\S]+?)\}\}/g;return r.alias.replace(p,(h,g,y)=>{const S=g||y;return S.indexOf("term ")===0?e.props[S.substring(5)]:e.props[S]!==void 0?e.props[S]:S==="metric"?a:S==="field"?e.field||"":h})}if(Ke(e.metric))if(e.metric&&xs(e.metric)){const p=(0,_.find)(r.metrics,{id:e.metricId});if(p&&p.settings.script){a=Ae(p);for(const h of p.pipelineVariables){const g=(0,_.find)(r.metrics,{id:h.pipelineAgg});g&&(a=a.replace("params."+h.name,ge(g)))}}else a="Unset"}else{const p=(0,_.find)(r.metrics,{id:e.field});p?a+=" "+ge(p):a="Unset"}else e.field&&(a+=" "+e.field);if((0,_.keys)(e.props).length===0)return a;let f="";for(const p in e.props)f+=e.props[p]+" ";return n?f.trim()+" "+a:f.trim()}nameSeries(e,r){const n=(0,_.uniq)((0,_.map)(e,"metric")).length,a=(r.metrics?.filter(u=>u.type==="top_metrics")).some(u=>(u?.settings?.metrics?.length||0)>1);for(let u=0;u<e.length;u++){const f=e[u];f.target=this.getSeriesName(f,r,n>1||a)}}processHits(e,r,n){const a=typeof e.total=="number"?e.total:e.total.value,u={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:a,filterable:!0};let f,p,h,g;for(g=0;g<e.hits.length;g++){if(p=e.hits[g],h={_id:p._id,_type:p._type,_index:p._index,sort:p.sort,highlight:p.highlight},p._source)for(f in p._source)h[f]=p._source[f];for(f in p.fields)h[f]=p.fields[f];u.datapoints.push(h)}r.push(u)}trimDatapoints(e,r){const n=(0,_.find)(r.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const u=n.settings.trimEdges;for(const f in e){const p=e[f];p.datapoints.length>u*2&&(p.datapoints=p.datapoints.slice(u,p.datapoints.length-u))}}}getErrorFromElasticResponse(e,r){const n={};return n.data=JSON.stringify(r,null,4),r.root_cause&&r.root_cause.length>0&&r.root_cause[0].reason?n.message=r.root_cause[0].reason:n.message=r.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(r=>Me(r,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(r=>(0,Zs.g0)(r))}}getLogs(e,r){return this.processResponseToDataFrames(!0,e,r)}processResponseToDataFrames(e,r,n){const a=[];for(let u=0;u<this.response.responses.length;u++){const f=this.response.responses[u];if(f.error)throw this.getErrorFromElasticResponse(this.response,f.error);if(f.hits){const{propNames:p,docs:h}=Si(f.hits.hits),g=h.length?yr(p.map(xi(h)),e,this.targets[0].timeField,r,n):yr([],e);e&&vr(g,"logs");for(const S of h){if(n&&(S.level=S[n]),S.highlight){const C=new RegExp(mr,"g"),D=new RegExp(mr),B=Object.keys(S.highlight).flatMap(He=>S.highlight[He].flatMap(Nt=>{const vs=Nt.match(C);return vs?vs.map(me=>{const Mr=me.match(D);return Mr&&Mr[1]||null}):[]})).filter(_.identity),ue=g.meta?.searchWords?(0,_.uniq)([...g.meta.searchWords,...B]):[...B];g.meta=g.meta?{...g.meta,searchWords:ue}:{searchWords:ue}}g.add(S)}const y=this.targets[u];g.refId=y.refId,a.push(g)}if(f.aggregations){const p=f.aggregations,h=this.targets[u],g=[],y=new pr.Z;if(this.processBuckets(p,h,g,y,{},0),this.trimDatapoints(g,h),this.nameSeries(g,h),y.rows.length>0){const S=(0,Zs.g0)(y);S.refId=h.refId,a.push(S)}for(let S=0;S<g.length;S++){let C=(0,Zs.g0)(g[S]);e&&vr(C,"graph"),C.refId=h.refId,a.push(C)}}}for(let u of a)for(let f of u.fields)f.type===$e.fS.time&&typeof f.values[0]!="number"&&(f.values=(0,gr.p8)(f,{destinationType:$e.fS.time}).values);return{data:a}}}const Si=t=>{const e=[];let r=[];for(const n of t){const a=n._source?(0,Ei.default)(n._source):{},u={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...a},...a};for(const f of Object.keys(u))r.indexOf(f)===-1&&r.push(f);e.push(u)}return r.sort(),{docs:e,propNames:r}},yr=(t,e,r,n,a)=>{const u=new bi.v({fields:[]});if(r&&u.addField({config:{filterable:!0},name:r,type:$e.fS.time}),n){const p=u.addField({name:n,type:$e.fS.string});u.setParser(p,h=>h||"")}if(a){const p=u.addField({name:"level",type:$e.fS.string});u.setParser(p,h=>h||"")}const f=u.fields.map(p=>p.name);for(const[p,h]of t){if(f.includes(p)||!e&&p==="_source")continue;const g=u.addField({config:{filterable:!0},name:p,type:h});u.setParser(g,y=>y||"")}return u},vr=(t,e)=>{let r=t;r.meta?r.meta.preferredVisualisationType=e:r.meta={preferredVisualisationType:e}},xi=t=>e=>[e,Fi(t.find(r=>r[e]!==void 0)?.[e])],Fi=t=>{switch(typeof t){case"number":return $e.fS.number;case"string":return $e.fS.string;default:return $e.fS.other}};var Xs=v(72639),$i=v(49955),Ii=v(31886);const wi=({payload:{dashboardId:t,orgId:e,grafanaVersion:r,queries:n}})=>{try{const a=n[Ii.id].filter(D=>!D.hide);if(!a?.length)return;const u=a.filter(Mi),f=a.filter(D=>!!D.query),p=a.filter(D=>Ot(D)==="logs"),h=a.filter(D=>Ot(D)==="metric"),g=a.filter(D=>Ot(D)==="raw_data"),y=a.filter(D=>Ot(D)==="raw_document"),S=a.filter(Ci),C={grafana_version:r,dashboard_id:t,org_id:e,queries_count:a.length,logs_queries_count:p.length,metric_queries_count:h.length,raw_data_queries_count:g.length,raw_document_queries_count:y.length,queries_with_template_variables_count:u.length,queries_with_changed_line_limit_count:S.length,queries_with_lucene_query_count:f.length};(0,Xs.ff)("grafana_elasticsearch_dashboard_loaded",C)}catch(a){console.error("error in elasticsearch tracking handler",a)}},Ot=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",br=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},Ci=t=>{const e=br(t);return e!==void 0&&e!==500},Mi=t=>$i.J7.test(t.query??""),Ai=t=>!!t.startsWith(Ir);function Er(t,e,r){const{targets:n,app:a}=e;if(!(a===Ys.zj.Dashboard||a===Ys.zj.PanelViewer))for(const u of n){if(Ai(u.refId))return;(0,Xs.ff)("grafana_elasticsearch_query_executed",{app:a,grafana_version:Ne.config.buildInfo.version,with_lucene_query:!!u.query,query_type:Ot(u),line_limit:br(u),alias:u.alias,has_error:t.error!==void 0,has_data:t.data.some(f=>f.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-r.getTime()})}}function Ti(t){(0,Xs.ff)("grafana_elasticsearch_annotation_query_executed",{grafana_version:Ne.config.buildInfo.version,has_target_query:!!t.target?.query,has_query:!!t.query,has_time_field:!!t.timeField,has_time_end_field:!!t.timeEndField,has_tags_field:!!t.tagsField,has_text_field:!!t.textField,has_index:!!t.index})}class _i{constructor(e,r){this.datasource=e,this.templateSrv=r}request(e,r,n,a){if(!this.datasource.isProxyAccess){const f=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,Js._)(()=>f)}const u={url:this.datasource.url+"/"+r,method:e,data:n,headers:a};return e==="POST"&&(u.headers=u.headers??{},u.headers["Content-Type"]="application/x-ndjson"),(this.datasource.basicAuth||this.datasource.withCredentials)&&(u.withCredentials=!0),this.datasource.basicAuth&&(u.headers={Authorization:this.datasource.basicAuth}),(0,vi.i)().fetch(u).pipe((0,ze.U)(f=>(f.data.$$config=f.config,f.data)),(0,fs.K)(f=>{if(f.data){const p=f.data.error?.reason??f.data.message??"Unknown error";return(0,Js._)({message:p,error:f.data.error})}return(0,Js._)(f)}))}async logContextQuery(e,r){const a=e.dataFrame.fields.find(me=>me.name==="sort")?.values[e.rowIndex]||[e.timeEpochMs],u=r?.direction===X.M4.Forward?"asc":"desc",f=r?.direction===X.M4.Forward?this.datasource.getQueryHeader("query_then_fetch",(0,K.CQ)(e.timeEpochMs)):this.datasource.getQueryHeader("query_then_fetch",void 0,(0,K.CQ)(e.timeEpochMs)),p=r?.limit??10,h=JSON.stringify({size:p,query:{bool:{filter:[{range:{[this.datasource.timeField]:{[r?.direction===X.M4.Forward?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.datasource.timeField]:u},{_doc:u}],search_after:a}),g=[f,h].join(`
`)+`
`,y=this.datasource.getMultiSearchUrl(),S=await(0,oe.n)(this.request("POST",y,g)),C=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],B=new hr(C,Pi(S,u)).getLogs(this.datasource.logMessageField,this.datasource.logLevelField),ue=(0,_.first)(B.data);if(!ue)return{data:[]};const He=ue.fields.find(me=>me.name===this.datasource.timeField),Nt=ue.fields.find(me=>me.name===this.datasource.logMessageField),vs=ue.fields.filter(me=>me!==He&&me!==Nt);return He&&Nt?{data:[{...ue,fields:[(0,gr.J_)(He),Nt,...vs]}]}:B}query(e){let r="";const n=this.datasource.interpolateVariablesInQueries((0,_.cloneDeep)(e.targets),e.scopedVars),a=[];let u=n.some(g=>Me(g,"logs"));const f=[];for(const g of n){if(g.hide)continue;let y;if(Me(g,"logs")){g.bucketAggs=[ve()];const B=g.metrics?.find(He=>He.type==="logs"),ue=B.settings?.limit?parseInt(B.settings?.limit,10):500;f.push(ue),g.metrics=[],y=this.datasource.queryBuilder.getLogsQuery(g,ue)}else f.push(),g.alias&&(g.alias=this.datasource.interpolateLuceneQuery(g.alias,e.scopedVars)),y=this.datasource.queryBuilder.build(g);const S=JSON.stringify(y),C="query_then_fetch",D=this.datasource.getQueryHeader(C,e.range.from,e.range.to);r+=D+`
`,r+=S+`
`,a.push(g)}if(a.length===0)return(0,Dt.of)({data:[]});r=r.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),r=r.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),r=this.templateSrv.replace(r,e.scopedVars);const p=this.datasource.getMultiSearchUrl(),h=new Date;return this.request("POST",p,r).pipe((0,ze.U)(g=>{const y=new hr(a,g);if(u){const S=y.getLogs(this.datasource.logMessageField,this.datasource.logLevelField);return S.data.forEach((C,D)=>{Di(C,this.datasource.dataLinks,f[D])}),S}return y.getTimeSeries()}),(0,ur.b)(g=>Er(g,e,h)))}}function Pi(t,e){if(e==="desc")return t;const r=t.responses[0];return{...t,responses:[{...r,hits:{...r.hits,hits:r.hits.hits.reverse()}}]}}function Di(t,e,r){r&&(t.meta={...t.meta,limit:r}),Cr(t,e)}class Oi{constructor(e){this.timeField=e.timeField}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,r,n){if(r.terms={field:e.field},!e.settings)return r;const a=e.settings?.size?parseInt(e.settings.size,10):500;if(r.terms.size=a===0?500:a,e.settings.orderBy!==void 0){r.terms.order={},e.settings.orderBy==="_term"?r.terms.order._key=e.settings.order:r.terms.order[e.settings.orderBy]=e.settings.order;const u=ht(e.settings.orderBy);if(u){for(let f of n.metrics||[])if(f.id===u){f.type==="count"?r.terms.order={_count:e.settings.order}:ee(f)&&(r.aggs={},r.aggs[f.id]={[f.type]:{field:f.field}});break}}}return e.settings.min_doc_count!==void 0&&(r.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(r.terms.min_doc_count)&&(r.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(r.terms.missing=e.settings.missing),r}getDateHistogramAgg(e){const r={},n=e.settings||{},a=["1w","1M","1q","1y"];r.field=e.field||this.timeField,r.min_doc_count=n.min_doc_count||0,r.extended_bounds={min:"$timeFrom",max:"$timeTo"},r.format="epoch_millis",n.timeZone&&n.timeZone!==St.RQ.utc&&(r.time_zone=n.timeZone),n.offset!==""&&(r.offset=n.offset);const u=n.interval==="auto"?"${__interval_ms}ms":n.interval;return u!==void 0&&a.includes(u)?r.calendar_interval=u:r.fixed_interval=u,r}getHistogramAgg(e){const r={},n=e.settings||{};return r.interval=n.interval,r.field=e.field,r.min_doc_count=n.min_doc_count||0,r}getFiltersAgg(e){const r={};for(let{query:n,label:a}of e.settings?.filters||[])r[a||n]={query_string:{query:n,analyze_wildcard:!0}};return r}documentQuery(e,r){return e.size=r,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}build(e){e.metrics=e.metrics||[ye()],e.bucketAggs=e.bucketAggs||[ve()],e.timeField=this.timeField;let r,n,a,u,f;const p={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(p.query.bool.filter=[...p.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),e.bucketAggs.length===0&&(r=e.metrics[0],!r||!(r.type==="raw_document"||r.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){r=e.metrics[0];const h=r.settings?.size?parseInt(r.settings.size,10):500;return this.documentQuery(p,h||500)}for(f=p,n=0;n<e.bucketAggs.length;n++){const h=e.bucketAggs[n],g={};switch(h.type){case"date_histogram":{g.date_histogram=this.getDateHistogramAgg(h);break}case"histogram":{g.histogram=this.getHistogramAgg(h);break}case"filters":{g.filters={filters:this.getFiltersAgg(h)};break}case"terms":{this.buildTermsAgg(h,g,e);break}case"geohash_grid":{g.geohash_grid={field:h.field,precision:h.settings?.precision||mt};break}case"nested":{g.nested={path:h.field};break}}f.aggs=f.aggs||{},f.aggs[h.id]=g,f=g}for(f.aggs={},n=0;n<e.metrics.length;n++){if(r=e.metrics[n],r.type==="count")continue;const h={};let g={};if(Qe(r))if(qe(r))if(r.pipelineVariables){for(g={buckets_path:{}},a=0;a<r.pipelineVariables.length;a++)if(u=r.pipelineVariables[a],u.name&&u.pipelineAgg&&/^\d*$/.test(u.pipelineAgg)){const y=Qt(e.metrics,u.pipelineAgg);y&&(y.type==="count"?g.buckets_path[u.name]="_count":g.buckets_path[u.name]=u.pipelineAgg)}}else continue;else if(r.field&&/^\d*$/.test(r.field)){const y=Qt(e.metrics,r.field);y&&(y.type==="count"?g={buckets_path:"_count"}:g={buckets_path:r.field})}else continue;else ee(r)&&(g={field:r.field});if(gt(r))switch(Object.entries(r.settings||{}).filter(([y,S])=>S!==null).forEach(([y,S])=>{g[y]=y==="script"?this.buildScript(Ae(r)):S}),r.type){case"moving_avg":g={...g,...g?.window!==void 0&&{window:this.toNumber(g.window)},...g?.predict!==void 0&&{predict:this.toNumber(g.predict)},...ft(r)&&{settings:{...g.settings,...Object.fromEntries(Object.entries(g.settings||{}).filter(([y])=>["alpha","beta","gamma","period"].includes(y)).filter(([y,S])=>S!==void 0).map(([y,S])=>[y,this.toNumber(S)]))}}};break;case"serial_diff":g={...g,...g.lag!==void 0&&{lag:this.toNumber(g.lag)}};break;case"top_metrics":g={metrics:r.settings?.metrics?.map(y=>({field:y})),size:1},r.settings?.orderBy&&(g.sort=[{[r.settings?.orderBy]:r.settings?.order}]);break}h[r.type]=g,f.aggs[r.id]=h}return p}buildScript(e){return e}toNumber(e){const r=parseFloat(`${e}`);return isNaN(r)?e:r}getTermsQuery(e){const r={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&r.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),r.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:a="key",order:u=a==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(u)<0)throw{message:`Invalid query sort order ${u}`};switch(a){case"key":case"term":const f="_key";r.aggs[1].terms.order[f]=u;break;case"doc_count":r.aggs[1].terms.order._count=u;break;default:throw{message:`Invalid query sort type ${a}`}}return r}getLogsQuery(e,r){let n={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return e.query&&n.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),n=this.documentQuery(n,r),{...n,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[Ge.pre],post_tags:[Ge.post],fragment_size:2147483647}}}}var Ni=v(87355),ps=v(46101);function Ri(t){const e=t.annotation,r=t.onAnnotationChange;return o.createElement(o.Fragment,null,o.createElement("div",{className:"gf-form-group"},o.createElement(ar,{value:e.target?.query,onChange:n=>{const u={...e.target??{refId:"annotation_query"},query:n};r({...e,target:u})}})),o.createElement("div",{className:"gf-form-group"},o.createElement("h6",null,"Field mappings"),o.createElement(Ni.p,null,o.createElement(ps.S,{label:"Time"},o.createElement(w.I,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{r({...e,timeField:n.currentTarget.value})}})),o.createElement(ps.S,{label:"Time End"},o.createElement(w.I,{type:"text",value:e.timeEndField,onChange:n=>{r({...e,timeEndField:n.currentTarget.value})}})),o.createElement(ps.S,{label:"Text"},o.createElement(w.I,{type:"text",value:e.textField,onChange:n=>{r({...e,textField:n.currentTarget.value})}})),o.createElement(ps.S,{label:"Tags"},o.createElement(w.I,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{r({...e,tagsField:n.currentTarget.value})}})))))}function Li(t){return!t||typeof t!="object"?!1:"meta"in t}var Re=v(62772);function ms(t,e,r,n=""){return Sr(t,e,r,n)!==null}function Sr(t,e,r,n=""){const a=`${n}${Re.term.escape(e)}`;r=Re.phrase.escape(r);let u=$r(t);return u?er(u,a,r):null}function er(t,e,r){return Object.keys(t).length===0?null:Fr(t.left)?er(t.left,e,r):ys(t.left)&&t.left.field===e&&t.left.term===r?t.left:sr(t)?null:ys(t.right)&&t.right.field===e&&t.right.term===r?t.right:rr(t.right)?er(t.right,e,r):null}function hs(t,e,r,n=""){if(ms(t,e,r,n))return t;e=Re.term.escape(e),r=Re.phrase.escape(r);const a=`${n}${e}:"${r}"`;return t===""?a:`${t} AND ${a}`}function xr(t,e,r,n=""){const a=Sr(t,e,r,n),u=$r(t);return!a||!u?t:Re.toString(tr(u,a))}function tr(t,e){return Object.keys(t).length===0?t:Fr(t.left)?(t.left=tr(t.left,e),t):ys(t.left)&&(0,_.isEqual)(t.left,e)?(Object.assign(t,{left:void 0,operator:void 0,right:void 0},"right"in t?t.right:{}),t):sr(t)?t:ys(t.right)&&(0,_.isEqual)(t.right,e)?(Object.assign(t,{right:void 0,operator:void 0}),t):(rr(t.right)&&(t.right=tr(t.right,e)),t)}function Qi(t){return Re.term.escape(t)}function ki(t){return Re.phrase.escape(t)}function Bi(t){return t.replace(/(\w+)\s(:)/gi,"$1$2")}function sr(t){return t?"left"in t&&!("right"in t):!1}function rr(t){return t?"left"in t&&"right"in t:!1}function Fr(t){return sr(t)||rr(t)}function ys(t){return t?"term"in t:!1}function $r(t){try{return Re.parse(Bi(t))}catch{return null}}const Ir="log-volume-",wr="log-sample-",Vi=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class Wi extends di.CK{constructor(e,r=(0,pi.J)()){super(e),this.templateSrv=r,this.getLogRowContext=async(a,u)=>{const{enableElasticsearchBackendQuerying:f}=Ne.config.featureToggles;if(f){const p=this.makeLogContextDataRequest(a,u);return(0,oe.n)(this.query(p).pipe((0,fs.K)(h=>{throw{message:"Error during context query. Please check JS console logs.",status:h.status,statusText:h.statusText}})))}else return this.legacyQueryRunner.logContextQuery(a,u)},this.makeLogContextDataRequest=(a,u)=>{const f=u?.direction||X.M4.Backward,p={type:"logs",id:"1",settings:{limit:u?.limit?u?.limit.toString():"10",sortDirection:f===X.M4.Backward?"desc":"asc",searchAfter:a.dataFrame.fields.find(D=>D.name==="sort")?.values[a.rowIndex]??[a.timeEpochMs]}},h={refId:`log-context-${a.dataFrame.refId}-${f}`,metrics:[p],query:""},g=zi(a.timeEpochMs,f,this.intervalPattern),y={from:g.from,to:g.to,raw:g},S=ui.calculateInterval(y,1);return{requestId:`log-context-request-${a.dataFrame.refId}-${u?.direction}`,targets:[h],interval:S.interval,intervalMs:S.intervalMs,range:y,scopedVars:{},timezone:"UTC",app:Ys.zj.Explore,startTime:Date.now(),hideFromInspector:!0}},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.index=n.index??e.database??"",this.timeField=n.timeField,this.xpack=!!n.xpack,this.indexPattern=new hi(this.index,n.interval),this.intervalPattern=n.interval,this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new Oi({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.databaseVersion=null,this.annotations={QueryEditor:Ri},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new yi(this),this.timeSrv=(0,gi.$t)(),this.legacyQueryRunner=new _i(this,this.templateSrv)}getResourceRequest(e,r,n){return this.getResource(e,r,n)}postResourceRequest(e,r,n){const a=n??{};return a.headers=a.headers??{},a.headers["content-type"]="application/x-ndjson",this.postResource(e,r,a)}async importFromAbstractQueries(e){return e.map(r=>this.languageProvider.importFromAbstractQuery(r))}requestAllIndices(e,r=(0,Y.JK)()){let n=this.indexPattern.getIndexList(r.from,r.to);Array.isArray(n)||(n=[this.indexPattern.getIndexForToday()]);const a=n.map(p=>p+e),u=7,f=a.length;return(0,ai.R)({initialState:0,condition:p=>p<Math.min(f,u),iterate:p=>p+1}).pipe((0,cr.z)(p=>{const h=a[f-p-1];return(Ne.config.featureToggles.enableElasticsearchBackendQuerying?(0,ds.D)(this.getResource(h)):this.legacyQueryRunner.request("GET",h)).pipe((0,fs.K)(y=>(0,Dt.of)({err:y})))}),(0,li.n)(p=>p?.err?.status===404),(0,oi.T)(()=>"Could not find an available index for this time range."),(0,ci.P)(),(0,ze.U)(p=>{if(p.err)throw p.err;return p}))}annotationQuery(e){const r=this.prepareAnnotationRequest(e);Ti(e.annotation);const n=Ne.config.featureToggles.enableElasticsearchBackendQuerying?(0,ds.D)(this.postResourceRequest("_msearch",r)):this.legacyQueryRunner.request("POST","_msearch",r);return(0,oe.n)(n.pipe((0,ze.U)(a=>{const u=a.responses[0].hits.hits;return this.processHitsToAnnotationEvents(e.annotation,u)})))}prepareAnnotationRequest(e){const r=e.annotation,n=r.timeField||"@timestamp",a=r.timeEndField||null,u=r.query??r.target?.query??"",f=[],p={};if(p[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},f.push({range:p}),a){const D={};D[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},f.push({range:D})}const h=this.interpolateLuceneQuery(u),g={bool:{filter:[{bool:{should:f,minimum_should_match:1}}]}};h&&g.bool.filter.push({query_string:{query:h}});const y={query:g,size:1e4},S={search_type:"query_then_fetch",ignore_unavailable:!0};return r.index?S.index=r.index:S.index=this.indexPattern.getIndexList(e.range.from,e.range.to),JSON.stringify(S)+`
`+JSON.stringify(y)+`
`}processHitsToAnnotationEvents(e,r){const n=e.timeField||"@timestamp",a=e.timeEndField||null,u=e.textField||"tags",f=e.tagsField||null,p=[],h=(g,y)=>{if(!y)return;const S=y.split(".");let C=g;for(let D=0;D<S.length;D++)if(C=C[S[D]],!C)return"";return C};for(let g=0;g<r.length;g++){const y=r[g]._source;let S=h(y,n);if(typeof r[g].fields<"u"){const B=r[g].fields;typeof B=="object"&&((0,_.isString)(B[n])||(0,_.isNumber)(B[n]))&&(S=B[n])}const C={annotation:e,time:(0,K.zh)(S).valueOf(),text:h(y,u)};if(a){const B=h(y,a);B&&(C.timeEnd=(0,K.zh)(B).valueOf())}if(e.titleField){const B=h(y,e.titleField);B&&(C.text=B+`
`+C.text)}const D=h(y,f);typeof D=="string"?C.tags=D.split(","):C.tags=D,p.push(C)}return p}interpolateLuceneQuery(e,r){return this.templateSrv.replace(e,r,"lucene")}interpolateVariablesInQueries(e,r){return e.map(n=>this.applyTemplateVariables(n,r))}async testDatasource(){const e=await this.getDatabaseVersion(!1),n=(e!=null?yt(e):!0)?"":`WARNING: ${vt} `;return(0,oe.n)(this.getFields(["date"]).pipe((0,cr.z)(a=>(0,_.find)(a,{text:this.timeField})?(0,Dt.of)({status:"success",message:`${n}Data source successfully connected.`}):(0,Dt.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,fs.K)(a=>{const f=`Unable to connect with Elasticsearch${a.message?` (${a.message})`:""}. Please check the server logs for more details.`;return(0,Dt.of)({status:"error",message:f})})))}getQueryHeader(e,r,n){const a={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(r,n)};return JSON.stringify(a)}getQueryDisplayText(e){const r=e.metrics,n=e.bucketAggs;let a="";return e.query&&(a+="Query: "+e.query+", "),a+="Metrics: ",a+=r?.reduce((u,f)=>{let h=R[f.type].label+"(";return ee(f)&&(h+=f.field),qe(f)&&(h+=Ae(f).replace(new RegExp("params.","g"),"")),h+="), ",`${u} ${h}`},""),a+=n?.reduce((u,f,p)=>{const h=j[f.type];let g="";return p===0&&(g+=" Group by: "),g+=h.label+"(",it(f)&&(g+=f.field),`${u} ${g}), `},""),e.alias&&(a+="Alias: "+e.alias),a}showContextToggle(){return!0}getDataProvider(e,r){if(this.getSupportedSupplementaryQueryTypes().includes(e))switch(e){case X.v8.LogsVolume:return this.getLogsVolumeDataProvider(r);case X.v8.LogsSample:return this.getLogsSampleDataProvider(r);default:return}}getSupportedSupplementaryQueryTypes(){return[X.v8.LogsVolume,X.v8.LogsSample]}getSupplementaryQuery(e,r){if(!this.getSupportedSupplementaryQueryTypes().includes(e.type))return;let n=!1;switch(e.type){case X.v8.LogsVolume:if(n=r.metrics?.length===1&&r.metrics[0].type==="logs",!n)return;const a=[],u=this.timeField??"@timestamp";return this.logLevelField&&a.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:X.in.unknown},field:this.logLevelField}),a.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:u}),{refId:`${Ir}${r.refId}`,query:r.query,metrics:[{type:"count",id:"1"}],timeField:u,bucketAggs:a};case X.v8.LogsSample:return n=bt(r),n?e.limit?{refId:`${wr}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1",settings:{limit:e.limit.toString()}}]}:{refId:`${wr}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1"}]}:void 0;default:return}}getLogsVolumeDataProvider(e){const r=(0,_.cloneDeep)(e),n=r.targets.map(a=>this.getSupplementaryQuery({type:X.v8.LogsVolume},a)).filter(a=>!!a);if(n.length)return(0,dr.Bz)(this,{...r,targets:n},{range:e.range,targets:e.targets,extractLevel:Hi})}getLogsSampleDataProvider(e){const r=(0,_.cloneDeep)(e),u=r.targets.map(f=>this.getSupplementaryQuery({type:X.v8.LogsSample,limit:100},f)).filter(f=>!!f);if(u.length)return(0,dr.Ce)(this,{...r,targets:u})}query(e){const{enableElasticsearchBackendQuerying:r}=Ne.config.featureToggles;if(r){const n=new Date;return super.query(e).pipe((0,ur.b)(a=>Er(a,e,n)),(0,ze.U)(a=>(a.data.forEach(u=>{Cr(u,this.dataLinks)}),a)))}return this.legacyQueryRunner.query(e)}filterQuery(e){return!e.hide}isMetadataField(e){return Vi.includes(e)}getFields(e,r){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.requestAllIndices("/_mapping",r).pipe((0,ze.U)(a=>{const u=(g,y)=>this.isMetadataField(y)?!1:!e||e.length===0?!0:e.includes(g.type)||e.includes(n[g.type]),f=[],p={};function h(g){for(const y in g){const S=g[y];if((0,_.isObject)(S.properties)&&(f.push(y),h(S.properties)),(0,_.isObject)(S.fields)&&(f.push(y),h(S.fields)),(0,_.isString)(S.type)){const C=f.concat(y).join(".");u(S,y)&&(p[C]={text:C,type:S.type})}}f.pop()}for(const g in a){const y=a[g];if(y&&y.mappings){const C=y.mappings.properties;h(C)}}return(0,_.map)(p,g=>g)}))}getTerms(e,r=(0,Y.JK)()){const n="query_then_fetch",a=this.getQueryHeader(n,r.from,r.to);let u=JSON.stringify(this.queryBuilder.getTermsQuery(e));u=u.replace(/\$timeFrom/g,r.from.valueOf().toString()),u=u.replace(/\$timeTo/g,r.to.valueOf().toString()),u=a+`
`+u+`
`;const f=this.getMultiSearchUrl();return(Ne.config.featureToggles.enableElasticsearchBackendQuerying?(0,ds.D)(this.postResourceRequest(f,u)):this.legacyQueryRunner.request("POST",f,u)).pipe((0,ze.U)(h=>{if(!h.responses[0].aggregations)return[];const g=h.responses[0].aggregations[1].buckets;return(0,_.map)(g,y=>({text:y.key_as_string||y.key,value:y.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,r){const n=r?.range,a=JSON.parse(e);if(e){if(a.find==="fields")return a.type=this.interpolateLuceneQuery(a.type),(0,oe.n)(this.getFields(a.type,n));if(a.find==="terms")return a.field=this.interpolateLuceneQuery(a.field),a.query=this.interpolateLuceneQuery(a.query),(0,oe.n)(this.getTerms(a,n))}return Promise.resolve([])}getTagKeys(){return(0,oe.n)(this.getFields())}getTagValues(e){const r=this.timeSrv.timeRange();return(0,oe.n)(this.getTerms({field:e.key},r))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;if(e.bucketAggs){for(const r of e.bucketAggs)if(it(r)&&this.templateSrv.containsTemplate(r.field)||this.objectContainsTemplate(r.settings))return!0}if(e.metrics){for(const r of e.metrics)if(ee(r)&&(r.field&&this.templateSrv.containsTemplate(r.field)||r.settings&&this.objectContainsTemplate(r.settings)||Li(r)&&this.objectContainsTemplate(r.meta)))return!0}return!1}objectContainsTemplate(e){if(typeof e=="string")return this.templateSrv.containsTemplate(e);if(!e||typeof e!="object")return!1;for(const r of Object.keys(e))if(Array.isArray(e[r])){for(const n of e[r])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[r]))return!0;return!1}toggleQueryFilter(e,r){let n=e.query??"";switch(r.type){case"FILTER_FOR":{n=ms(n,r.options.key,r.options.value)?xr(n,r.options.key,r.options.value):hs(n,r.options.key,r.options.value);break}case"FILTER_OUT":{ms(n,r.options.key,r.options.value)&&(n=xr(n,r.options.key,r.options.value)),n=hs(n,r.options.key,r.options.value,"-");break}}return{...e,query:n}}queryHasFilter(e,r){let n=e.query??"";return ms(n,r.key,r.value)}modifyQuery(e,r){if(!r.options)return e;let n=e.query??"";switch(r.type){case"ADD_FILTER":{n=hs(n,r.options.key,r.options.value);break}case"ADD_FILTER_OUT":{n=hs(n,r.options.key,r.options.value,"-");break}}return{...e,query:n}}addAdHocFilters(e){const r=this.templateSrv.getAdhocFilters(this.name);if(r.length===0)return e;const n=r.map(u=>{let{key:f,operator:p,value:h}=u;if(!(!f||!h))switch(f=Qi(f),h=ki(h),p){case"=":return`${f}:"${h}"`;case"!=":return`-${f}:"${h}"`;case"=~":return`${f}:/${h}/`;case"!~":return`-${f}:/${h}/`;case">":return`${f}:>${h}`;case"<":return`${f}:<${h}`}});return[e,...n].filter(u=>u).join(" AND ")}applyTemplateVariables(e,r){const n=f=>f.type==="filters"?{...f,settings:{...f.settings,filters:f.settings?.filters?.map(p=>({...p,query:this.interpolateLuceneQuery(p.query,r)||"*"}))}}:f,a={...e,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(e.query||"",r)),bucketAggs:e.bucketAggs?.map(n)};return JSON.parse(this.templateSrv.replace(JSON.stringify(a),r))}getDatabaseVersionUncached(){const e=Ne.config.featureToggles.enableElasticsearchBackendQuerying?(0,ds.D)(this.getResourceRequest("")):this.legacyQueryRunner.request("GET","/");return(0,oe.n)(e).then(r=>{const n=r?.version?.number;if(typeof n!="string")return null;try{return new ke.SemVer(n)}catch(a){return console.error(a),null}},r=>(console.error(r),null))}async getDatabaseVersion(e=!0){if(e){const n=this.databaseVersion;if(n!=null)return n}const r=await this.getDatabaseVersionUncached();return this.databaseVersion=r,r}}function Cr(t,e){if(e.length)for(const r of t.fields){const n=e.filter(a=>new RegExp(a.field).test(r.name));n.length!==0&&(r.config=r.config||{},r.config.links=[...(r.config.links,n.map(ji))])}}function ji(t){const e=(0,fi.F)();if(t.datasourceUid){const r=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:r?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function zi(t,e,r){if(r){const a=fr[r];return e===X.M4.Forward?{from:(0,K.CQ)(t).utc(),to:(0,K.CQ)(t).add(7,a.amount).utc().startOf(a.startOf)}:{from:(0,K.CQ)(t).subtract(7,a.amount).utc().startOf(a.startOf),to:(0,K.CQ)(t).utc()}}else return e===X.M4.Forward?{from:(0,K.CQ)(t).utc(),to:(0,K.CQ)(t).add(7,"hours").utc()}:{from:(0,K.CQ)(t).subtract(7,"hours").utc(),to:(0,K.CQ)(t).utc()}}function Hi(t){const r=t.fields.find(n=>n.type===$e.fS.number)?.labels?.level??"";return(0,mi.jx)(r)}const qi=new I.hf(Wi).setQueryEditor(_r).setConfigEditor(ni);(0,N.N$)().subscribe(m.Pl,wi)},67051:(Ie,W)=>{W.escape=function(N){return N.replace(/[\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~]/g,v)};function v(m){return"\\"+m}W.unescape=function(N){return N.replace(/\\([\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~])/g,I)};function I(m,N){return N}W.escapePhrase=function(N){return N.replace(/"/g,v)},W.unescapePhrase=function(N){return N.replace(/\\(")/g,I)}},62772:(Ie,W,v)=>{"use strict";var I=v(10382),m=v(67051);W.parse=I.parse.bind(I),W.toString=v(4527),W.term={escape:m.escape,unescape:m.unescape},W.phrase={escape:m.escapePhrase,unescape:m.unescapePhrase}},10382:Ie=>{"use strict";function W(m,N){function i(){this.constructor=m}i.prototype=N.prototype,m.prototype=new i}function v(m,N,i,o){this.message=m,this.expected=N,this.found=i,this.location=o,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,v)}W(v,Error),v.buildMessage=function(m,N){var i={literal:function($){return'"'+Y($.text)+'"'},class:function($){var w="",Q;for(Q=0;Q<$.parts.length;Q++)w+=$.parts[Q]instanceof Array?te($.parts[Q][0])+"-"+te($.parts[Q][1]):te($.parts[Q]);return"["+($.inverted?"^":"")+w+"]"},any:function($){return"any character"},end:function($){return"end of input"},other:function($){return $.description}};function o($){return $.charCodeAt(0).toString(16).toUpperCase()}function Y($){return $.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+o(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+o(w)})}function te($){return $.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+o(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+o(w)})}function re($){return i[$.type]($)}function we($){var w=new Array($.length),Q,J;for(Q=0;Q<$.length;Q++)w[Q]=re($[Q]);if(w.sort(),w.length>0){for(Q=1,J=1;Q<w.length;Q++)w[Q-1]!==w[Q]&&(w[J]=w[Q],J++);w.length=J}switch(w.length){case 1:return w[0];case 2:return w[0]+" or "+w[1];default:return w.slice(0,-1).join(", ")+", or "+w[w.length-1]}}function ie($){return $?'"'+Y($)+'"':"end of input"}return"Expected "+we(m)+" but "+ie(N)+" found."};function I(m,N){N=N!==void 0?N:{};var i={},o={start:ss},Y=ss,te=function(s){return s[0]},re=function(){return{}},we=function(s){return{operator:s}},ie=function(s,c,d,P){var E={start:s,left:c},P=P.length==0?null:P[0].right==null?P[0].left:P[0];return P!=null&&(E.operator=d==""?"<implicit>":d[0],E.right=P),E},$=function(s,c){return c},w=function(s,c,E){var b={left:s},E=E.length==0?null:E[0].right==null?E[0].left:E[0];return E!=null&&(b.operator=c==""?"<implicit>":c[0],b.right=E),b},Q=function(s){return s},J="(",de=O("(",!1),H=")",k=O(")",!1),z=function(s){return s[0].parenthesized=!0,s[0]},U=function(s,c){return c.field=s==null||s.label==""?"<implicit>":s.label,c.fieldLocation=s==null||s.label==""?null:s.location,c},Le=function(s,c){return c.field=s.label,c.fieldLocation=s.location,c},Ce=function(s,c){var d={field:s==null||s.label==""?"<implicit>":s.label,fieldLocation:s==null||s.label==""?null:s.location};for(var b in c)d[b]=c[b];return d},ft=/^[:]/,ee=Se([":"],!1,!1),Qe=function(s){return{label:s.label,location:s.location}},qe=function(s,c,d,b){var E={term:c,quoted:!0,regex:!1,termLocation:ot()};return d!=""&&(E.proximity=d),b!=""&&(E.boost=b),s!=""&&(E.prefix=s),E},bs=function(s,c){var d={term:c,quoted:!1,regex:!0,termLocation:ot()};return d},gt=function(s,c,d,b){var E={term:c.label,quoted:!1,regex:!1,termLocation:ot()};return d!=""&&(E.similarity=d),b!=""&&(E.boost=b),s!=""&&(E.prefix=s),E},he="\\",fe=O("\\",!1),Ue=function(s){return"\\"+s},Rt=".",R=O(".",!1),Es=/^[^ \t\r\n\f{}()"\/\^~[\]]/,Lt=Se([" ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),pt=function(s){return s.join("")},Ss=function(s){return{label:s.join(""),location:ot()}},Ge=/^[^: \t\r\n\f{}()"\/\^~[\]]/,mt=Se([":"," ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),ye='"',ve=O('"',!1),Qt=function(s){return s.join("")},Me="/",Ke=O("/",!1),xs=function(s){return s.join("")},ke=Rs(),ge=function(s){return s},Ye="+",ht=O("+",!1),Ae="-",yt=O("-",!1),vt="!",bt=O("!",!1),L="{",Je=O("{",!1),Ze="}",Xe=O("}",!1),Be="[",Te=O("[",!1),et="]",q=O("]",!1),Et="^",_e=O("^",!1),kt="?",Bt=O("?",!1),Fs=":",$s=O(":",!1),St="&",Vt=O("&",!1),j="|",Wt=O("|",!1),xt="'",Is=O("'",!1),tt="~",st=O("~",!1),jt="*",zt=O("*",!1),G=" ",ws=O(" ",!1),Cs=function(s){return s},Ht=function(s){return s},qt=function(s){return s==""||s==null?.5:s},Ft="0.",Ms=O("0.",!1),Pe=/^[0-9]/,le=Se([["0","9"]],!1,!1),Ut=function(s){return parseFloat("0."+s.join(""))},As=function(s){return parseInt(s.join(""))},ce="TO",rt=O("TO",!1),Ts=function(s,c){return{term_min:s,term_max:c,inclusive:"both"}},De=function(s,c){return{term_min:s,term_max:c,inclusive:"none"}},_=function(s,c){return{term_min:s,term_max:c,inclusive:"left"}},$t=function(s,c){return{term_min:s,term_max:c,inclusive:"right"}},be=function(s){return s},It="OR NOT",Gt=O("OR NOT",!1),Kt="AND NOT",Yt=O("AND NOT",!1),Ve="OR",oe=O("OR",!1),it="AND",_s=O("AND",!1),Jt="NOT",Ps=O("NOT",!1),Zt="||",nt=O("||",!1),Ee="&&",Ds=O("&&",!1),Os=es("whitespace"),wt=/^[ \t\r\n\f]/,ne=Se([" ","	","\r",`
`,"\f"],!1,!1),l=0,T=0,at=[{line:1,column:1}],ae=0,Ct=[],x=0,lt;if("startRule"in N){if(!(N.startRule in o))throw new Error(`Can't start parsing from rule "`+N.startRule+'".');Y=o[N.startRule]}function ir(){return m.substring(T,l)}function ot(){return We(T,l)}function Ns(s,c){throw c=c!==void 0?c:We(T,l),Mt([es(s)],m.substring(T,l),c)}function Xt(s,c){throw c=c!==void 0?c:We(T,l),Qs(s,c)}function O(s,c){return{type:"literal",text:s,ignoreCase:c}}function Se(s,c,d){return{type:"class",parts:s,inverted:c,ignoreCase:d}}function Rs(){return{type:"any"}}function Ls(){return{type:"end"}}function es(s){return{type:"other",description:s}}function ts(s){var c=at[s],d;if(c)return c;for(d=s-1;!at[d];)d--;for(c=at[d],c={line:c.line,column:c.column};d<s;)m.charCodeAt(d)===10?(c.line++,c.column=1):c.column++,d++;return at[s]=c,c}function We(s,c){var d=ts(s),b=ts(c);return{start:{offset:s,line:d.line,column:d.column},end:{offset:c,line:b.line,column:b.column}}}function F(s){l<ae||(l>ae&&(ae=l,Ct=[]),Ct.push(s))}function Qs(s,c){return new v(s,null,null,c)}function Mt(s,c,d){return new v(v.buildMessage(s,c),s,c,d)}function ss(){var s,c,d,b;for(s=l,c=[],d=A();d!==i;)c.push(d),d=A();if(c!==i){if(d=[],b=V(),b!==i)for(;b!==i;)d.push(b),b=V();else d=i;d!==i?(T=s,c=te(d),s=c):(l=s,s=i)}else l=s,s=i;if(s===i){for(s=l,c=[],d=A();d!==i;)c.push(d),d=A();c!==i&&(T=s,c=re()),s=c,s===i&&(s=l,c=Pt(),c!==i&&(T=s,c=re()),s=c)}return s}function V(){var s,c,d,b,E,P;if(s=l,c=Fe(),c!==i?(d=Pt(),d!==i?(T=s,c=we(c),s=c):(l=s,s=i)):(l=s,s=i),s===i){if(s=l,c=Fe(),c!==i)if(d=rs(),d!==i){for(b=[],E=Fe();E!==i;)b.push(E),E=Fe();if(b!==i){for(E=[],P=V();P!==i;)E.push(P),P=V();E!==i?(T=s,c=ie(c,d,b,E),s=c):(l=s,s=i)}else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i&&(s=l,c=Fe(),c!==i?(d=V(),d!==i?(T=s,c=$(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i))if(s=l,c=rs(),c!==i){for(d=[],b=Fe();b!==i;)d.push(b),b=Fe();if(d!==i){for(b=[],E=V();E!==i;)b.push(E),E=V();b!==i?(T=s,c=w(c,d,b),s=c):(l=s,s=i)}else l=s,s=i}else l=s,s=i}return s}function rs(){var s,c,d,b;if(s=l,c=ks(),c!==i){for(d=[],b=A();b!==i;)d.push(b),b=A();d!==i?(T=s,c=Q(c),s=c):(l=s,s=i)}else l=s,s=i;return s===i&&(s=is()),s}function is(){var s,c,d,b,E,P,M;if(s=l,m.charCodeAt(l)===40?(c=J,l++):(c=i,x===0&&F(de)),c!==i){for(d=[],b=A();b!==i;)d.push(b),b=A();if(d!==i){if(b=[],E=V(),E!==i)for(;E!==i;)b.push(E),E=V();else b=i;if(b!==i)if(m.charCodeAt(l)===41?(E=H,l++):(E=i,x===0&&F(k)),E!==i){for(P=[],M=A();M!==i;)P.push(M),M=A();P!==i?(T=s,c=z(b),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i}else l=s,s=i;return s}function ks(){var s,c,d;return s=l,c=At(),c===i&&(c=null),c!==i?(d=js(),d!==i?(T=s,c=U(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,c=At(),c!==i?(d=is(),d!==i?(T=s,c=Le(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,c=At(),c===i&&(c=null),c!==i?(d=Bs(),d!==i?(T=s,c=Ce(c,d),s=c):(l=s,s=i)):(l=s,s=i))),s}function At(){var s,c,d,b,E;if(s=l,c=Tt(),c!==i)if(ft.test(m.charAt(l))?(d=m.charAt(l),l++):(d=i,x===0&&F(ee)),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();b!==i?(T=s,c=Qe(c),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;return s}function Bs(){var s,c,d,b,E,P,M;if(s=l,c=ut(),c===i&&(c=null),c!==i)if(d=as(),d!==i)if(b=ls(),b===i&&(b=null),b!==i)if(E=os(),E===i&&(E=null),E!==i){for(P=[],M=A();M!==i;)P.push(M),M=A();P!==i?(T=s,c=qe(c,d,b,E),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,c=ut(),c===i&&(c=null),c!==i)if(d=Z(),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();b!==i?(T=s,c=bs(c,d),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;if(s===i)if(s=l,c=ut(),c===i&&(c=null),c!==i)if(d=Tt(),d!==i)if(b=Vs(),b===i&&(b=null),b!==i)if(E=os(),E===i&&(E=null),E!==i){for(P=[],M=A();M!==i;)P.push(M),M=A();P!==i?(T=s,c=gt(c,d,b,E),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;else l=s,s=i;else l=s,s=i}return s}function xe(){var s,c,d;return s=l,m.charCodeAt(l)===92?(c=he,l++):(c=i,x===0&&F(fe)),c!==i?(d=je(),d!==i?(T=s,c=Ue(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(m.charCodeAt(l)===46?(s=Rt,l++):(s=i,x===0&&F(R)),s===i&&(Es.test(m.charAt(l))?(s=m.charAt(l),l++):(s=i,x===0&&F(Lt)))),s}function pe(){var s,c,d;if(s=l,c=[],d=xe(),d!==i)for(;d!==i;)c.push(d),d=xe();else c=i;return c!==i&&(T=s,c=pt(c)),s=c,s}function Tt(){var s,c,d;if(s=l,c=[],d=ns(),d!==i)for(;d!==i;)c.push(d),d=ns();else c=i;return c!==i&&(T=s,c=Ss(c)),s=c,s}function ns(){var s,c,d;return s=l,m.charCodeAt(l)===92?(c=he,l++):(c=i,x===0&&F(fe)),c!==i?(d=je(),d!==i?(T=s,c=Ue(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(m.charCodeAt(l)===46?(s=Rt,l++):(s=i,x===0&&F(R)),s===i&&(Ge.test(m.charAt(l))?(s=m.charAt(l),l++):(s=i,x===0&&F(mt)))),s}function as(){var s,c,d,b;if(s=l,m.charCodeAt(l)===34?(c=ye,l++):(c=i,x===0&&F(ve)),c!==i){for(d=[],b=ct();b!==i;)d.push(b),b=ct();d!==i?(m.charCodeAt(l)===34?(b=ye,l++):(b=i,x===0&&F(ve)),b!==i?(T=s,c=Qt(d),s=c):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;return s}function Z(){var s,c,d,b;if(s=l,m.charCodeAt(l)===47?(c=Me,l++):(c=i,x===0&&F(Ke)),c!==i){if(d=[],b=_t(),b!==i)for(;b!==i;)d.push(b),b=_t();else d=i;d!==i?(m.charCodeAt(l)===47?(b=Me,l++):(b=i,x===0&&F(Ke)),b!==i?(T=s,c=xs(d),s=c):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;return s}function ct(){var s,c,d;return s=l,c=l,x++,m.charCodeAt(l)===34?(d=ye,l++):(d=i,x===0&&F(ve)),d===i&&(m.charCodeAt(l)===92?(d=he,l++):(d=i,x===0&&F(fe))),x--,d===i?c=void 0:(l=c,c=i),c!==i?(m.length>l?(d=m.charAt(l),l++):(d=i,x===0&&F(ke)),d!==i?(T=s,c=ge(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,m.charCodeAt(l)===92?(c=he,l++):(c=i,x===0&&F(fe)),c!==i?(d=je(),d!==i?(T=s,c=Ue(d),s=c):(l=s,s=i)):(l=s,s=i)),s}function _t(){var s,c,d;return s=l,c=l,x++,m.charCodeAt(l)===47?(d=Me,l++):(d=i,x===0&&F(Ke)),d===i&&(m.charCodeAt(l)===92?(d=he,l++):(d=i,x===0&&F(fe))),x--,d===i?c=void 0:(l=c,c=i),c!==i?(m.length>l?(d=m.charAt(l),l++):(d=i,x===0&&F(ke)),d!==i?(T=s,c=ge(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,m.charCodeAt(l)===92?(c=he,l++):(c=i,x===0&&F(fe)),c!==i?(d=je(),d!==i?(T=s,c=Ue(d),s=c):(l=s,s=i)):(l=s,s=i)),s}function je(){var s;return m.charCodeAt(l)===43?(s=Ye,l++):(s=i,x===0&&F(ht)),s===i&&(m.charCodeAt(l)===45?(s=Ae,l++):(s=i,x===0&&F(yt)),s===i&&(m.charCodeAt(l)===33?(s=vt,l++):(s=i,x===0&&F(bt)),s===i&&(m.charCodeAt(l)===40?(s=J,l++):(s=i,x===0&&F(de)),s===i&&(m.charCodeAt(l)===41?(s=H,l++):(s=i,x===0&&F(k)),s===i&&(m.charCodeAt(l)===123?(s=L,l++):(s=i,x===0&&F(Je)),s===i&&(m.charCodeAt(l)===125?(s=Ze,l++):(s=i,x===0&&F(Xe)),s===i&&(m.charCodeAt(l)===91?(s=Be,l++):(s=i,x===0&&F(Te)),s===i&&(m.charCodeAt(l)===93?(s=et,l++):(s=i,x===0&&F(q)),s===i&&(m.charCodeAt(l)===94?(s=Et,l++):(s=i,x===0&&F(_e)),s===i&&(m.charCodeAt(l)===34?(s=ye,l++):(s=i,x===0&&F(ve)),s===i&&(m.charCodeAt(l)===63?(s=kt,l++):(s=i,x===0&&F(Bt)),s===i&&(m.charCodeAt(l)===58?(s=Fs,l++):(s=i,x===0&&F($s)),s===i&&(m.charCodeAt(l)===92?(s=he,l++):(s=i,x===0&&F(fe)),s===i&&(m.charCodeAt(l)===38?(s=St,l++):(s=i,x===0&&F(Vt)),s===i&&(m.charCodeAt(l)===124?(s=j,l++):(s=i,x===0&&F(Wt)),s===i&&(m.charCodeAt(l)===39?(s=xt,l++):(s=i,x===0&&F(Is)),s===i&&(m.charCodeAt(l)===47?(s=Me,l++):(s=i,x===0&&F(Ke)),s===i&&(m.charCodeAt(l)===126?(s=tt,l++):(s=i,x===0&&F(st)),s===i&&(m.charCodeAt(l)===42?(s=jt,l++):(s=i,x===0&&F(zt)),s===i&&(m.charCodeAt(l)===32?(s=G,l++):(s=i,x===0&&F(ws)))))))))))))))))))))),s}function ls(){var s,c,d;return s=l,m.charCodeAt(l)===126?(c=tt,l++):(c=i,x===0&&F(st)),c!==i?(d=us(),d!==i?(T=s,c=Cs(d),s=c):(l=s,s=i)):(l=s,s=i),s}function os(){var s,c,d;return s=l,m.charCodeAt(l)===94?(c=Et,l++):(c=i,x===0&&F(_e)),c!==i?(d=Ws(),d!==i?(T=s,c=Ht(d),s=c):(l=s,s=i)):(l=s,s=i),s}function Vs(){var s,c,d;return s=l,m.charCodeAt(l)===126?(c=tt,l++):(c=i,x===0&&F(st)),c!==i?(d=cs(),d===i&&(d=null),d!==i?(T=s,c=qt(d),s=c):(l=s,s=i)):(l=s,s=i),s}function Ws(){var s;return s=cs(),s===i&&(s=us()),s}function cs(){var s,c,d,b;if(s=l,m.substr(l,2)===Ft?(c=Ft,l+=2):(c=i,x===0&&F(Ms)),c!==i){if(d=[],Pe.test(m.charAt(l))?(b=m.charAt(l),l++):(b=i,x===0&&F(le)),b!==i)for(;b!==i;)d.push(b),Pe.test(m.charAt(l))?(b=m.charAt(l),l++):(b=i,x===0&&F(le));else d=i;d!==i?(T=s,c=Ut(d),s=c):(l=s,s=i)}else l=s,s=i;return s}function us(){var s,c,d;if(s=l,c=[],Pe.test(m.charAt(l))?(d=m.charAt(l),l++):(d=i,x===0&&F(le)),d!==i)for(;d!==i;)c.push(d),Pe.test(m.charAt(l))?(d=m.charAt(l),l++):(d=i,x===0&&F(le));else c=i;return c!==i&&(T=s,c=As(c)),s=c,s}function js(){var s,c,d,b,E,P,M,se;if(s=l,m.charCodeAt(l)===91?(c=Be,l++):(c=i,x===0&&F(Te)),c!==i)if(d=pe(),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();if(b!==i)if(m.substr(l,2)===ce?(E=ce,l+=2):(E=i,x===0&&F(rt)),E!==i){if(P=[],M=A(),M!==i)for(;M!==i;)P.push(M),M=A();else P=i;P!==i?(M=pe(),M!==i?(m.charCodeAt(l)===93?(se=et,l++):(se=i,x===0&&F(q)),se!==i?(T=s,c=Ts(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,m.charCodeAt(l)===123?(c=L,l++):(c=i,x===0&&F(Je)),c!==i)if(d=pe(),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();if(b!==i)if(m.substr(l,2)===ce?(E=ce,l+=2):(E=i,x===0&&F(rt)),E!==i){if(P=[],M=A(),M!==i)for(;M!==i;)P.push(M),M=A();else P=i;P!==i?(M=pe(),M!==i?(m.charCodeAt(l)===125?(se=Ze,l++):(se=i,x===0&&F(Xe)),se!==i?(T=s,c=De(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,m.charCodeAt(l)===91?(c=Be,l++):(c=i,x===0&&F(Te)),c!==i)if(d=pe(),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();if(b!==i)if(m.substr(l,2)===ce?(E=ce,l+=2):(E=i,x===0&&F(rt)),E!==i){if(P=[],M=A(),M!==i)for(;M!==i;)P.push(M),M=A();else P=i;P!==i?(M=pe(),M!==i?(m.charCodeAt(l)===125?(se=Ze,l++):(se=i,x===0&&F(Xe)),se!==i?(T=s,c=_(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i)if(s=l,m.charCodeAt(l)===123?(c=L,l++):(c=i,x===0&&F(Je)),c!==i)if(d=pe(),d!==i){for(b=[],E=A();E!==i;)b.push(E),E=A();if(b!==i)if(m.substr(l,2)===ce?(E=ce,l+=2):(E=i,x===0&&F(rt)),E!==i){if(P=[],M=A(),M!==i)for(;M!==i;)P.push(M),M=A();else P=i;P!==i?(M=pe(),M!==i?(m.charCodeAt(l)===93?(se=et,l++):(se=i,x===0&&F(q)),se!==i?(T=s,c=$t(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i}}return s}function Fe(){var s,c,d,b,E;for(s=l,c=[],d=A();d!==i;)c.push(d),d=A();if(c!==i)if(d=Oe(),d!==i){if(b=[],E=A(),E!==i)for(;E!==i;)b.push(E),E=A();else b=i;b!==i?(T=s,c=be(d),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;if(s===i){for(s=l,c=[],d=A();d!==i;)c.push(d),d=A();c!==i?(d=Oe(),d!==i?(b=Pt(),b!==i?(T=s,c=be(d),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}return s}function Oe(){var s;return m.substr(l,6)===It?(s=It,l+=6):(s=i,x===0&&F(Gt)),s===i&&(m.substr(l,7)===Kt?(s=Kt,l+=7):(s=i,x===0&&F(Yt)),s===i&&(m.substr(l,2)===Ve?(s=Ve,l+=2):(s=i,x===0&&F(oe)),s===i&&(m.substr(l,3)===it?(s=it,l+=3):(s=i,x===0&&F(_s)),s===i&&(m.substr(l,3)===Jt?(s=Jt,l+=3):(s=i,x===0&&F(Ps)),s===i&&(m.substr(l,2)===Zt?(s=Zt,l+=2):(s=i,x===0&&F(nt)),s===i&&(m.substr(l,2)===Ee?(s=Ee,l+=2):(s=i,x===0&&F(Ds)))))))),s}function ut(){var s,c,d;for(s=l,c=[],d=A();d!==i;)c.push(d),d=A();return c!==i?(d=zs(),d!==i?(T=s,c=be(d),s=c):(l=s,s=i)):(l=s,s=i),s}function zs(){var s;return m.charCodeAt(l)===43?(s=Ye,l++):(s=i,x===0&&F(ht)),s===i&&(m.charCodeAt(l)===45?(s=Ae,l++):(s=i,x===0&&F(yt)),s===i&&(m.charCodeAt(l)===33?(s=vt,l++):(s=i,x===0&&F(bt)))),s}function A(){var s,c;if(x++,s=[],wt.test(m.charAt(l))?(c=m.charAt(l),l++):(c=i,x===0&&F(ne)),c!==i)for(;c!==i;)s.push(c),wt.test(m.charAt(l))?(c=m.charAt(l),l++):(c=i,x===0&&F(ne));else s=i;return x--,s===i&&(c=i,x===0&&F(Os)),s}function Pt(){var s,c;return s=l,x++,m.length>l?(c=m.charAt(l),l++):(c=i,x===0&&F(ke)),x--,c===i?s=void 0:(l=s,s=i),s}if(lt=Y(),lt!==i&&l===m.length)return lt;throw lt!==i&&l<m.length&&F(Ls()),Mt(Ct,ae<m.length?m.charAt(ae):null,ae<m.length?We(ae,ae+1):We(ae,ae))}Ie.exports={SyntaxError:v,parse:I}},4527:Ie=>{"use strict";var W="<implicit>";Ie.exports=function v(I){if(!I)return"";var m="";return I.start!=null&&(m+=(I.parenthesized?"(":"")+I.start+" "),I.field&&I.field!==W&&(m+=I.field+":"),I.left&&(I.parenthesized&&!I.start&&(m+="("),m+=v(I.left),I.parenthesized&&!I.right&&(m+=")")),I.operator&&(I.left&&(m+=" "),I.operator!==W&&(m+=I.operator)),I.right&&(I.operator&&I.operator!==W&&(m+=" "),m+=v(I.right),I.parenthesized&&(m+=")")),(I.term||I.term===""&&I.quoted)&&(I.prefix&&(m+=I.prefix),I.quoted?(m+='"',m+=I.term,m+='"'):I.regex?(m+="/",m+=I.term,m+="/"):m+=I.term,I.proximity!=null&&(m+="~"+I.proximity),I.boost!=null&&(m+="^"+I.boost)),I.term_min&&(I.inclusive==="both"||I.inclusive==="left"?m+="[":m+="{",m+=I.term_min,m+=" TO ",m+=I.term_max,I.inclusive==="both"||I.inclusive==="right"?m+="]":m+="}"),I.similarity&&(m+="~",I.similarity!==.5&&(m+=I.similarity)),m}}}]);

//# sourceMappingURL=1300.83875f774796632a1422.js.map