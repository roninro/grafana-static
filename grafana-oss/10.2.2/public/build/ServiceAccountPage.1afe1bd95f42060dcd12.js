"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[687],{88770:(me,V,a)=>{a.r(V),a.d(V,{ServiceAccountPageUnconnected:()=>fe,default:()=>Me});var e=a(39953),s=a(89772),I=a(73),h=a(12223),f=a(4919),g=a(32840),i=a(13253),l=a(21308),p=a(57721),C=a(88206),F=a(97125);const w=t=>{const n=F.contextSrv.hasPermissionInMetadata(p.AccessControlAction.ServiceAccountsPermissionsWrite,t.serviceAccount);return e.createElement(C.P,{title:"Permissions",addPermissionTitle:"Add permission",buttonLabel:"Add permission",resource:"serviceaccounts",resourceId:t.serviceAccount.id,canSetPermissions:n})};var H=a(98908),u=a(41407),N=a(48069),M=a(82803),S=a(4171),T=a(27325),c=a(36495),r=a(38637),W=a(85387);const m=({label:t,value:n,inputType:o,disabled:E,onChange:v})=>{const y=(0,e.useRef)(null),[d,k]=(0,e.useState)(n),[L,D]=(0,e.useState)(!1),$=(0,M.wW)(P),ee=`${t}-input`;(0,e.useEffect)(()=>{L&&de()},[L]);const te=()=>{D(!0)},le=()=>{D(!1),k(n||"")},ne=(Q,K)=>{K!==T.G.Invalid&&k(Q.target.value)},ie=(Q,K)=>{K!==T.G.Invalid&&k(Q.target.value)},de=()=>{y?.current?.focus()},ue=()=>{D(!1),v&&v(d)};return e.createElement("tr",null,e.createElement("td",null,e.createElement(c._,{htmlFor:ee},t)),e.createElement("td",{className:"width-25",colSpan:2},!E&&L?e.createElement(r.I,{id:ee,type:o,defaultValue:n,onBlur:ie,onChange:ne,ref:y,width:30}):e.createElement("span",{className:(0,u.cx)({[$.disabled]:E})},n)),e.createElement("td",null,v&&e.createElement(W.p,{closeOnConfirm:!0,confirmText:"Save",onConfirm:ue,onClick:te,onCancel:le,disabled:E},"Edit")))},P=t=>({disabled:(0,u.css)`
      color: ${t.colors.text.secondary};
    `});var z=a(10639),X=a(65741);const b=({label:t,serviceAccount:n,roleOptions:o,onRoleChange:E})=>{const v=`${t}-input`,y=l.Vt.hasPermissionInMetadata(p.AccessControlAction.ServiceAccountsWrite,n);return e.createElement("tr",null,e.createElement("td",null,e.createElement(c._,{htmlFor:v},t)),l.Vt.licensedAccessControlEnabled()?e.createElement("td",{colSpan:3},e.createElement(z.R,{userId:n.id,orgId:n.orgId,basicRole:n.role,onBasicRoleChange:E,roleOptions:o,basicRoleDisabled:!y,disabled:n.isDisabled})):e.createElement(e.Fragment,null,e.createElement("td",null,e.createElement(X.A,{width:24,inputId:v,"aria-label":"Role",value:n.role,disabled:n.isDisabled,onChange:E})),e.createElement("td",{colSpan:2})))};function G({serviceAccount:t,timeZone:n,onChange:o}){const E=(0,M.wW)(j),v=l.Vt.hasPermission(p.AccessControlAction.ServiceAccountsWrite),[y,d]=e.useState([]),k=D=>{o({...t,role:D})},L=D=>{o({...t,name:D})};return e.useEffect(()=>{async function D(){try{if(l.Vt.hasPermission(p.AccessControlAction.ActionRolesList)){let $=await(0,S.ul)(t.orgId);d($)}}catch{console.error("Error loading options for service account")}}l.Vt.licensedAccessControlEnabled()&&D()},[t.orgId]),e.createElement("div",{className:E.section},e.createElement("h3",null,"Information"),e.createElement("table",{className:"filter-table"},e.createElement("tbody",null,e.createElement(m,{label:"Name",value:t.name,onChange:L,disabled:!v||t.isDisabled}),e.createElement(m,{label:"ID",value:t.login,disabled:t.isDisabled}),e.createElement(b,{label:"Roles",serviceAccount:t,onRoleChange:k,roleOptions:y}),e.createElement(m,{label:"Creation date",value:(0,N.dq)(t.createdAt,{timeZone:n}),disabled:t.isDisabled}))))}const j=t=>({section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var O=a(51932),x=a(69865),U=a(12190);const q=({tokens:t,timeZone:n,tokenActionsDisabled:o,onDelete:E})=>{const v=(0,M.l4)(),y=B(v);return e.createElement("table",{className:(0,u.cx)(y.section,"filter-table")},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Expires"),e.createElement("th",null,"Created"),e.createElement("th",null,"Last used at"),e.createElement("th",null),e.createElement("th",null))),e.createElement("tbody",null,t.map(d=>e.createElement("tr",{key:d.id,className:y.tableRow(d.hasExpired||d.isRevoked)},e.createElement("td",null,d.name),e.createElement("td",null,e.createElement(se,{timeZone:n,token:d})),e.createElement("td",null,Y(n,d.created)),e.createElement("td",null,ae(n,d.lastUsedAt)),e.createElement("td",{className:"width-1 text-center"},d.isRevoked&&e.createElement(oe,null)),e.createElement("td",null,e.createElement(O.m,{"aria-label":`Delete service account token ${d.name}`,size:"sm",onConfirm:()=>E(d),disabled:o}))))))};function ae(t,n){return n?(0,N.dq)(n,{timeZone:t}):"Never"}function Y(t,n){return n?(0,N.dq)(n,{timeZone:t}):"No expiration date"}function J(t){const n=Math.ceil(t/86400);return`Expires in ${n>1?`${n} days`:`${n} day`}`}const oe=()=>{const t=(0,M.wW)(B);return e.createElement("span",{className:t.hasExpired},"Revoked",e.createElement("span",{className:t.tooltipContainer},e.createElement(x.u,{content:"This token has been publicly exposed. Please rotate this token"},e.createElement(U.J,{name:"exclamation-triangle",className:t.toolTipIcon}))))},se=({timeZone:t,token:n})=>{const o=(0,M.wW)(B);return n.expiration?n.secondsUntilExpiration?e.createElement("span",{className:o.secondsUntilExpiration},J(n.secondsUntilExpiration)):n.hasExpired?e.createElement("span",{className:o.hasExpired},"Expired",e.createElement("span",{className:o.tooltipContainer},e.createElement(x.u,{content:"This token has expired"},e.createElement(U.J,{name:"exclamation-triangle",className:o.toolTipIcon})))):e.createElement("span",null,Y(t,n.expiration)):e.createElement("span",{className:o.neverExpire},"Never")},B=t=>({tableRow:n=>(0,u.css)`
    color: ${n?t.colors.text.secondary:t.colors.text.primary};
  `,tooltipContainer:(0,u.css)`
    margin-left: ${t.spacing(1)};
  `,toolTipIcon:(0,u.css)`
    color: ${t.colors.error.text};
  `,secondsUntilExpiration:(0,u.css)`
    color: ${t.colors.warning.text};
  `,hasExpired:(0,u.css)`
    color: ${t.colors.error.text};
  `,neverExpire:(0,u.css)`
    color: ${t.colors.text.secondary};
  `,section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var ce=a(21953),A=a(4148),Ee=a(13601),Se=a(26893),_=a(2322);const Z="/api/serviceaccounts";function ve(t){return async n=>{n((0,_.s3)());try{const o=await(0,A.i)().get(`${Z}/${t}`,(0,Se.y)());n((0,_.P4)(o))}catch(o){console.error(o)}finally{n((0,_.LA)())}}}function Te(t){return async n=>{await(0,A.i)().patch(`${Z}/${t.id}?accesscontrol=true`,{...t}),n(ve(t.id))}}function Ae(t){return async()=>{await(0,A.i)().delete(`${Z}/${t}`),Ee.E1.push("/org/serviceaccounts")}}function ye(t,n,o){return async E=>{const v=await(0,A.i)().post(`${Z}/${t}/tokens`,n);o(v.key),E(re(t))}}function he(t,n){return async o=>{await(0,A.i)().delete(`${Z}/${t}/tokens/${n}`),o(re(t))}}function re(t){return async n=>{try{const o=await(0,A.i)().get(`${Z}/${t}/tokens`);n((0,_.e7)(o))}catch(o){console.error(o)}}}function Pe(t){return{serviceAccount:t.serviceAccountProfile.serviceAccount,tokens:t.serviceAccountProfile.tokens,isLoading:t.serviceAccountProfile.isLoading,timezone:(0,I.Z)(t.user)}}const xe={createServiceAccountToken:ye,deleteServiceAccount:Ae,deleteServiceAccountToken:he,loadServiceAccount:ve,loadServiceAccountTokens:re,updateServiceAccount:Te},Ie=(0,s.connect)(Pe,xe),fe=({match:t,serviceAccount:n,tokens:o,timezone:E,isLoading:v,createServiceAccountToken:y,deleteServiceAccount:d,deleteServiceAccountToken:k,loadServiceAccount:L,loadServiceAccountTokens:D,updateServiceAccount:$})=>{const[ee,te]=(0,e.useState)(""),[le,ne]=(0,e.useState)(!1),[ie,de]=(0,e.useState)(!1),[ue,Q]=(0,e.useState)(!1),K=parseInt(t.params.id,10),pe=!l.Vt.hasPermission(p.AccessControlAction.ServiceAccountsWrite)||n.isDisabled,De=l.Vt.hasPermission(p.AccessControlAction.ServiceAccountsWrite),Oe=l.Vt.hasPermissionInMetadata(p.AccessControlAction.ServiceAccountsPermissionsRead,n),Re={text:n.name,img:n.avatarUrl,subTitle:"Manage settings for an individual service account."};(0,e.useEffect)(()=>{L(K),D(K),l.Vt.licensedAccessControlEnabled()&&(0,ce.bX)()},[L,D,K]);const be=R=>{$(R)},ge=R=>()=>{de(R)},Ce=R=>()=>{Q(R)},Le=()=>{d(n.id)},$e=()=>{$({...n,isDisabled:!0}),Q(!1)},Ne=()=>{$({...n,isDisabled:!1})},We=R=>{k(n?.id,R.id)},Ue=R=>{y(n?.id,R,te)},Be=()=>{ne(!1),te("")};return e.createElement(i.T,{navId:"serviceaccounts",pageNav:Re},e.createElement(i.T.Contents,{isLoading:v},e.createElement("div",null,n&&e.createElement(h.Lh,{spacing:"md",height:"auto",justify:"flex-end"},e.createElement(f.zx,{type:"button",variant:"destructive",onClick:ge(!0),disabled:!l.Vt.hasPermission(p.AccessControlAction.ServiceAccountsDelete)},"Delete service account"),n.isDisabled?e.createElement(f.zx,{type:"button",variant:"secondary",onClick:Ne,disabled:!De},"Enable service account"):e.createElement(f.zx,{type:"button",variant:"secondary",onClick:Ce(!0),disabled:!De},"Disable service account")),n&&e.createElement(G,{serviceAccount:n,timeZone:E,onChange:be}),e.createElement(h.Lh,{justify:"space-between",height:"auto"},e.createElement("h3",null,"Tokens"),e.createElement(f.zx,{onClick:()=>ne(!0),disabled:pe},"Add service account token")),o&&e.createElement(q,{tokens:o,timeZone:E,onDelete:We,tokenActionsDisabled:pe}),Oe&&e.createElement(w,{serviceAccount:n})),e.createElement(g.s,{isOpen:ie,title:"Delete service account",body:"Are you sure you want to delete this service account?",confirmText:"Delete service account",onConfirm:Le,onDismiss:ge(!1)}),e.createElement(g.s,{isOpen:ue,title:"Disable service account",body:"Are you sure you want to disable this service account?",confirmText:"Disable service account",onConfirm:$e,onDismiss:Ce(!1)}),e.createElement(H.m,{isOpen:le,token:ee,serviceAccountLogin:n.login,onCreateToken:Ue,onClose:Be})))},Me=Ie(fe)},98908:(me,V,a)=>{a.d(V,{m:()=>u});var e=a(41407),s=a(39953),I=a(34032),h=a(32688),f=a(82803),g=a(73075),i=a(96227),l=a(38637),p=a(20454),C=a(16991),F=a(4919),w=a(36210);const H=[{label:"No expiration",value:!1},{label:"Set expiration date",value:!0}],u=({isOpen:S,token:T,serviceAccountLogin:c,onCreateToken:r,onClose:W})=>{const m=new Date;m.setDate(m.getDate()+1);const P=new Date;h.config.tokenExpirationDayLimit!==void 0&&h.config.tokenExpirationDayLimit>-1?P.setDate(P.getDate()+h.config.tokenExpirationDayLimit+1):P.setDate(864e13);const z=h.config.tokenExpirationDayLimit!==void 0&&h.config.tokenExpirationDayLimit>0,[X,b]=(0,s.useState)(""),[G,j]=(0,s.useState)(""),[O,x]=(0,s.useState)(z),[U,q]=(0,s.useState)(m),[ae,Y]=(0,s.useState)(U!==""),J=(0,f.wW)(M);(0,s.useEffect)(()=>{S&&b(`${c}-${(0,I.Z)()}`)},[c,S]);const oe=A=>{Y(A!==""),q(A)},se=()=>{r({name:G||X,secondsToLive:O?N(U):void 0})},B=()=>{j(""),b(""),x(z),q(m),Y(U!==""),W()},ce=T?"Service account token created":"Add service account token";return s.createElement(g.u,{isOpen:S,title:ce,onDismiss:B,className:J.modal,contentClassName:J.modalContent},T?s.createElement(s.Fragment,null,s.createElement(i.g,{label:"Token",description:"Copy the token now as you will not be able to see it again. Losing a token requires creating a new one."},s.createElement("div",{className:J.modalTokenRow},s.createElement(l.I,{name:"tokenValue",value:T,readOnly:!0}),s.createElement(w.m,{className:J.modalCopyToClipboardButton,variant:"primary",size:"md",icon:"copy",getText:()=>T},"Copy clipboard"))),s.createElement(g.u.ButtonRow,null,s.createElement(w.m,{variant:"primary",getText:()=>T,onClipboardCopy:B},"Copy to clipboard and close"),s.createElement(F.zx,{variant:"secondary",onClick:B},"Close"))):s.createElement("div",null,s.createElement(i.g,{label:"Display name",description:"Name to easily identify the token",required:!0},s.createElement(l.I,{name:"tokenName",value:G,placeholder:X,onChange:A=>{j(A.currentTarget.value)}})),s.createElement(i.g,{label:"Expiration"},s.createElement(p.S,{options:H,value:O,onChange:x,size:"md"})),O&&s.createElement(i.g,{label:"Expiration date"},s.createElement(C.d,{onChange:oe,value:U,placeholder:"",minDate:m,maxDate:P})),s.createElement(g.u.ButtonRow,null,s.createElement(F.zx,{onClick:se,disabled:O&&!ae},"Generate token"))))},N=S=>{const T=new Date(S),c=new Date;return Math.ceil((T.getTime()-c.getTime())/1e3)},M=S=>({modal:(0,e.css)`
      width: 550px;
    `,modalContent:(0,e.css)`
      overflow: visible;
    `,modalTokenRow:(0,e.css)`
      display: flex;
    `,modalCopyToClipboardButton:(0,e.css)`
      margin-left: ${S.spacing(.5)};
    `})},21953:(me,V,a)=>{a.d(V,{R5:()=>M,TL:()=>w,XE:()=>S,Xd:()=>C,bX:()=>p,fT:()=>u,yN:()=>H});var e=a(86832),s=a.n(e),I=a(4148),h=a(4171),f=a(97125),g=a(57721),i=a(2322);const l="/api/serviceaccounts";function p(){return async c=>{try{if(f.contextSrv.licensedAccessControlEnabled()&&f.contextSrv.hasPermission(g.AccessControlAction.ActionRolesList)){const r=await(0,h.ul)();c((0,i.Dn)(r))}}catch(r){console.error(r)}}}function C({withLoadingIndicator:c}={withLoadingIndicator:!1}){return async(r,W)=>{try{if(f.contextSrv.hasPermission(g.AccessControlAction.ServiceAccountsRead)){c&&r((0,i.pN)());const{perPage:m,page:P,query:z,serviceAccountStateFilter:X}=W().serviceAccounts,b=await(0,I.i)().get(`/api/serviceaccounts/search?perpage=${m}&page=${P}&query=${z}${N(X)}&accesscontrol=true`);if(f.contextSrv.licensedAccessControlEnabled()){r((0,i.Fy)());const G=f.contextSrv.user.orgId,j=b?.serviceAccounts.map(x=>x.id),O=await(0,I.i)().post("/api/access-control/users/roles/search",{userIds:j,orgId:G});b.serviceAccounts.forEach(x=>{x.roles=O?O[x.id]||[]:[]}),r((0,i.BR)())}r((0,i.Ub)(b))}}catch(m){console.error(m)}finally{r((0,i.dt)())}}}const F=(0,e.debounce)(c=>c(C()),500,{leading:!0});function w(c){return async r=>{await(0,I.i)().patch(`${l}/${c.id}?accesscontrol=true`,{...c}),r(C())}}function H(c){return async r=>{await(0,I.i)().delete(`${l}/${c}`),r(C())}}function u(c,r,W){return async m=>{const P=await(0,I.i)().post(`${l}/${c}/tokens`,r);W(P.key),m(C())}}const N=c=>{switch(c){case g.ServiceAccountStateFilter.WithExpiredTokens:return"&expiredTokens=true";case g.ServiceAccountStateFilter.Disabled:return"&disabled=true";default:return""}};function M(c){return async r=>{r((0,i.aj)(c)),F(r)}}function S(c){return async r=>{r((0,i.M4)(c)),r(C())}}function T(c){return async r=>{r(pageChanged(c)),r(C())}}}}]);

//# sourceMappingURL=ServiceAccountPage.1afe1bd95f42060dcd12.js.map