"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[413],{27164:(Xe,J,a)=>{a.r(J),a.d(J,{default:()=>Ze});var p=a(41407),W=a(86832),e=a(39953),w=a(72639),ce=a(4148),ue=a(51932),T=a(4919),$=a(12190),j=a(84766),A=a(33155),me=a(94696),de=a(39017),P=a(82803),ge=a(12608),H=a(13253),fe=a(21308),pe=a(83450),y=a(62679),ve=a(57721),he=a(41804),Ee=a(80583),h=a(14058);const Y=(0,e.createContext)(void 0);function ye(t){const[r,o]=(0,e.useState)(0),{pages:l,onSubmit:n,children:i}=t;return e.createElement(Y.Provider,{value:{currentPage:r,CurrentPageComponent:l[r],isLastPage:r===l.length-1,nextPage:()=>o(r+1),prevPage:()=>o(r-1),onSubmit:n}},i)}const k=()=>{const t=(0,e.useContext)(Y);if(!t)throw new Error("useWizardContext must be used within a WizardContextProvider");return t};function Ce(t){const{navigation:r}=t,{handleSubmit:o}=(0,h.Gc)(),{CurrentPageComponent:l,isLastPage:n,nextPage:i,onSubmit:s}=k(),c=r;return e.createElement("form",{onSubmit:o(d=>{n?s(d):i()})},e.createElement(l,null),e.createElement(c,null))}function X(t){const{defaultValues:r,pages:o,onSubmit:l,navigation:n}=t,i=(0,h.cI)({defaultValues:r});return e.createElement(h.RV,{...i},e.createElement(ye,{pages:o,onSubmit:l},e.createElement(Ce,{navigation:n})))}var U=a(65458),M=a(2827),C=a(96227),F=a(38637),be=a(68421);const q=(0,e.createContext)({loading:!1,correlation:void 0,readOnly:!1}),_=t=>{const{data:r,children:o}=t;return e.createElement(q.Provider,{value:r},o)},z=()=>(0,e.useContext)(q),K=(t,r)=>r?`${t}_${r.sourceUID}-${r.uid}`:t,xe=t=>({label:(0,p.css)`
    max-width: ${t.spacing(80)};
  `,description:(0,p.css)`
    max-width: ${t.spacing(80)};
  `}),ee=()=>{const{register:t,formState:r}=(0,h.Gc)(),o=(0,P.wW)(xe),{correlation:l,readOnly:n}=z();return e.createElement(e.Fragment,null,e.createElement(M.C,{label:"Define correlation label (Step 1 of 3)"},e.createElement("p",null,"Define text that will describe the correlation."),e.createElement("input",{type:"hidden",...t("config.type")}),e.createElement(C.g,{label:"Label",description:"This name will be used as the label for the correlation. This will show as button text, a menu item, or hover text on a link.",className:o.label,invalid:!!r.errors.label,error:r.errors.label?.message},e.createElement(F.I,{id:K("label",l),...t("label",{required:{value:!0,message:"This field is required."}}),readOnly:n,placeholder:"e.g. Tempo traces"})),e.createElement(C.g,{label:"Description",description:"Optional description with more information about the link",className:(0,p.cx)(o.description)},e.createElement(be.K,{id:K("description",l),...t("description"),readOnly:n}))))};var x=a(4236),te=a(92811),Ie=a(52436),Se=a(42512),N=a(69733),I=a(27366),De=a(58464),L=a(36495),O=a(69865),we=a(9006),Te=a(9558),$e=a(68497);const Pe=t=>({heading:(0,p.css)`
    font-size: ${t.typography.h5.fontSize};
    font-weight: ${t.typography.fontWeightRegular};
  `,removeButton:(0,p.css)`
    margin-top: 25px;
  `}),Fe=t=>{const{control:r,formState:o,register:l,setValue:n,watch:i,getValues:s}=(0,h.Gc)(),{readOnly:c}=t,[d,b]=(0,e.useState)([]),g=(0,P.wW)(Pe),E=Ne();return e.createElement(e.Fragment,null,e.createElement("input",{type:"hidden",...l("id")}),e.createElement(De.F,{name:"config.transformations",control:r},({fields:D,append:Q,remove:v})=>e.createElement(e.Fragment,null,e.createElement(I.K,{direction:"column",alignItems:"flex-start"},e.createElement("div",{className:g.heading},"Transformations"),D.length===0&&e.createElement("div",null," No transformations defined."),D.length>0&&e.createElement("div",null,D.map((f,u)=>e.createElement(I.K,{direction:"row",key:f.id,alignItems:"top"},e.createElement(C.g,{label:e.createElement(I.K,{gap:.5},e.createElement(L._,{htmlFor:`config.transformations.${f.id}-${u}.type`},"Type"),e.createElement(O.u,{content:e.createElement("div",null,e.createElement("p",null,"The type of transformation that will be applied to the source data."))},e.createElement($.J,{name:"info-circle",size:"sm"}))),invalid:!!o.errors?.config?.transformations?.[u]?.type,error:o.errors?.config?.transformations?.[u]?.type?.message,validationMessageHorizontalOverflow:!0},e.createElement(we.g,{render:({field:{onChange:m,ref:V,...Z}})=>e.createElement(Te.Ph,{...Z,value:f.type,onChange:R=>{if(!c){const se=s().config.transformations[u];let G=(0,W.fill)(Array(u+1),{});d.forEach((Ye,ke)=>G[ke]=Ye),G[u]={expression:se.expression,mapValue:se.mapValue},b(G);const ie=S(R.value);ie.showExpression?n(`config.transformations.${u}.expression`,d[u]?.expression||""):n(`config.transformations.${u}.expression`,""),ie.showMapValue?n(`config.transformations.${u}.mapValue`,d[u]?.mapValue||""):n(`config.transformations.${u}.mapValue`,""),m(R.value)}},options:E,width:25,inputId:`config.transformations.${f.id}-${u}.type`}),control:r,name:`config.transformations.${u}.type`,rules:{required:{value:!0,message:"Please select a transformation type"}}})),e.createElement(C.g,{label:e.createElement(I.K,{gap:.5},e.createElement(L._,{htmlFor:`config.transformations.${f.id}.field`},"Field"),e.createElement(O.u,{content:e.createElement("div",null,e.createElement("p",null,"Optional. The field to transform. If not specified, the transformation will be applied to the results field."))},e.createElement($.J,{name:"info-circle",size:"sm"})))},e.createElement(F.I,{...l(`config.transformations.${u}.field`),readOnly:c,defaultValue:f.field,label:"field",id:`config.transformations.${f.id}.field`})),e.createElement(C.g,{label:e.createElement(I.K,{gap:.5},e.createElement(L._,{htmlFor:`config.transformations.${f.id}.expression`},"Expression",S(i(`config.transformations.${u}.type`)).requireExpression?" *":""),e.createElement(O.u,{content:e.createElement("div",null,e.createElement("p",null,"Required for regular expression. The expression the transformation will use. Logfmt does not use further specifications."))},e.createElement($.J,{name:"info-circle",size:"sm"}))),invalid:!!o.errors?.config?.transformations?.[u]?.expression,error:o.errors?.config?.transformations?.[u]?.expression?.message},e.createElement(F.I,{...l(`config.transformations.${u}.expression`,{required:S(i(`config.transformations.${u}.type`)).requireExpression?"Please define an expression":void 0}),defaultValue:f.expression,readOnly:c,disabled:!S(i(`config.transformations.${u}.type`)).showExpression,id:`config.transformations.${f.id}.expression`})),e.createElement(C.g,{label:e.createElement(I.K,{gap:.5},e.createElement(L._,{htmlFor:`config.transformations.${f.id}.mapValue`},"Map value"),e.createElement(O.u,{content:e.createElement("div",null,e.createElement("p",null,"Optional. Defines the name of the variable. This is currently only valid for regular expressions with a single, unnamed capture group."))},e.createElement($.J,{name:"info-circle",size:"sm"})))},e.createElement(F.I,{...l(`config.transformations.${u}.mapValue`),defaultValue:f.mapValue,readOnly:c,disabled:!S(i(`config.transformations.${u}.type`)).showMapValue,id:`config.transformations.${f.id}.mapValue`})),!c&&e.createElement("div",{className:g.removeButton},e.createElement($e.h,{tooltip:"Remove transformation",name:"trash-alt",onClick:()=>{v(u);const m=[...d];m[u]=void 0,b((0,W.compact)(m))}},"Remove"))))),!c&&e.createElement(T.zx,{icon:"plus",onClick:()=>Q({type:void 0},{shouldFocus:!1}),variant:"secondary",type:"button"},"Add transformation")))))};function S(t){switch(t){case N.sN.Logfmt:return{label:"Logfmt",value:N.sN.Logfmt,description:"Parse provided field with logfmt to get variables",showExpression:!1,showMapValue:!1};case N.sN.Regex:return{label:"Regular expression",value:N.sN.Regex,description:"Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value.",showExpression:!0,showMapValue:!0,requireExpression:!0};default:return{label:t,value:t,showExpression:!1,showMapValue:!1}}}const Ne=()=>Object.values(N.sN).map(t=>{const r=S(t);return{label:r.label,value:r.value,description:r.description}}),Ae=t=>({label:(0,p.css)`
    max-width: ${t.spacing(80)};
  `,variable:(0,p.css)`
    font-family: ${t.typography.fontFamilyMonospace};
    font-weight: ${t.typography.fontWeightMedium};
  `}),re=()=>{const{control:t,formState:r,register:o,getValues:l}=(0,h.Gc)(),n=(0,P.wW)(Ae),i=g=>E=>g(E.uid),{correlation:s,readOnly:c}=z(),d=l("config.target"),b=(0,Se.lt)(d,{}).variables.map(g=>g.variableName+(g.fieldPath?`.${g.fieldPath}`:""));return e.createElement(e.Fragment,null,e.createElement(M.C,{label:`Configure the data source that will link to ${(0,Ie.ak)().getInstanceSettings(s?.targetUID)?.name} (Step 3 of 3)`},e.createElement("p",null,"Define what data source will display the correlation, and what data will replace previously defined variables."),e.createElement(h.Qr,{control:t,name:"sourceUID",rules:{required:{value:!0,message:"This field is required."}},render:({field:{onChange:g,value:E}})=>e.createElement(C.g,{label:"Source",description:"Results from selected source data source have links displayed in the panel",htmlFor:"source",invalid:!!r.errors.sourceUID,error:r.errors.sourceUID?.message},e.createElement(te.q,{onChange:i(g),noDefault:!0,current:E,inputId:"source",width:32,disabled:s!==void 0}))}),e.createElement(C.g,{label:"Results field",description:"The link will be shown next to the value of this field",className:n.label,invalid:!!r.errors?.config?.field,error:r.errors?.config?.field?.message},e.createElement(F.I,{id:K("field",s),...o("config.field",{required:"This field is required."}),readOnly:c})),b.length>0&&e.createElement(x.Z,null,e.createElement(x.Z.Heading,null,"Variables used in the target query"),e.createElement(x.Z.Description,null,"You have used following variables in the target query:"," ",b.map((g,E)=>e.createElement("span",{className:n.variable,key:E},g,E<b.length-1?", ":"")),e.createElement("br",null),"A data point needs to provide values to all variables as fields or as transformations output to make the correlation button appear in the visualization.",e.createElement("br",null),"Note: Not every variable needs to be explicitly defined below. A transformation such as"," ",e.createElement("span",{className:n.variable},"logfmt")," will create variables for every key/value pair.")),e.createElement(Fe,{readOnly:c})))};var ze=a(20653),Le=a(96083),Oe=a(26205);const Ve=({dsUid:t,invalid:r,error:o,name:l})=>{const{value:n,loading:i,error:s}=(0,ze.Z)(async()=>{if(t)return(0,Oe.F)().get(t)},[t]),c=n?.components?.QueryEditor;return e.createElement(C.g,{label:"Query",description:e.createElement("span",null,"Define the query that is run when the link is clicked. You can use"," ",e.createElement("a",{href:"https://grafana.com/docs/grafana/latest/panels-visualizations/configure-data-links/",target:"_blank",rel:"noreferrer"},"variables")," ","to access specific field values."),invalid:r,error:o},e.createElement(h.Qr,{name:l,rules:{validate:{hasQueryEditor:()=>c!==void 0||"The selected target data source must export a query editor."}},render:({field:{value:d,onChange:b}})=>i?e.createElement(j.u,{text:"Loading query editor..."}):s?e.createElement(A.b,{title:"Error loading data source"},"The selected data source could not be loaded."):n?c?e.createElement(e.Fragment,null,e.createElement(c,{onRunQuery:()=>{},app:Le.zj.Correlations,onChange:g=>{b(g)},datasource:n,query:d})):e.createElement(A.b,{title:"Data source does not export a query editor."}):e.createElement(A.b,{title:"No data source selected",severity:"info"},"Please select a target data source first.")}))},ae=()=>{const{control:t,formState:r}=(0,h.Gc)(),o=i=>s=>i(s.uid),{correlation:l}=z(),n=(0,h.qo)({name:"targetUID"})||l?.targetUID;return e.createElement(e.Fragment,null,e.createElement(M.C,{label:"Setup the target for the correlation (Step 2 of 3)"},e.createElement("p",null,"Define what data source the correlation will link to, and what query will run when the correlation is clicked."),e.createElement(h.Qr,{control:t,name:"targetUID",rules:{required:{value:!0,message:"This field is required."}},render:({field:{onChange:i,value:s}})=>e.createElement(C.g,{label:"Target",description:"Specify which data source is queried when the link is clicked",htmlFor:"target",invalid:!!r.errors.targetUID,error:r.errors.targetUID?.message},e.createElement(te.q,{onChange:o(i),noDefault:!0,current:s,inputId:"target",width:32,disabled:l!==void 0}))}),e.createElement(Ve,{name:"config.target",dsUid:n,invalid:!!r.errors?.config?.target,error:r.errors?.config?.target?.message})))};var Re=a(12223);const ne=()=>{const{currentPage:t,prevPage:r,isLastPage:o}=k(),{readOnly:l,loading:n,correlation:i}=z(),s=!l&&e.createElement(T.zx,{variant:"primary",icon:n?"fa fa-spinner":"save",type:"submit",disabled:n},i===void 0?"Add":"Save"),c=e.createElement(T.zx,{variant:"primary",type:"submit"},"Next");return e.createElement(Re.Lh,{justify:"flex-start"},t>0?e.createElement(T.zx,{variant:"secondary",onClick:r},"Back"):void 0,o?s:c)},We=t=>({panelContainer:(0,p.css)`
    position: relative;
    padding: ${t.spacing(1)};
    margin-bottom: ${t.spacing(2)};
  `,infoBox:(0,p.css)`
    margin-top: 20px; // give space for close button
  `}),Ue=({onClose:t,onCreated:r})=>{const o=(0,P.wW)(We),{create:{execute:l,loading:n,error:i,value:s}}=(0,U.K)();(0,e.useEffect)(()=>{!i&&!n&&s&&r()},[i,n,s,r]);const c={config:{type:"query",target:{},field:""}};return e.createElement(he.l,{className:o.panelContainer},e.createElement(Ee.P,{onClick:t}),e.createElement(_,{data:{loading:n,readOnly:!1,correlation:void 0}},e.createElement(X,{defaultValues:c,pages:[ee,ae,re],navigation:ne,onSubmit:l})))},Me=({onUpdated:t,correlation:r,readOnly:o=!1})=>{const{update:{execute:l,loading:n,error:i,value:s}}=(0,U.K)(),c=d=>l({...d,sourceUID:r.sourceUID,uid:r.uid});return(0,e.useEffect)(()=>{!i&&!n&&s&&t()},[i,n,s,t]),e.createElement(_,{data:{loading:n,readOnly:o,correlation:r}},e.createElement(X,{defaultValues:r,pages:[ee,ae,re],onSubmit:o?d=>()=>{}:c,navigation:ne}))};var Ke=a(11906);const Be=({onClick:t,canWriteCorrelations:r})=>r?e.createElement(Ke.Z,{title:"You haven't defined any correlation yet.",buttonIcon:"gf-glue",onClick:t,buttonTitle:"Add correlation",proTip:"you can also define correlations via datasource provisioning"}):e.createElement(x.Z,null,e.createElement(x.Z.Heading,null,"There are no correlations configured yet."),e.createElement(x.Z.Description,null,"Please contact your administrator to create new correlations.")),oe=(t,r,o)=>t.values[o].name.localeCompare(r.values[o].name),B=t=>t.provisioned,Qe=(0,p.css)`
  display: flex;
  justify-content: center;
`;function Ze(){const t=(0,pe.q)("correlations"),[r,o]=(0,e.useState)(!1),l=(0,e.useRef)(1),n=m=>{o(m),m&&(0,w.ff)("grafana_correlations_adding_started")},{remove:i,get:{execute:s,...c}}=(0,U.K)(),d=fe.Vt.hasPermission(ve.AccessControlAction.DataSourcesWrite),b=(0,e.useCallback)(()=>{(0,w.ff)("grafana_correlations_added"),s({page:l.current}),n(!1)},[s]),g=(0,e.useCallback)(()=>{(0,w.ff)("grafana_correlations_edited"),s({page:l.current})},[s]),E=(0,e.useCallback)(async(m,V)=>{await i.execute(m),(0,w.ff)("grafana_correlations_deleted"),V&&l.current--,s({page:l.current})},[i,s]);(0,e.useEffect)(()=>{s({page:l.current})},[s]);const D=(0,e.useCallback)(({row:{index:m,original:{source:{uid:V},provisioned:Z,uid:R}}})=>!Z&&e.createElement(ue.m,{"aria-label":(0,y.t)("correlations.list.delete","delete correlation"),onConfirm:()=>E({sourceUID:V,uid:R},l.current>1&&m===0&&v?.correlations.length===1),closeOnConfirm:!0}),[E]),Q=(0,e.useMemo)(()=>[{id:"info",cell:He,disableGrow:!0,visible:m=>m.some(B)},{id:"source",header:(0,y.t)("correlations.list.source","Source"),cell:le,sortType:oe},{id:"target",header:(0,y.t)("correlations.list.target","Target"),cell:le,sortType:oe},{id:"label",header:(0,y.t)("correlations.list.label","Label"),sortType:"alphanumeric"},{id:"actions",cell:D,disableGrow:!0,visible:m=>d&&m.some((0,W.negate)(B))}],[D,d]),v=(0,e.useMemo)(()=>c.value,[c.value]),f=v?.correlations.length===0&&!r&&!c.error,u=d&&v?.correlations?.length!==0&&v!==void 0&&!r&&e.createElement(T.zx,{icon:"plus",onClick:()=>n(!0)},e.createElement(y.cC,{i18nKey:"correlations.add-new"},"Add new"));return e.createElement(H.T,{navModel:t,subTitle:e.createElement(e.Fragment,null,e.createElement(y.cC,{i18nKey:"correlations.sub-title"},"Define how data living in different data sources relates to each other. Read more in the"," ",e.createElement("a",{href:"https://grafana.com/docs/grafana/next/administration/correlations/",target:"_blank",rel:"noreferrer"},"documentation",e.createElement($.J,{name:"external-link-alt"})))),actions:u},e.createElement(H.T.Contents,null,e.createElement("div",null,!v&&c.loading&&e.createElement("div",{className:Qe},e.createElement(j.u,{text:(0,y.t)("correlations.list.loading","loading...")})),f&&e.createElement(Be,{canWriteCorrelations:d,onClick:()=>n(!0)}),c.error&&e.createElement(A.b,{severity:"error",title:(0,y.t)("correlations.alert.title","Error fetching correlation data"),topSpacing:2},(0,ce.kW)(c.error)&&c.error.data?.message||(0,y.t)("correlations.alert.error-message","An unknown error occurred while fetching correlation data. Please try again.")),r&&e.createElement(Ue,{onClose:()=>n(!1),onCreated:b}),v&&v.correlations.length>=1&&e.createElement(e.Fragment,null,e.createElement(me.e,{renderExpandedRow:m=>e.createElement(Ge,{correlation:m,onUpdated:g,readOnly:B(m)||!d}),columns:Q,data:v.correlations,getRowId:m=>`${m.source.uid}-${m.uid}`}),e.createElement(de.t,{currentPage:l.current,numberOfPages:Math.ceil(v.totalCount/v.limit),onNavigate:m=>{s({page:l.current=m})}})))))}function Ge({correlation:{source:t,target:r,...o},readOnly:l,onUpdated:n}){return(0,e.useEffect)(()=>(0,w.ff)("grafana_correlations_details_expanded"),[]),e.createElement(Me,{correlation:{...o,sourceUID:t.uid,targetUID:r.uid},onUpdated:n,readOnly:l})}const Je=t=>({root:(0,p.css)`
    display: flex;
    align-items: center;
  `,dsLogo:(0,p.css)`
    margin-right: ${t.spacing()};
    height: 16px;
    width: 16px;
  `}),le=(0,e.memo)(function({cell:{value:r}}){const o=(0,P.wW)(Je);return e.createElement("span",{className:o.root},e.createElement("img",{src:r.meta.info.logos.small,alt:"",className:o.dsLogo}),r.name)},({cell:{value:t}},{cell:{value:r}})=>t.type===r.type&&t.name===r.name),je=(0,p.css)`
  white-space: nowrap;
`,He=(0,e.memo)(function({...r}){return r.row.original.provisioned?e.createElement(ge.C,{text:(0,y.t)("correlations.list.read-only","Read only"),color:"purple",className:je}):null},(t,r)=>t.row.original.source.readOnly===r.row.original.source.readOnly)}}]);

//# sourceMappingURL=CorrelationsPage.d8f248e21cadfa0996d9.js.map